<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>KeyToolTest xref</title>
<link type="text/css" rel="stylesheet" href="../stylesheet.css" />
</head>
<body>
<pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_comment"> * Copyright (c) 2005, 2009, Oracle and/or its affiliates. All rights reserved.</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_comment"> * This code is free software; you can redistribute it and/or modify it</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_comment"> * under the terms of the GNU General Public License version 2 only, as</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_comment"> * published by the Free Software Foundation.</em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_comment"> * This code is distributed in the hope that it will be useful, but WITHOUT</em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_comment"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_comment"> * version 2 for more details (a copy is included in the LICENSE file that</em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  <em class="jxr_comment"> * accompanied this code).</em>
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <em class="jxr_comment"> * You should have received a copy of the GNU General Public License version</em>
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <em class="jxr_comment"> * 2 along with this work; if not, write to the Free Software Foundation,</em>
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <em class="jxr_comment"> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</em>
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <em class="jxr_comment"> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</em>
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <em class="jxr_comment"> * or visit www.oracle.com if you need additional information or have any</em>
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  <em class="jxr_comment"> * questions.</em>
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <em class="jxr_comment"> * @summary Testing keytool</em>
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <em class="jxr_comment"> * @author weijun.wang</em>
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <em class="jxr_comment"> * Run through autotest.sh and manualtest.sh</em>
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <em class="jxr_comment"> * Testing non-PKCS11 keystores:</em>
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  <em class="jxr_comment"> *       echo | java -Dfile KeyToolTest</em>
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <em class="jxr_comment"> * Testing NSS PKCS11 keystores:</em>
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <em class="jxr_comment"> *       # testing NSS</em>
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  <em class="jxr_comment"> *       # make sure the NSS db files are in current directory and writable</em>
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <em class="jxr_comment"> *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest</em>
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <em class="jxr_comment"> * Testing Solaris Cryptography Framework PKCS11 keystores:</em>
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <em class="jxr_comment"> *       # make sure you've already run pktool and set test12 as pin</em>
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <em class="jxr_comment"> *       echo | java -Dsolaris KeyToolTest</em>
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <em class="jxr_comment"> * ATTENTION:</em>
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  <em class="jxr_comment"> * Exception in thread "main" java.security.ProviderException: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE</em>
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <em class="jxr_comment"> *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)</em>
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <em class="jxr_comment"> *       ...</em>
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <em class="jxr_comment"> * Caused by: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE</em>
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <em class="jxr_comment"> *       at sun.security.pkcs11.wrapper.PKCS11.C_SignFinal(Native Method)</em>
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <em class="jxr_comment"> *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:391)</em>
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <em class="jxr_comment"> *       ...</em>
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  <em class="jxr_comment"> * been observed. Possibly a Solaris bug</em>
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  <em class="jxr_comment"> * ATTENTION:</em>
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <em class="jxr_comment"> * NSS PKCS11 config file are changed, DSA not supported now.</em>
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> java.security.KeyStore;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> sun.security.tools.KeyTool;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  <strong class="jxr_keyword">import</strong> sun.security.x509.*;
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  <strong class="jxr_keyword">import</strong> java.io.*;
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <strong class="jxr_keyword">import</strong> java.security.KeyPairGenerator;
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <strong class="jxr_keyword">import</strong> java.security.NoSuchAlgorithmException;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <strong class="jxr_keyword">import</strong> java.util.*;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">import</strong> java.security.cert.X509Certificate;
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  <strong class="jxr_keyword">import</strong> sun.security.util.ObjectIdentifier;
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> KeyToolTest {
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  
<a class="jxr_linenumber" name="L70" href="#L70">70</a>      <em class="jxr_comment">// The stdout and stderr outputs after a keytool run</em>
<a class="jxr_linenumber" name="L71" href="#L71">71</a>      String out;
<a class="jxr_linenumber" name="L72" href="#L72">72</a>      String err;
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  
<a class="jxr_linenumber" name="L74" href="#L74">74</a>      <em class="jxr_comment">// the output of println() in KeyTool.run</em>
<a class="jxr_linenumber" name="L75" href="#L75">75</a>      String ex;
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  
<a class="jxr_linenumber" name="L77" href="#L77">77</a>      String lastInput = <span class="jxr_string">""</span>, lastCommand = <span class="jxr_string">""</span>;
<a class="jxr_linenumber" name="L78" href="#L78">78</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> debug =
<a class="jxr_linenumber" name="L79" href="#L79">79</a>          System.getProperty(<span class="jxr_string">"debug"</span>) != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  
<a class="jxr_linenumber" name="L81" href="#L81">81</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String NSS_P11_ARG =
<a class="jxr_linenumber" name="L82" href="#L82">82</a>              <span class="jxr_string">"-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nss -providerClass sun.security.pkcs11.SunPKCS11 -providerArg p11-nss.txt "</span>;
<a class="jxr_linenumber" name="L83" href="#L83">83</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String NSS_SRC_P11_ARG =
<a class="jxr_linenumber" name="L84" href="#L84">84</a>              <span class="jxr_string">"-srckeystore NONE -srcstoretype PKCS11 -srcproviderName SunPKCS11-nss -providerClass sun.security.pkcs11.SunPKCS11 -providerArg p11-nss.txt "</span>;
<a class="jxr_linenumber" name="L85" href="#L85">85</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String NZZ_P11_ARG =
<a class="jxr_linenumber" name="L86" href="#L86">86</a>              <span class="jxr_string">"-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nzz -providerClass sun.security.pkcs11.SunPKCS11 -providerArg p11-nzz.txt "</span>;
<a class="jxr_linenumber" name="L87" href="#L87">87</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String NZZ_SRC_P11_ARG =
<a class="jxr_linenumber" name="L88" href="#L88">88</a>              <span class="jxr_string">"-srckeystore NONE -srcstoretype PKCS11 -srcproviderName SunPKCS11-nzz -providerClass sun.security.pkcs11.SunPKCS11 -providerArg p11-nzz.txt "</span>;
<a class="jxr_linenumber" name="L89" href="#L89">89</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SUN_P11_ARG = <span class="jxr_string">"-keystore NONE -storetype PKCS11 "</span>;
<a class="jxr_linenumber" name="L90" href="#L90">90</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SUN_SRC_P11_ARG = <span class="jxr_string">"-srckeystore NONE -srcstoretype PKCS11 "</span>;
<a class="jxr_linenumber" name="L91" href="#L91">91</a>  
<a class="jxr_linenumber" name="L92" href="#L92">92</a>      String p11Arg, srcP11Arg;
<a class="jxr_linenumber" name="L93" href="#L93">93</a>  
<a class="jxr_linenumber" name="L94" href="#L94">94</a>      <em class="jxr_javadoccomment">/** Creates a new instance of KeyToolTest */</em>
<a class="jxr_linenumber" name="L95" href="#L95">95</a>      KeyToolTest() {
<a class="jxr_linenumber" name="L96" href="#L96">96</a>          <em class="jxr_comment">// so that there is "Warning" and not translated into other language</em>
<a class="jxr_linenumber" name="L97" href="#L97">97</a>          Locale.setDefault(Locale.US);
<a class="jxr_linenumber" name="L98" href="#L98">98</a>      }
<a class="jxr_linenumber" name="L99" href="#L99">99</a>  
<a class="jxr_linenumber" name="L100" href="#L100">100</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L101" href="#L101">101</a> <em class="jxr_javadoccomment">     * Helper, removes a file</em>
<a class="jxr_linenumber" name="L102" href="#L102">102</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L103" href="#L103">103</a>     <strong class="jxr_keyword">void</strong> remove(String filename) {
<a class="jxr_linenumber" name="L104" href="#L104">104</a>         <strong class="jxr_keyword">if</strong> (debug) {
<a class="jxr_linenumber" name="L105" href="#L105">105</a>             System.err.println(<span class="jxr_string">"Removing "</span> + filename);
<a class="jxr_linenumber" name="L106" href="#L106">106</a>         }
<a class="jxr_linenumber" name="L107" href="#L107">107</a>         <strong class="jxr_keyword">new</strong> File(filename).delete();
<a class="jxr_linenumber" name="L108" href="#L108">108</a>         <strong class="jxr_keyword">if</strong> (<strong class="jxr_keyword">new</strong> File(filename).exists()) {
<a class="jxr_linenumber" name="L109" href="#L109">109</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Error deleting "</span> + filename);
<a class="jxr_linenumber" name="L110" href="#L110">110</a>         }
<a class="jxr_linenumber" name="L111" href="#L111">111</a>     }
<a class="jxr_linenumber" name="L112" href="#L112">112</a> 
<a class="jxr_linenumber" name="L113" href="#L113">113</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L114" href="#L114">114</a> <em class="jxr_javadoccomment">     * Run a set of keytool command with given terminal input.</em>
<a class="jxr_linenumber" name="L115" href="#L115">115</a> <em class="jxr_javadoccomment">     * @param input the terminal inputs, the characters typed by human</em>
<a class="jxr_linenumber" name="L116" href="#L116">116</a> <em class="jxr_javadoccomment">     *        if &lt;code&gt;cmd&lt;/code&gt; is running on a terminal</em>
<a class="jxr_linenumber" name="L117" href="#L117">117</a> <em class="jxr_javadoccomment">     * @param cmd the argument of a keytool command line</em>
<a class="jxr_linenumber" name="L118" href="#L118">118</a> <em class="jxr_javadoccomment">     * @throws if keytool goes wrong in some place</em>
<a class="jxr_linenumber" name="L119" href="#L119">119</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L120" href="#L120">120</a>     <strong class="jxr_keyword">void</strong> test(String input, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L121" href="#L121">121</a>         lastInput = input;
<a class="jxr_linenumber" name="L122" href="#L122">122</a>         lastCommand = cmd;
<a class="jxr_linenumber" name="L123" href="#L123">123</a> 
<a class="jxr_linenumber" name="L124" href="#L124">124</a>         <em class="jxr_comment">// "X" is appended so that we can precisely test how input is consumed</em>
<a class="jxr_linenumber" name="L125" href="#L125">125</a>         HumanInputStream in = <strong class="jxr_keyword">new</strong> HumanInputStream(input+<span class="jxr_string">"X"</span>);
<a class="jxr_linenumber" name="L126" href="#L126">126</a>         test(in, cmd);
<a class="jxr_linenumber" name="L127" href="#L127">127</a>         <em class="jxr_comment">// make sure the input string is no more no less</em>
<a class="jxr_linenumber" name="L128" href="#L128">128</a>         <strong class="jxr_keyword">if</strong>(in.read() != 'X' || in.read() != -1)
<a class="jxr_linenumber" name="L129" href="#L129">129</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> Exception(<span class="jxr_string">"Input not consumed exactly"</span>);
<a class="jxr_linenumber" name="L130" href="#L130">130</a>     }
<a class="jxr_linenumber" name="L131" href="#L131">131</a> 
<a class="jxr_linenumber" name="L132" href="#L132">132</a>     <strong class="jxr_keyword">void</strong> test(InputStream in, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L133" href="#L133">133</a> 
<a class="jxr_linenumber" name="L134" href="#L134">134</a>         <em class="jxr_comment">// save the original 3 streams</em>
<a class="jxr_linenumber" name="L135" href="#L135">135</a>         <strong class="jxr_keyword">if</strong> (debug) {
<a class="jxr_linenumber" name="L136" href="#L136">136</a>             System.err.println(cmd);
<a class="jxr_linenumber" name="L137" href="#L137">137</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L138" href="#L138">138</a>             System.err.print(<span class="jxr_string">"."</span>);
<a class="jxr_linenumber" name="L139" href="#L139">139</a>         }
<a class="jxr_linenumber" name="L140" href="#L140">140</a>         PrintStream p1 = System.out;
<a class="jxr_linenumber" name="L141" href="#L141">141</a>         PrintStream p2 = System.err;
<a class="jxr_linenumber" name="L142" href="#L142">142</a>         InputStream i1 = System.in;
<a class="jxr_linenumber" name="L143" href="#L143">143</a> 
<a class="jxr_linenumber" name="L144" href="#L144">144</a>         ByteArrayOutputStream b1 = <strong class="jxr_keyword">new</strong> ByteArrayOutputStream();
<a class="jxr_linenumber" name="L145" href="#L145">145</a>         ByteArrayOutputStream b2 = <strong class="jxr_keyword">new</strong> ByteArrayOutputStream();
<a class="jxr_linenumber" name="L146" href="#L146">146</a> 
<a class="jxr_linenumber" name="L147" href="#L147">147</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L148" href="#L148">148</a>             System.setIn(in);
<a class="jxr_linenumber" name="L149" href="#L149">149</a>             System.setOut(<strong class="jxr_keyword">new</strong> PrintStream(b1));
<a class="jxr_linenumber" name="L150" href="#L150">150</a>             System.setErr(<strong class="jxr_keyword">new</strong> PrintStream(b2));
<a class="jxr_linenumber" name="L151" href="#L151">151</a> 
<a class="jxr_linenumber" name="L152" href="#L152">152</a>             <em class="jxr_comment">// since System.in is overrided, the KeyTool.main() method will</em>
<a class="jxr_linenumber" name="L153" href="#L153">153</a>             <em class="jxr_comment">// never block at user input</em>
<a class="jxr_linenumber" name="L154" href="#L154">154</a> 
<a class="jxr_linenumber" name="L155" href="#L155">155</a>             <em class="jxr_comment">// use -debug so that KeyTool.main() will throw an Exception</em>
<a class="jxr_linenumber" name="L156" href="#L156">156</a>             <em class="jxr_comment">// instead of calling System.exit()</em>
<a class="jxr_linenumber" name="L157" href="#L157">157</a>             KeyTool.main((<span class="jxr_string">"-debug "</span>+cmd).split(<span class="jxr_string">"&#92;&#92;s+"</span>));
<a class="jxr_linenumber" name="L158" href="#L158">158</a>         } <strong class="jxr_keyword">finally</strong> {
<a class="jxr_linenumber" name="L159" href="#L159">159</a>             out = b1.toString();
<a class="jxr_linenumber" name="L160" href="#L160">160</a>             err = b2.toString();
<a class="jxr_linenumber" name="L161" href="#L161">161</a>             ex = out;   <em class="jxr_comment">// now it goes to System.out</em>
<a class="jxr_linenumber" name="L162" href="#L162">162</a>             System.setIn(i1);
<a class="jxr_linenumber" name="L163" href="#L163">163</a>             System.setOut(p1);
<a class="jxr_linenumber" name="L164" href="#L164">164</a>             System.setErr(p2);
<a class="jxr_linenumber" name="L165" href="#L165">165</a>         }
<a class="jxr_linenumber" name="L166" href="#L166">166</a>     }
<a class="jxr_linenumber" name="L167" href="#L167">167</a> 
<a class="jxr_linenumber" name="L168" href="#L168">168</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L169" href="#L169">169</a> <em class="jxr_javadoccomment">     * Call this method if you expect test(input, cmd) should go OK</em>
<a class="jxr_linenumber" name="L170" href="#L170">170</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L171" href="#L171">171</a>     <strong class="jxr_keyword">void</strong> testOK(String input, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L172" href="#L172">172</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L173" href="#L173">173</a>             test(input, cmd);
<a class="jxr_linenumber" name="L174" href="#L174">174</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L175" href="#L175">175</a>             afterFail(input, cmd, <span class="jxr_string">"OK"</span>);
<a class="jxr_linenumber" name="L176" href="#L176">176</a>             <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L177" href="#L177">177</a>         }
<a class="jxr_linenumber" name="L178" href="#L178">178</a>     }
<a class="jxr_linenumber" name="L179" href="#L179">179</a> 
<a class="jxr_linenumber" name="L180" href="#L180">180</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L181" href="#L181">181</a> <em class="jxr_javadoccomment">     * Call this method if you expect test(input, cmd) should fail and throw</em>
<a class="jxr_linenumber" name="L182" href="#L182">182</a> <em class="jxr_javadoccomment">     * an exception</em>
<a class="jxr_linenumber" name="L183" href="#L183">183</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L184" href="#L184">184</a>     <strong class="jxr_keyword">void</strong> testFail(String input, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L185" href="#L185">185</a>         <strong class="jxr_keyword">boolean</strong> ok;
<a class="jxr_linenumber" name="L186" href="#L186">186</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L187" href="#L187">187</a>             test(input, cmd);
<a class="jxr_linenumber" name="L188" href="#L188">188</a>             ok = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L189" href="#L189">189</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L190" href="#L190">190</a>             <strong class="jxr_keyword">if</strong> (e instanceof MissingResourceException) {
<a class="jxr_linenumber" name="L191" href="#L191">191</a>                 ok = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L192" href="#L192">192</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L193" href="#L193">193</a>                 ok = false;
<a class="jxr_linenumber" name="L194" href="#L194">194</a>             }
<a class="jxr_linenumber" name="L195" href="#L195">195</a>         }
<a class="jxr_linenumber" name="L196" href="#L196">196</a>         <strong class="jxr_keyword">if</strong>(ok) {
<a class="jxr_linenumber" name="L197" href="#L197">197</a>             afterFail(input, cmd, <span class="jxr_string">"FAIL"</span>);
<a class="jxr_linenumber" name="L198" href="#L198">198</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException();
<a class="jxr_linenumber" name="L199" href="#L199">199</a>         }
<a class="jxr_linenumber" name="L200" href="#L200">200</a>     }
<a class="jxr_linenumber" name="L201" href="#L201">201</a> 
<a class="jxr_linenumber" name="L202" href="#L202">202</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L203" href="#L203">203</a> <em class="jxr_javadoccomment">     * Call this method if you expect test(input, cmd) should go OK</em>
<a class="jxr_linenumber" name="L204" href="#L204">204</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L205" href="#L205">205</a>     <strong class="jxr_keyword">void</strong> testOK(InputStream is, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L206" href="#L206">206</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L207" href="#L207">207</a>             test(is, cmd);
<a class="jxr_linenumber" name="L208" href="#L208">208</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L209" href="#L209">209</a>             afterFail(<span class="jxr_string">""</span>, cmd, <span class="jxr_string">"OK"</span>);
<a class="jxr_linenumber" name="L210" href="#L210">210</a>             <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L211" href="#L211">211</a>         }
<a class="jxr_linenumber" name="L212" href="#L212">212</a>     }
<a class="jxr_linenumber" name="L213" href="#L213">213</a> 
<a class="jxr_linenumber" name="L214" href="#L214">214</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L215" href="#L215">215</a> <em class="jxr_javadoccomment">     * Call this method if you expect test(input, cmd) should fail and throw</em>
<a class="jxr_linenumber" name="L216" href="#L216">216</a> <em class="jxr_javadoccomment">     * an exception</em>
<a class="jxr_linenumber" name="L217" href="#L217">217</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L218" href="#L218">218</a>     <strong class="jxr_keyword">void</strong> testFail(InputStream is, String cmd) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L219" href="#L219">219</a>         <strong class="jxr_keyword">boolean</strong> ok;
<a class="jxr_linenumber" name="L220" href="#L220">220</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L221" href="#L221">221</a>             test(is, cmd);
<a class="jxr_linenumber" name="L222" href="#L222">222</a>             ok = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L223" href="#L223">223</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L224" href="#L224">224</a>             ok = false;
<a class="jxr_linenumber" name="L225" href="#L225">225</a>         }
<a class="jxr_linenumber" name="L226" href="#L226">226</a>         <strong class="jxr_keyword">if</strong>(ok) {
<a class="jxr_linenumber" name="L227" href="#L227">227</a>             afterFail(<span class="jxr_string">""</span>, cmd, <span class="jxr_string">"FAIL"</span>);
<a class="jxr_linenumber" name="L228" href="#L228">228</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException();
<a class="jxr_linenumber" name="L229" href="#L229">229</a>         }
<a class="jxr_linenumber" name="L230" href="#L230">230</a>     }
<a class="jxr_linenumber" name="L231" href="#L231">231</a> 
<a class="jxr_linenumber" name="L232" href="#L232">232</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L233" href="#L233">233</a> <em class="jxr_javadoccomment">     * Call this method if you just want to run the command and does</em>
<a class="jxr_linenumber" name="L234" href="#L234">234</a> <em class="jxr_javadoccomment">     * not care if it succeeds or fails.</em>
<a class="jxr_linenumber" name="L235" href="#L235">235</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L236" href="#L236">236</a>     <strong class="jxr_keyword">void</strong> testAnyway(String input, String cmd) {
<a class="jxr_linenumber" name="L237" href="#L237">237</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L238" href="#L238">238</a>             test(input, cmd);
<a class="jxr_linenumber" name="L239" href="#L239">239</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L240" href="#L240">240</a>             ;
<a class="jxr_linenumber" name="L241" href="#L241">241</a>         }
<a class="jxr_linenumber" name="L242" href="#L242">242</a>     }
<a class="jxr_linenumber" name="L243" href="#L243">243</a> 
<a class="jxr_linenumber" name="L244" href="#L244">244</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L245" href="#L245">245</a> <em class="jxr_javadoccomment">     * Helper method, print some output after a test does not do as expected</em>
<a class="jxr_linenumber" name="L246" href="#L246">246</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L247" href="#L247">247</a>     <strong class="jxr_keyword">void</strong> afterFail(String input, String cmd, String should) {
<a class="jxr_linenumber" name="L248" href="#L248">248</a>         System.err.println(<span class="jxr_string">"\nTest fails for the command ---\n"</span> +
<a class="jxr_linenumber" name="L249" href="#L249">249</a>                 <span class="jxr_string">"keytool "</span> + cmd + <span class="jxr_string">"\nOr its debug version ---\n"</span> +
<a class="jxr_linenumber" name="L250" href="#L250">250</a>                 <span class="jxr_string">"keytool -debug "</span> + cmd);
<a class="jxr_linenumber" name="L251" href="#L251">251</a> 
<a class="jxr_linenumber" name="L252" href="#L252">252</a>         System.err.println(<span class="jxr_string">"The command result should be "</span> + should +
<a class="jxr_linenumber" name="L253" href="#L253">253</a>                 <span class="jxr_string">", but it's not. Try run the command manually and type"</span> +
<a class="jxr_linenumber" name="L254" href="#L254">254</a>                 <span class="jxr_string">" these input into it: "</span>);
<a class="jxr_linenumber" name="L255" href="#L255">255</a>         <strong class="jxr_keyword">char</strong>[] inputChars = input.toCharArray();
<a class="jxr_linenumber" name="L256" href="#L256">256</a> 
<a class="jxr_linenumber" name="L257" href="#L257">257</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i=0; i&lt;inputChars.length; i++) {
<a class="jxr_linenumber" name="L258" href="#L258">258</a>             <strong class="jxr_keyword">char</strong> ch = inputChars[i];
<a class="jxr_linenumber" name="L259" href="#L259">259</a>             <strong class="jxr_keyword">if</strong> (ch == '\n') System.err.print(<span class="jxr_string">"ENTER "</span>);
<a class="jxr_linenumber" name="L260" href="#L260">260</a>             <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (ch == ' ') System.err.print(<span class="jxr_string">"SPACE "</span>);
<a class="jxr_linenumber" name="L261" href="#L261">261</a>             <strong class="jxr_keyword">else</strong> System.err.print(ch + <span class="jxr_string">" "</span>);
<a class="jxr_linenumber" name="L262" href="#L262">262</a>         }
<a class="jxr_linenumber" name="L263" href="#L263">263</a>         System.err.println(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L264" href="#L264">264</a> 
<a class="jxr_linenumber" name="L265" href="#L265">265</a>         System.err.println(<span class="jxr_string">"ERR is:\n"</span>+err);
<a class="jxr_linenumber" name="L266" href="#L266">266</a>         System.err.println(<span class="jxr_string">"OUT is:\n"</span>+out);
<a class="jxr_linenumber" name="L267" href="#L267">267</a>     }
<a class="jxr_linenumber" name="L268" href="#L268">268</a> 
<a class="jxr_linenumber" name="L269" href="#L269">269</a>     <strong class="jxr_keyword">void</strong> assertTrue(<strong class="jxr_keyword">boolean</strong> bool, String msg) {
<a class="jxr_linenumber" name="L270" href="#L270">270</a>         <strong class="jxr_keyword">if</strong> (debug) {
<a class="jxr_linenumber" name="L271" href="#L271">271</a>             System.err.println(<span class="jxr_string">"If not "</span> + bool + <span class="jxr_string">", "</span> + msg);
<a class="jxr_linenumber" name="L272" href="#L272">272</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L273" href="#L273">273</a>             System.err.print(<span class="jxr_string">"v"</span>);
<a class="jxr_linenumber" name="L274" href="#L274">274</a>         }
<a class="jxr_linenumber" name="L275" href="#L275">275</a>         <strong class="jxr_keyword">if</strong>(!bool) {
<a class="jxr_linenumber" name="L276" href="#L276">276</a>             afterFail(lastInput, lastCommand, <span class="jxr_string">"TRUE"</span>);
<a class="jxr_linenumber" name="L277" href="#L277">277</a>                 System.err.println(msg);
<a class="jxr_linenumber" name="L278" href="#L278">278</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(msg);
<a class="jxr_linenumber" name="L279" href="#L279">279</a>         }
<a class="jxr_linenumber" name="L280" href="#L280">280</a>     }
<a class="jxr_linenumber" name="L281" href="#L281">281</a> 
<a class="jxr_linenumber" name="L282" href="#L282">282</a>     <strong class="jxr_keyword">void</strong> assertTrue(<strong class="jxr_keyword">boolean</strong> bool) {
<a class="jxr_linenumber" name="L283" href="#L283">283</a>         assertTrue(bool, <span class="jxr_string">"well..."</span>);
<a class="jxr_linenumber" name="L284" href="#L284">284</a>     }
<a class="jxr_linenumber" name="L285" href="#L285">285</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L286" href="#L286">286</a> <em class="jxr_javadoccomment">     * Helper method, load a keystore</em>
<a class="jxr_linenumber" name="L287" href="#L287">287</a> <em class="jxr_javadoccomment">     * @param file file for keystore, null or "NONE" for PKCS11</em>
<a class="jxr_linenumber" name="L288" href="#L288">288</a> <em class="jxr_javadoccomment">     * @pass password for the keystore</em>
<a class="jxr_linenumber" name="L289" href="#L289">289</a> <em class="jxr_javadoccomment">     * @type keystore type</em>
<a class="jxr_linenumber" name="L290" href="#L290">290</a> <em class="jxr_javadoccomment">     * @returns the KeyStore object</em>
<a class="jxr_linenumber" name="L291" href="#L291">291</a> <em class="jxr_javadoccomment">     * @exception Exception if anything goes wrong</em>
<a class="jxr_linenumber" name="L292" href="#L292">292</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L293" href="#L293">293</a>     KeyStore loadStore(String file, String pass, String type) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L294" href="#L294">294</a>         KeyStore ks = KeyStore.getInstance(type);
<a class="jxr_linenumber" name="L295" href="#L295">295</a>         FileInputStream is = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L296" href="#L296">296</a>         <strong class="jxr_keyword">if</strong> (file != <strong class="jxr_keyword">null</strong> &amp;&amp; !file.equals(<span class="jxr_string">"NONE"</span>)) {
<a class="jxr_linenumber" name="L297" href="#L297">297</a>             is = <strong class="jxr_keyword">new</strong> FileInputStream(file);
<a class="jxr_linenumber" name="L298" href="#L298">298</a>         }
<a class="jxr_linenumber" name="L299" href="#L299">299</a>         ks.load(is, pass.toCharArray());
<a class="jxr_linenumber" name="L300" href="#L300">300</a>         is.close();
<a class="jxr_linenumber" name="L301" href="#L301">301</a>         <strong class="jxr_keyword">return</strong> ks;
<a class="jxr_linenumber" name="L302" href="#L302">302</a>     }
<a class="jxr_linenumber" name="L303" href="#L303">303</a> 
<a class="jxr_linenumber" name="L304" href="#L304">304</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L305" href="#L305">305</a> <em class="jxr_javadoccomment">     * The test suite.</em>
<a class="jxr_linenumber" name="L306" href="#L306">306</a> <em class="jxr_javadoccomment">     * Maybe it's better to put this outside the KeyToolTest class</em>
<a class="jxr_linenumber" name="L307" href="#L307">307</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L308" href="#L308">308</a>     <strong class="jxr_keyword">void</strong> testAll() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L309" href="#L309">309</a>         KeyStore ks;
<a class="jxr_linenumber" name="L310" href="#L310">310</a> 
<a class="jxr_linenumber" name="L311" href="#L311">311</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L312" href="#L312">312</a>         remove(<span class="jxr_string">"x.jceks"</span>);
<a class="jxr_linenumber" name="L313" href="#L313">313</a>         remove(<span class="jxr_string">"x.p12"</span>);
<a class="jxr_linenumber" name="L314" href="#L314">314</a>         remove(<span class="jxr_string">"x2.jceks"</span>);
<a class="jxr_linenumber" name="L315" href="#L315">315</a>         remove(<span class="jxr_string">"x2.jks"</span>);
<a class="jxr_linenumber" name="L316" href="#L316">316</a>         remove(<span class="jxr_string">"x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L317" href="#L317">317</a> 
<a class="jxr_linenumber" name="L318" href="#L318">318</a>         <em class="jxr_comment">// name changes: genkeypair, importcert, exportcert</em>
<a class="jxr_linenumber" name="L319" href="#L319">319</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L320" href="#L320">320</a>         remove(<span class="jxr_string">"x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L321" href="#L321">321</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L322" href="#L322">322</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -alias p1 -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L323" href="#L323">323</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L324" href="#L324">324</a>         assertTrue(ks.getKey(<span class="jxr_string">"p1"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()) != <strong class="jxr_keyword">null</strong>,
<a class="jxr_linenumber" name="L325" href="#L325">325</a>             <span class="jxr_string">"key not DSA"</span>);
<a class="jxr_linenumber" name="L326" href="#L326">326</a>         assertTrue(<strong class="jxr_keyword">new</strong> File(<span class="jxr_string">"x.jks.p1.cert"</span>).exists(), <span class="jxr_string">"p1 export err"</span>);
<a class="jxr_linenumber" name="L327" href="#L327">327</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias p1"</span>);
<a class="jxr_linenumber" name="L328" href="#L328">328</a>         testOK(<span class="jxr_string">"y\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -alias c1 -file x.jks.p1.cert"</span>);  <em class="jxr_comment">// importcert, prompt for Yes/No</em>
<a class="jxr_linenumber" name="L329" href="#L329">329</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -alias c2 -file x.jks.p1.cert -noprompt"</span>); <em class="jxr_comment">// importcert, -noprompt</em>
<a class="jxr_linenumber" name="L330" href="#L330">330</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L331" href="#L331">331</a>         assertTrue(ks.getCertificate(<span class="jxr_string">"c1"</span>) != <strong class="jxr_keyword">null</strong>, <span class="jxr_string">"import c1 err"</span>);
<a class="jxr_linenumber" name="L332" href="#L332">332</a> 
<a class="jxr_linenumber" name="L333" href="#L333">333</a>         <em class="jxr_comment">// v3</em>
<a class="jxr_linenumber" name="L334" href="#L334">334</a>         byte[] encoded = ks.getCertificate(<span class="jxr_string">"c1"</span>).getEncoded();
<a class="jxr_linenumber" name="L335" href="#L335">335</a>         X509CertImpl certImpl = <strong class="jxr_keyword">new</strong> X509CertImpl(encoded);
<a class="jxr_linenumber" name="L336" href="#L336">336</a>         assertTrue(certImpl.getVersion() == 3, <span class="jxr_string">"Version is not 3"</span>);
<a class="jxr_linenumber" name="L337" href="#L337">337</a> 
<a class="jxr_linenumber" name="L338" href="#L338">338</a>         <em class="jxr_comment">// changealias and keyclone</em>
<a class="jxr_linenumber" name="L339" href="#L339">339</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L340" href="#L340">340</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jks -changealias -alias p1 -destalias p11"</span>);
<a class="jxr_linenumber" name="L341" href="#L341">341</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jks -changealias -alias c1 -destalias c11"</span>);
<a class="jxr_linenumber" name="L342" href="#L342">342</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jks -keyclone -alias p11 -destalias p111"</span>); <em class="jxr_comment">// press ENTER when prompt for p111's keypass</em>
<a class="jxr_linenumber" name="L343" href="#L343">343</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L344" href="#L344">344</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"p1"</span>), <span class="jxr_string">"there is no p1"</span>);
<a class="jxr_linenumber" name="L345" href="#L345">345</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"c1"</span>), <span class="jxr_string">"there is no c1"</span>);
<a class="jxr_linenumber" name="L346" href="#L346">346</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"p11"</span>), <span class="jxr_string">"there is p11"</span>);
<a class="jxr_linenumber" name="L347" href="#L347">347</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"c11"</span>), <span class="jxr_string">"there is c11"</span>);
<a class="jxr_linenumber" name="L348" href="#L348">348</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"p111"</span>), <span class="jxr_string">"there is p111"</span>);
<a class="jxr_linenumber" name="L349" href="#L349">349</a> 
<a class="jxr_linenumber" name="L350" href="#L350">350</a>         <em class="jxr_comment">// genSecKey</em>
<a class="jxr_linenumber" name="L351" href="#L351">351</a>         remove(<span class="jxr_string">"x.jceks"</span>);
<a class="jxr_linenumber" name="L352" href="#L352">352</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -alias s1"</span>); <em class="jxr_comment">// DES, no need keysize</em>
<a class="jxr_linenumber" name="L353" href="#L353">353</a>         testFail(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -alias s11 -keysize 128"</span>); <em class="jxr_comment">// DES, keysize cannot be 128</em>
<a class="jxr_linenumber" name="L354" href="#L354">354</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -keyalg DESede -alias s2"</span>); <em class="jxr_comment">// DESede. no need keysize</em>
<a class="jxr_linenumber" name="L355" href="#L355">355</a>         testFail(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype AES -genseckey -keyalg Rijndael -alias s3"</span>); <em class="jxr_comment">// AES, need keysize</em>
<a class="jxr_linenumber" name="L356" href="#L356">356</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -keyalg AES -alias s3 -keysize 128"</span>);
<a class="jxr_linenumber" name="L357" href="#L357">357</a>                 <em class="jxr_comment">// about keypass</em>
<a class="jxr_linenumber" name="L358" href="#L358">358</a>         testOK(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -genseckey -alias s4"</span>); <em class="jxr_comment">// can accept storepass</em>
<a class="jxr_linenumber" name="L359" href="#L359">359</a>         testOK(<span class="jxr_string">"keypass\nkeypass\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -genseckey -alias s5"</span>); <em class="jxr_comment">// or a new one</em>
<a class="jxr_linenumber" name="L360" href="#L360">360</a>         testOK(<span class="jxr_string">"bad\n\bad\nkeypass\nkeypass\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -genseckey -alias s6"</span>); <em class="jxr_comment">// keypass must be valid (prompt 3 times)</em>
<a class="jxr_linenumber" name="L361" href="#L361">361</a>         testFail(<span class="jxr_string">"bad\n\bad\nbad\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -genseckey -alias s7"</span>); <em class="jxr_comment">// keypass must be valid (prompt 3 times)</em>
<a class="jxr_linenumber" name="L362" href="#L362">362</a>         testFail(<span class="jxr_string">"bad\n\bad\nbad\nkeypass\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -genseckey -alias s7"</span>); <em class="jxr_comment">// keypass must be valid (prompt 3 times)</em>
<a class="jxr_linenumber" name="L363" href="#L363">363</a>         ks = loadStore(<span class="jxr_string">"x.jceks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JCEKS"</span>);
<a class="jxr_linenumber" name="L364" href="#L364">364</a>         assertTrue(ks.getKey(<span class="jxr_string">"s1"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"DES"</span>), <span class="jxr_string">"s1 is DES"</span>);
<a class="jxr_linenumber" name="L365" href="#L365">365</a>         assertTrue(ks.getKey(<span class="jxr_string">"s1"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getEncoded().length == 8,  <span class="jxr_string">"DES is 56"</span>);
<a class="jxr_linenumber" name="L366" href="#L366">366</a>         assertTrue(ks.getKey(<span class="jxr_string">"s2"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getEncoded().length == 24,  <span class="jxr_string">"DESede is 168"</span>);
<a class="jxr_linenumber" name="L367" href="#L367">367</a>         assertTrue(ks.getKey(<span class="jxr_string">"s2"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"DESede"</span>), <span class="jxr_string">"s2 is DESede"</span>);
<a class="jxr_linenumber" name="L368" href="#L368">368</a>         assertTrue(ks.getKey(<span class="jxr_string">"s3"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"AES"</span>), <span class="jxr_string">"s3 is AES"</span>);
<a class="jxr_linenumber" name="L369" href="#L369">369</a>         assertTrue(ks.getKey(<span class="jxr_string">"s4"</span>, <span class="jxr_string">"changeit"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"DES"</span>), <span class="jxr_string">"s4 is DES"</span>);
<a class="jxr_linenumber" name="L370" href="#L370">370</a>         assertTrue(ks.getKey(<span class="jxr_string">"s5"</span>, <span class="jxr_string">"keypass"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"DES"</span>), <span class="jxr_string">"s5 is DES"</span>);
<a class="jxr_linenumber" name="L371" href="#L371">371</a>         assertTrue(ks.getKey(<span class="jxr_string">"s6"</span>, <span class="jxr_string">"keypass"</span>.toCharArray()).getAlgorithm().equalsIgnoreCase(<span class="jxr_string">"DES"</span>), <span class="jxr_string">"s6 is DES"</span>);
<a class="jxr_linenumber" name="L372" href="#L372">372</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"s7"</span>), <span class="jxr_string">"s7 not created"</span>);
<a class="jxr_linenumber" name="L373" href="#L373">373</a> 
<a class="jxr_linenumber" name="L374" href="#L374">374</a>         <em class="jxr_comment">// maybe we needn't test this, one day JKS will support SecretKey</em>
<a class="jxr_linenumber" name="L375" href="#L375">375</a>         <em class="jxr_comment">//testFail("changeit\nchangeit\n", "-keystore x.jks -genseckey -keyalg AES -alias s3 -keysize 128");</em>
<a class="jxr_linenumber" name="L376" href="#L376">376</a> 
<a class="jxr_linenumber" name="L377" href="#L377">377</a>         <em class="jxr_comment">// importKeyStore</em>
<a class="jxr_linenumber" name="L378" href="#L378">378</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L379" href="#L379">379</a>         remove(<span class="jxr_string">"x.jceks"</span>);
<a class="jxr_linenumber" name="L380" href="#L380">380</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genkeypair -alias p1 -dname CN=Olala"</span>); <em class="jxr_comment">// create 2 entries...</em>
<a class="jxr_linenumber" name="L381" href="#L381">381</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -storepass changeit -importcert -alias c1 -file x.jks.p1.cert -noprompt"</span>); <em class="jxr_comment">// ...</em>
<a class="jxr_linenumber" name="L382" href="#L382">382</a>         ks = loadStore(<span class="jxr_string">"x.jceks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JCEKS"</span>);
<a class="jxr_linenumber" name="L383" href="#L383">383</a>         assertTrue(ks.size() == 2, <span class="jxr_string">"2 entries in JCEKS"</span>);
<a class="jxr_linenumber" name="L384" href="#L384">384</a>         <em class="jxr_comment">// import, shouldn't mention destalias/srckeypass/destkeypass if srcalias is no given</em>
<a class="jxr_linenumber" name="L385" href="#L385">385</a>         testFail(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -destalias pp"</span>);
<a class="jxr_linenumber" name="L386" href="#L386">386</a>         testFail(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srckeypass changeit"</span>);
<a class="jxr_linenumber" name="L387" href="#L387">387</a>         testFail(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -destkeypass changeit"</span>);
<a class="jxr_linenumber" name="L388" href="#L388">388</a>         <em class="jxr_comment">// normal import</em>
<a class="jxr_linenumber" name="L389" href="#L389">389</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS"</span>);
<a class="jxr_linenumber" name="L390" href="#L390">390</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L391" href="#L391">391</a>         assertTrue(ks.size() == 2, <span class="jxr_string">"2 entries in JKS"</span>);
<a class="jxr_linenumber" name="L392" href="#L392">392</a>         <em class="jxr_comment">// import again, type yes to overwrite old entries</em>
<a class="jxr_linenumber" name="L393" href="#L393">393</a>         testOK(<span class="jxr_string">"changeit\nchangeit\ny\ny\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS"</span>);
<a class="jxr_linenumber" name="L394" href="#L394">394</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L395" href="#L395">395</a>         <em class="jxr_comment">// import again, specify -nopromt</em>
<a class="jxr_linenumber" name="L396" href="#L396">396</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -noprompt"</span>);
<a class="jxr_linenumber" name="L397" href="#L397">397</a>         assertTrue(err.indexOf(<span class="jxr_string">"Warning"</span>) != -1, <span class="jxr_string">"noprompt will warn"</span>);
<a class="jxr_linenumber" name="L398" href="#L398">398</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L399" href="#L399">399</a>         assertTrue(ks.size() == 2, <span class="jxr_string">"2 entries in JKS"</span>);
<a class="jxr_linenumber" name="L400" href="#L400">400</a>         <em class="jxr_comment">// import again, type into new aliases when prompted</em>
<a class="jxr_linenumber" name="L401" href="#L401">401</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n\ns1\n\ns2\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS"</span>);
<a class="jxr_linenumber" name="L402" href="#L402">402</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L403" href="#L403">403</a>         assertTrue(ks.size() == 4, <span class="jxr_string">"4 entries in JKS"</span>);
<a class="jxr_linenumber" name="L404" href="#L404">404</a> 
<a class="jxr_linenumber" name="L405" href="#L405">405</a>         <em class="jxr_comment">// importkeystore single</em>
<a class="jxr_linenumber" name="L406" href="#L406">406</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L407" href="#L407">407</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p1"</span>); <em class="jxr_comment">// normal</em>
<a class="jxr_linenumber" name="L408" href="#L408">408</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L409" href="#L409">409</a>         assertTrue(ks.size() == 1, <span class="jxr_string">"1 entries in JKS"</span>);
<a class="jxr_linenumber" name="L410" href="#L410">410</a>         testOK(<span class="jxr_string">"changeit\nchangeit\ny\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p1"</span>); <em class="jxr_comment">// overwrite</em>
<a class="jxr_linenumber" name="L411" href="#L411">411</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L412" href="#L412">412</a>         assertTrue(ks.size() == 1, <span class="jxr_string">"1 entries in JKS"</span>);
<a class="jxr_linenumber" name="L413" href="#L413">413</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p1 -noprompt"</span>); <em class="jxr_comment">// noprompt</em>
<a class="jxr_linenumber" name="L414" href="#L414">414</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L415" href="#L415">415</a>         assertTrue(ks.size() == 1, <span class="jxr_string">"1 entries in JKS"</span>);
<a class="jxr_linenumber" name="L416" href="#L416">416</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p1 -destalias p2"</span>); <em class="jxr_comment">// rename</em>
<a class="jxr_linenumber" name="L417" href="#L417">417</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L418" href="#L418">418</a>         assertTrue(ks.size() == 2, <span class="jxr_string">"2 entries in JKS"</span>);
<a class="jxr_linenumber" name="L419" href="#L419">419</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n\nnewalias\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p1"</span>); <em class="jxr_comment">// another rename</em>
<a class="jxr_linenumber" name="L420" href="#L420">420</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L421" href="#L421">421</a>         assertTrue(ks.size() == 3, <span class="jxr_string">"3 entries in JKS"</span>);
<a class="jxr_linenumber" name="L422" href="#L422">422</a> 
<a class="jxr_linenumber" name="L423" href="#L423">423</a>         <em class="jxr_comment">// importkeystore single, different keypass</em>
<a class="jxr_linenumber" name="L424" href="#L424">424</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L425" href="#L425">425</a>         testOK(<span class="jxr_string">"changeit\nkeypass\nkeypass\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genkeypair -alias p2 -dname CN=Olala"</span>); <em class="jxr_comment">// generate entry with different keypass</em>
<a class="jxr_linenumber" name="L426" href="#L426">426</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nchangeit\nkeypass\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p2"</span>); <em class="jxr_comment">// prompt</em>
<a class="jxr_linenumber" name="L427" href="#L427">427</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L428" href="#L428">428</a>         assertTrue(ks.size() == 1, <span class="jxr_string">"1 entries in JKS"</span>);
<a class="jxr_linenumber" name="L429" href="#L429">429</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nkeypass\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias p2 -destalias p3 -destkeypass keypass2"</span>); <em class="jxr_comment">// diff destkeypass</em>
<a class="jxr_linenumber" name="L430" href="#L430">430</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L431" href="#L431">431</a>         assertTrue(ks.size() == 2, <span class="jxr_string">"2 entries in JKS"</span>);
<a class="jxr_linenumber" name="L432" href="#L432">432</a>         assertTrue(ks.getKey(<span class="jxr_string">"p2"</span>, <span class="jxr_string">"keypass"</span>.toCharArray()) != <strong class="jxr_keyword">null</strong>, <span class="jxr_string">"p2 has old password"</span>);
<a class="jxr_linenumber" name="L433" href="#L433">433</a>         assertTrue(ks.getKey(<span class="jxr_string">"p3"</span>, <span class="jxr_string">"keypass2"</span>.toCharArray()) != <strong class="jxr_keyword">null</strong>, <span class="jxr_string">"p3 has new password"</span>);
<a class="jxr_linenumber" name="L434" href="#L434">434</a> 
<a class="jxr_linenumber" name="L435" href="#L435">435</a>         <em class="jxr_comment">// importkeystore single, cert</em>
<a class="jxr_linenumber" name="L436" href="#L436">436</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L437" href="#L437">437</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias c1"</span>); <em class="jxr_comment">// normal</em>
<a class="jxr_linenumber" name="L438" href="#L438">438</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias c1 -destalias c2"</span>);   <em class="jxr_comment">// in fact srcstorepass can be ignored</em>
<a class="jxr_linenumber" name="L439" href="#L439">439</a>         assertTrue(err.indexOf(<span class="jxr_string">"WARNING"</span>) != -1, <span class="jxr_string">"But will warn"</span>);
<a class="jxr_linenumber" name="L440" href="#L440">440</a>         testOK(<span class="jxr_string">"changeit\n\ny\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias c1 -destalias c2"</span>);   <em class="jxr_comment">// 2nd import, press y to overwrite ...</em>
<a class="jxr_linenumber" name="L441" href="#L441">441</a>         testOK(<span class="jxr_string">"changeit\n\n\nc3\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias c1 -destalias c2"</span>);   <em class="jxr_comment">// ... or rename</em>
<a class="jxr_linenumber" name="L442" href="#L442">442</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L443" href="#L443">443</a>         assertTrue(ks.size() == 3, <span class="jxr_string">"3 entries in JKS"</span>); <em class="jxr_comment">// c1, c2, c3</em>
<a class="jxr_linenumber" name="L444" href="#L444">444</a> 
<a class="jxr_linenumber" name="L445" href="#L445">445</a>         <em class="jxr_comment">// importkeystore, secretkey</em>
<a class="jxr_linenumber" name="L446" href="#L446">446</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L447" href="#L447">447</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -alias s1"</span>); <em class="jxr_comment">// create SecretKeyEntry</em>
<a class="jxr_linenumber" name="L448" href="#L448">448</a>         testOK(<span class="jxr_string">"changeit\n\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -genseckey -alias s2"</span>); <em class="jxr_comment">// create SecretKeyEntry</em>
<a class="jxr_linenumber" name="L449" href="#L449">449</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jceks -storetype JCEKS -delete -alias p2"</span>); <em class="jxr_comment">// remove the keypass!=storepass one</em>
<a class="jxr_linenumber" name="L450" href="#L450">450</a>         ks = loadStore(<span class="jxr_string">"x.jceks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JCEKS"</span>);
<a class="jxr_linenumber" name="L451" href="#L451">451</a>         assertTrue(ks.size() == 4, <span class="jxr_string">"4 entries in JCEKS"</span>);       <em class="jxr_comment">// p1, c1, s1, s2</em>
<a class="jxr_linenumber" name="L452" href="#L452">452</a>         testOK(<span class="jxr_string">"changeit\nchangeit\nchangeit\n"</span>, <span class="jxr_string">"-importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS -srcalias s1"</span>); <em class="jxr_comment">// normal</em>
<a class="jxr_linenumber" name="L453" href="#L453">453</a>         assertTrue(err.indexOf(<span class="jxr_string">"not imported"</span>) != -1, <span class="jxr_string">"Not imported"</span>);
<a class="jxr_linenumber" name="L454" href="#L454">454</a>         assertTrue(err.indexOf(<span class="jxr_string">"Cannot store non-PrivateKeys"</span>) != -1, <span class="jxr_string">"Not imported"</span>);
<a class="jxr_linenumber" name="L455" href="#L455">455</a> 
<a class="jxr_linenumber" name="L456" href="#L456">456</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L457" href="#L457">457</a>         testOK(<span class="jxr_string">"\n\n"</span>, <span class="jxr_string">"-srcstorepass changeit -deststorepass changeit -importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS"</span>); <em class="jxr_comment">// normal</em>
<a class="jxr_linenumber" name="L458" href="#L458">458</a>         assertTrue(err.indexOf(<span class="jxr_string">"s1 not"</span>) != -1, <span class="jxr_string">"s1 not"</span>);
<a class="jxr_linenumber" name="L459" href="#L459">459</a>         assertTrue(err.indexOf(<span class="jxr_string">"s2 not"</span>) != -1, <span class="jxr_string">"s2 not"</span>);
<a class="jxr_linenumber" name="L460" href="#L460">460</a>         assertTrue(err.indexOf(<span class="jxr_string">"c1 success"</span>) != -1, <span class="jxr_string">"c1 success"</span>);
<a class="jxr_linenumber" name="L461" href="#L461">461</a>         assertTrue(err.indexOf(<span class="jxr_string">"p1 success"</span>) != -1, <span class="jxr_string">"p1 success"</span>);
<a class="jxr_linenumber" name="L462" href="#L462">462</a>         testOK(<span class="jxr_string">"yes\n"</span>, <span class="jxr_string">"-srcstorepass changeit -deststorepass changeit -importkeystore -srckeystore x.jceks -srcstoretype JCEKS -destkeystore x.jks -deststoretype JKS"</span>); <em class="jxr_comment">// normal</em>
<a class="jxr_linenumber" name="L463" href="#L463">463</a>         <em class="jxr_comment">// maybe c1 or p1 has been imported before s1 or s2 is touched, anyway we know yesNo is only asked once.</em>
<a class="jxr_linenumber" name="L464" href="#L464">464</a> 
<a class="jxr_linenumber" name="L465" href="#L465">465</a>         <em class="jxr_comment">// pkcs12</em>
<a class="jxr_linenumber" name="L466" href="#L466">466</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L467" href="#L467">467</a>         testFail(<span class="jxr_string">"changeit\nchangeit\n"</span>, <span class="jxr_string">"-keystore x.jks -genkeypair -alias p1 -dname CN=olala"</span>); <em class="jxr_comment">// JKS prompt for keypass</em>
<a class="jxr_linenumber" name="L468" href="#L468">468</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L469" href="#L469">469</a>         testOK(<span class="jxr_string">"changeit\nchangeit\n\n"</span>, <span class="jxr_string">"-keystore x.jks -genkeypair -alias p1 -dname CN=olala"</span>); <em class="jxr_comment">// just type ENTER means keypass=storepass</em>
<a class="jxr_linenumber" name="L470" href="#L470">470</a>         remove(<span class="jxr_string">"x.p12"</span>);
<a class="jxr_linenumber" name="L471" href="#L471">471</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.p12 -storetype PKCS12 -storepass changeit -genkeypair -alias p0 -dname CN=olala"</span>); <em class="jxr_comment">// PKCS12 only need storepass</em>
<a class="jxr_linenumber" name="L472" href="#L472">472</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.p12 -storetype PKCS12 -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L473" href="#L473">473</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.p12 -keypass changeit -storetype PKCS12 -genkeypair -alias p3 -dname CN=olala"</span>); <em class="jxr_comment">// when specify keypass, make sure keypass==storepass...</em>
<a class="jxr_linenumber" name="L474" href="#L474">474</a>         assertTrue(err.indexOf(<span class="jxr_string">"Warning"</span>) == -1, <span class="jxr_string">"PKCS12 silent when keypass == storepass"</span>);
<a class="jxr_linenumber" name="L475" href="#L475">475</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.p12 -keypass another -storetype PKCS12 -genkeypair -alias p2 -dname CN=olala"</span>); <em class="jxr_comment">// otherwise, print a warning</em>
<a class="jxr_linenumber" name="L476" href="#L476">476</a>         assertTrue(err.indexOf(<span class="jxr_string">"Warning"</span>) != -1, <span class="jxr_string">"PKCS12 warning when keypass != storepass"</span>);
<a class="jxr_linenumber" name="L477" href="#L477">477</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.p12 -storepass changeit -storetype PKCS12 -keypasswd -new changeit -alias p3"</span>); <em class="jxr_comment">// no -keypasswd for PKCS12</em>
<a class="jxr_linenumber" name="L478" href="#L478">478</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.p12 -storepass changeit -storetype PKCS12 -changealias -alias p3 -destalias p33"</span>);
<a class="jxr_linenumber" name="L479" href="#L479">479</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.p12 -storepass changeit -storetype PKCS12 -keyclone -alias p33 -destalias p3"</span>);
<a class="jxr_linenumber" name="L480" href="#L480">480</a> 
<a class="jxr_linenumber" name="L481" href="#L481">481</a>         <em class="jxr_comment">// pkcs12</em>
<a class="jxr_linenumber" name="L482" href="#L482">482</a>         remove(<span class="jxr_string">"x.p12"</span>);
<a class="jxr_linenumber" name="L483" href="#L483">483</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.p12 -storetype PKCS12 -storepass changeit -genkeypair -alias p0 -dname CN=olala"</span>); <em class="jxr_comment">// PKCS12 only need storepass</em>
<a class="jxr_linenumber" name="L484" href="#L484">484</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepass changeit -keystore x.p12 -storetype PKCS12 -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L485" href="#L485">485</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepass changeit -keystore x.p12 -keypass changeit -storetype PKCS12 -genkeypair -alias p3 -dname CN=olala"</span>); <em class="jxr_comment">// when specify keypass, make sure keypass==storepass...</em>
<a class="jxr_linenumber" name="L486" href="#L486">486</a>         assertTrue(err.indexOf(<span class="jxr_string">"Warning"</span>) == -1, <span class="jxr_string">"PKCS12 silent when keypass == storepass"</span>);
<a class="jxr_linenumber" name="L487" href="#L487">487</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepass changeit -keystore x.p12 -keypass another -storetype PKCS12 -genkeypair -alias p2 -dname CN=olala"</span>); <em class="jxr_comment">// otherwise, print a warning</em>
<a class="jxr_linenumber" name="L488" href="#L488">488</a>         assertTrue(err.indexOf(<span class="jxr_string">"Warning"</span>) != -1, <span class="jxr_string">"PKCS12 warning when keypass != storepass"</span>);
<a class="jxr_linenumber" name="L489" href="#L489">489</a> 
<a class="jxr_linenumber" name="L490" href="#L490">490</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L491" href="#L491">491</a>         remove(<span class="jxr_string">"x.jceks"</span>);
<a class="jxr_linenumber" name="L492" href="#L492">492</a>         remove(<span class="jxr_string">"x.p12"</span>);
<a class="jxr_linenumber" name="L493" href="#L493">493</a>         remove(<span class="jxr_string">"x2.jceks"</span>);
<a class="jxr_linenumber" name="L494" href="#L494">494</a>         remove(<span class="jxr_string">"x2.jks"</span>);
<a class="jxr_linenumber" name="L495" href="#L495">495</a>         remove(<span class="jxr_string">"x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L496" href="#L496">496</a>     }
<a class="jxr_linenumber" name="L497" href="#L497">497</a> 
<a class="jxr_linenumber" name="L498" href="#L498">498</a>     <strong class="jxr_keyword">void</strong> testPKCS11() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L499" href="#L499">499</a>         KeyStore ks;
<a class="jxr_linenumber" name="L500" href="#L500">500</a>         <em class="jxr_comment">// pkcs11, the password maybe different and maybe PKCS11 is not supported</em>
<a class="jxr_linenumber" name="L501" href="#L501">501</a> 
<a class="jxr_linenumber" name="L502" href="#L502">502</a>         <em class="jxr_comment">// in case last test is not executed successfully</em>
<a class="jxr_linenumber" name="L503" href="#L503">503</a>         testAnyway(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p1"</span>);
<a class="jxr_linenumber" name="L504" href="#L504">504</a>         testAnyway(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p2"</span>);
<a class="jxr_linenumber" name="L505" href="#L505">505</a>         testAnyway(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p3"</span>);
<a class="jxr_linenumber" name="L506" href="#L506">506</a>         testAnyway(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias nss"</span>);
<a class="jxr_linenumber" name="L507" href="#L507">507</a> 
<a class="jxr_linenumber" name="L508" href="#L508">508</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L509" href="#L509">509</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 0 entries"</span>) != -1, <span class="jxr_string">"*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE BEFORE THIS TEST ***"</span>);
<a class="jxr_linenumber" name="L510" href="#L510">510</a> 
<a class="jxr_linenumber" name="L511" href="#L511">511</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L512" href="#L512">512</a>         testOK(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-genkeypair -alias p2 -dname CN=olala2"</span>);
<a class="jxr_linenumber" name="L513" href="#L513">513</a>         testFail(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-keypass test12 -genkeypair -alias p3 -dname CN=olala3"</span>); <em class="jxr_comment">// cannot provide keypass for PKCS11</em>
<a class="jxr_linenumber" name="L514" href="#L514">514</a>         testFail(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-keypass nonsense -genkeypair -alias p3 -dname CN=olala3"</span>); <em class="jxr_comment">// cannot provide keypass for PKCS11</em>
<a class="jxr_linenumber" name="L515" href="#L515">515</a> 
<a class="jxr_linenumber" name="L516" href="#L516">516</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L517" href="#L517">517</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 2 entries"</span>) != -1, <span class="jxr_string">"2 entries in p11"</span>);
<a class="jxr_linenumber" name="L518" href="#L518">518</a> 
<a class="jxr_linenumber" name="L519" href="#L519">519</a>         testOK(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-alias p1 -changealias -destalias p3"</span>);
<a class="jxr_linenumber" name="L520" href="#L520">520</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p3"</span>);
<a class="jxr_linenumber" name="L521" href="#L521">521</a>         testFail(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p1"</span>);
<a class="jxr_linenumber" name="L522" href="#L522">522</a> 
<a class="jxr_linenumber" name="L523" href="#L523">523</a>         testOK(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-alias p3 -keyclone -destalias p1"</span>);
<a class="jxr_linenumber" name="L524" href="#L524">524</a>         testFail(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p3"</span>);   <em class="jxr_comment">// in PKCS11, keyclone will delete old</em>
<a class="jxr_linenumber" name="L525" href="#L525">525</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p1"</span>);
<a class="jxr_linenumber" name="L526" href="#L526">526</a> 
<a class="jxr_linenumber" name="L527" href="#L527">527</a>         testFail(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-alias p1 -keypasswd -new another"</span>); <em class="jxr_comment">// cannot change password for PKCS11</em>
<a class="jxr_linenumber" name="L528" href="#L528">528</a> 
<a class="jxr_linenumber" name="L529" href="#L529">529</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L530" href="#L530">530</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 2 entries"</span>) != -1, <span class="jxr_string">"2 entries in p11"</span>);
<a class="jxr_linenumber" name="L531" href="#L531">531</a> 
<a class="jxr_linenumber" name="L532" href="#L532">532</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p1"</span>);
<a class="jxr_linenumber" name="L533" href="#L533">533</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p2"</span>);
<a class="jxr_linenumber" name="L534" href="#L534">534</a> 
<a class="jxr_linenumber" name="L535" href="#L535">535</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L536" href="#L536">536</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 0 entries"</span>) != -1, <span class="jxr_string">"*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE BEFORE THIS TEST ***"</span>);
<a class="jxr_linenumber" name="L537" href="#L537">537</a>     }
<a class="jxr_linenumber" name="L538" href="#L538">538</a> 
<a class="jxr_linenumber" name="L539" href="#L539">539</a>     <strong class="jxr_keyword">void</strong> testPKCS11ImportKeyStore() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L540" href="#L540">540</a> 
<a class="jxr_linenumber" name="L541" href="#L541">541</a>         KeyStore ks;
<a class="jxr_linenumber" name="L542" href="#L542">542</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -genkeypair -alias p1 -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L543" href="#L543">543</a>         testOK(<span class="jxr_string">"test12\n"</span>, p11Arg + <span class="jxr_string">"-genkeypair -alias p2 -dname CN=olala2"</span>);
<a class="jxr_linenumber" name="L544" href="#L544">544</a>         <em class="jxr_comment">// test importkeystore for pkcs11</em>
<a class="jxr_linenumber" name="L545" href="#L545">545</a> 
<a class="jxr_linenumber" name="L546" href="#L546">546</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L547" href="#L547">547</a>         <em class="jxr_comment">// pkcs11 -&gt; jks</em>
<a class="jxr_linenumber" name="L548" href="#L548">548</a>         testOK(<span class="jxr_string">"changeit\nchangeit\ntest12\n"</span>, srcP11Arg + <span class="jxr_string">"-importkeystore -destkeystore x.jks -deststoretype JKS -srcalias p1"</span>);
<a class="jxr_linenumber" name="L549" href="#L549">549</a>         assertTrue(err.indexOf(<span class="jxr_string">"not imported"</span>) != -1, <span class="jxr_string">"cannot import key without destkeypass"</span>);
<a class="jxr_linenumber" name="L550" href="#L550">550</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L551" href="#L551">551</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"p1"</span>), <span class="jxr_string">"p1 is not imported"</span>);
<a class="jxr_linenumber" name="L552" href="#L552">552</a> 
<a class="jxr_linenumber" name="L553" href="#L553">553</a>         testOK(<span class="jxr_string">"changeit\ntest12\n"</span>, srcP11Arg + <span class="jxr_string">"-importkeystore -destkeystore x.jks -deststoretype JKS -srcalias p1 -destkeypass changeit"</span>);
<a class="jxr_linenumber" name="L554" href="#L554">554</a>         testOK(<span class="jxr_string">"changeit\ntest12\n"</span>, srcP11Arg + <span class="jxr_string">"-importkeystore -destkeystore x.jks -deststoretype JKS -srcalias p2 -destkeypass changeit"</span>);
<a class="jxr_linenumber" name="L555" href="#L555">555</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L556" href="#L556">556</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"p1"</span>), <span class="jxr_string">"p1 is imported"</span>);
<a class="jxr_linenumber" name="L557" href="#L557">557</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"p2"</span>), <span class="jxr_string">"p2 is imported"</span>);
<a class="jxr_linenumber" name="L558" href="#L558">558</a>         <em class="jxr_comment">// jks -&gt; pkcs11</em>
<a class="jxr_linenumber" name="L559" href="#L559">559</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p1"</span>);
<a class="jxr_linenumber" name="L560" href="#L560">560</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p2"</span>);
<a class="jxr_linenumber" name="L561" href="#L561">561</a>         testOK(<span class="jxr_string">"test12\nchangeit\n"</span>, p11Arg + <span class="jxr_string">"-importkeystore -srckeystore x.jks -srcstoretype JKS"</span>);
<a class="jxr_linenumber" name="L562" href="#L562">562</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p1"</span>);
<a class="jxr_linenumber" name="L563" href="#L563">563</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias p2"</span>);
<a class="jxr_linenumber" name="L564" href="#L564">564</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L565" href="#L565">565</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 2 entries"</span>) != -1, <span class="jxr_string">"2 entries in p11"</span>);
<a class="jxr_linenumber" name="L566" href="#L566">566</a>         <em class="jxr_comment">// clean up</em>
<a class="jxr_linenumber" name="L567" href="#L567">567</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p1"</span>);
<a class="jxr_linenumber" name="L568" href="#L568">568</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias p2"</span>);
<a class="jxr_linenumber" name="L569" href="#L569">569</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L570" href="#L570">570</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 0 entries"</span>) != -1, <span class="jxr_string">"empty p11"</span>);
<a class="jxr_linenumber" name="L571" href="#L571">571</a> 
<a class="jxr_linenumber" name="L572" href="#L572">572</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L573" href="#L573">573</a>     }
<a class="jxr_linenumber" name="L574" href="#L574">574</a> 
<a class="jxr_linenumber" name="L575" href="#L575">575</a>     <em class="jxr_comment">// The sqeTest reflects the test suggested by judy.gao and bill.situ at</em>
<a class="jxr_linenumber" name="L576" href="#L576">576</a>     <em class="jxr_comment">// /net/sqesvr-nfs/global/nfs/sec/ws_6.0_int/security/src/SecurityTools/Keytool</em>
<a class="jxr_linenumber" name="L577" href="#L577">577</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="L578" href="#L578">578</a>     <strong class="jxr_keyword">void</strong> sqeTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L579" href="#L579">579</a>         FileOutputStream fos = <strong class="jxr_keyword">new</strong> FileOutputStream(<span class="jxr_string">"badkeystore"</span>);
<a class="jxr_linenumber" name="L580" href="#L580">580</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i=0; i&lt;100; i++) {
<a class="jxr_linenumber" name="L581" href="#L581">581</a>             fos.write(i);
<a class="jxr_linenumber" name="L582" href="#L582">582</a>         }
<a class="jxr_linenumber" name="L583" href="#L583">583</a>         fos.close();
<a class="jxr_linenumber" name="L584" href="#L584">584</a> 
<a class="jxr_linenumber" name="L585" href="#L585">585</a>         sqeCsrTest();
<a class="jxr_linenumber" name="L586" href="#L586">586</a>         sqePrintcertTest();
<a class="jxr_linenumber" name="L587" href="#L587">587</a>         sqeDeleteTest();
<a class="jxr_linenumber" name="L588" href="#L588">588</a>         sqeExportTest();
<a class="jxr_linenumber" name="L589" href="#L589">589</a>         sqeGenkeyTest();
<a class="jxr_linenumber" name="L590" href="#L590">590</a>         sqeImportTest();
<a class="jxr_linenumber" name="L591" href="#L591">591</a>         sqeKeyclonetest();
<a class="jxr_linenumber" name="L592" href="#L592">592</a>         sqeKeypasswdTest();
<a class="jxr_linenumber" name="L593" href="#L593">593</a>         sqeListTest();
<a class="jxr_linenumber" name="L594" href="#L594">594</a>         sqeSelfCertTest();
<a class="jxr_linenumber" name="L595" href="#L595">595</a>         sqeStorepassTest();
<a class="jxr_linenumber" name="L596" href="#L596">596</a> 
<a class="jxr_linenumber" name="L597" href="#L597">597</a>         remove(<span class="jxr_string">"badkeystore"</span>);
<a class="jxr_linenumber" name="L598" href="#L598">598</a>     }
<a class="jxr_linenumber" name="L599" href="#L599">599</a> 
<a class="jxr_linenumber" name="L600" href="#L600">600</a>     <em class="jxr_comment">// Import: cacert, prompt, trusted, non-trusted, bad chain, not match</em>
<a class="jxr_linenumber" name="L601" href="#L601">601</a>     <strong class="jxr_keyword">void</strong> sqeImportTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L602" href="#L602">602</a>         KeyStore ks;
<a class="jxr_linenumber" name="L603" href="#L603">603</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L604" href="#L604">604</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L605" href="#L605">605</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L606" href="#L606">606</a>         <em class="jxr_comment">/* deleted */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L607" href="#L607">607</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert -noprompt"</span>);
<a class="jxr_linenumber" name="L608" href="#L608">608</a>         <em class="jxr_comment">/* deleted */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L609" href="#L609">609</a>         testOK(<span class="jxr_string">"yes\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L610" href="#L610">610</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L611" href="#L611">611</a>         assertTrue(ks.containsAlias(<span class="jxr_string">"mykey"</span>), <span class="jxr_string">"imported"</span>);
<a class="jxr_linenumber" name="L612" href="#L612">612</a>         <em class="jxr_comment">/* deleted */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L613" href="#L613">613</a>         testOK(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L614" href="#L614">614</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L615" href="#L615">615</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"mykey"</span>), <span class="jxr_string">"imported"</span>);
<a class="jxr_linenumber" name="L616" href="#L616">616</a>         testOK(<span class="jxr_string">"no\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L617" href="#L617">617</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L618" href="#L618">618</a>         assertTrue(!ks.containsAlias(<span class="jxr_string">"mykey"</span>), <span class="jxr_string">"imported"</span>);
<a class="jxr_linenumber" name="L619" href="#L619">619</a>         testFail(<span class="jxr_string">"no\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file nonexist"</span>);
<a class="jxr_linenumber" name="L620" href="#L620">620</a>         testFail(<span class="jxr_string">"no\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks"</span>);
<a class="jxr_linenumber" name="L621" href="#L621">621</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L622" href="#L622">622</a>     }
<a class="jxr_linenumber" name="L623" href="#L623">623</a>     <em class="jxr_comment">// keyclone: exist. nonexist err, cert err, dest exist, misc</em>
<a class="jxr_linenumber" name="L624" href="#L624">624</a>     <strong class="jxr_keyword">void</strong> sqeKeyclonetest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L625" href="#L625">625</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L626" href="#L626">626</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L627" href="#L627">627</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -new newpass -keyclone -dest p0"</span>); <em class="jxr_comment">// new pass</em>
<a class="jxr_linenumber" name="L628" href="#L628">628</a>         testOK(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -keyclone -dest p1"</span>); <em class="jxr_comment">// new pass</em>
<a class="jxr_linenumber" name="L629" href="#L629">629</a>         testOK(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keyclone -dest p2"</span>);
<a class="jxr_linenumber" name="L630" href="#L630">630</a>         testFail(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keyclone -dest p2"</span>);
<a class="jxr_linenumber" name="L631" href="#L631">631</a>         testFail(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keyclone -dest p3 -alias noexist"</span>);
<a class="jxr_linenumber" name="L632" href="#L632">632</a>         <em class="jxr_comment">// no cert</em>
<a class="jxr_linenumber" name="L633" href="#L633">633</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L634" href="#L634">634</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L635" href="#L635">635</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert -noprompt"</span>);
<a class="jxr_linenumber" name="L636" href="#L636">636</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -new newpass -keyclone -dest p0"</span>); <em class="jxr_comment">// new pass</em>
<a class="jxr_linenumber" name="L637" href="#L637">637</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L638" href="#L638">638</a>     }
<a class="jxr_linenumber" name="L639" href="#L639">639</a>     <em class="jxr_comment">// keypasswd: exist, short, nonexist err, cert err, misc</em>
<a class="jxr_linenumber" name="L640" href="#L640">640</a>     <strong class="jxr_keyword">void</strong> sqeKeypasswdTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L641" href="#L641">641</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L642" href="#L642">642</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L643" href="#L643">643</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L644" href="#L644">644</a>         <em class="jxr_comment">/*change back*/</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass newpass -keypasswd -new changeit"</span>);
<a class="jxr_linenumber" name="L645" href="#L645">645</a>         testOK(<span class="jxr_string">"newpass\nnewpass\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -keypasswd"</span>);
<a class="jxr_linenumber" name="L646" href="#L646">646</a>         <em class="jxr_comment">/*change back*/</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass newpass -keypasswd -new changeit"</span>);
<a class="jxr_linenumber" name="L647" href="#L647">647</a>         testOK(<span class="jxr_string">"new\nnew\nnewpass\nnewpass\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -keypasswd"</span>);
<a class="jxr_linenumber" name="L648" href="#L648">648</a>         <em class="jxr_comment">/*change back*/</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass newpass -keypasswd -new changeit"</span>);
<a class="jxr_linenumber" name="L649" href="#L649">649</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L650" href="#L650">650</a>         <em class="jxr_comment">/*change back*/</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass newpass -keypasswd -new changeit"</span>);
<a class="jxr_linenumber" name="L651" href="#L651">651</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jks -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L652" href="#L652">652</a>         <em class="jxr_comment">/*change back*/</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass newpass -keypasswd -new changeit"</span>);
<a class="jxr_linenumber" name="L653" href="#L653">653</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass badpass -keypass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L654" href="#L654">654</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass bad -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L655" href="#L655">655</a>         <em class="jxr_comment">// no cert</em>
<a class="jxr_linenumber" name="L656" href="#L656">656</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L657" href="#L657">657</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L658" href="#L658">658</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert -noprompt"</span>);
<a class="jxr_linenumber" name="L659" href="#L659">659</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L660" href="#L660">660</a>         <em class="jxr_comment">// diff pass</em>
<a class="jxr_linenumber" name="L661" href="#L661">661</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L662" href="#L662">662</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass keypass -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L663" href="#L663">663</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L664" href="#L664">664</a>         testOK(<span class="jxr_string">"keypass\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypasswd -new newpass"</span>);
<a class="jxr_linenumber" name="L665" href="#L665">665</a>         <em class="jxr_comment">// i hate those misc test</em>
<a class="jxr_linenumber" name="L666" href="#L666">666</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L667" href="#L667">667</a>     }
<a class="jxr_linenumber" name="L668" href="#L668">668</a>     <em class="jxr_comment">// list: -f -alias, exist, nonexist err; otherwise, check all shows, -rfc shows more, and misc</em>
<a class="jxr_linenumber" name="L669" href="#L669">669</a>     <strong class="jxr_keyword">void</strong> sqeListTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L670" href="#L670">670</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L671" href="#L671">671</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L672" href="#L672">672</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -list"</span>);
<a class="jxr_linenumber" name="L673" href="#L673">673</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -list -alias mykey"</span>);
<a class="jxr_linenumber" name="L674" href="#L674">674</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -list -alias notexist"</span>);
<a class="jxr_linenumber" name="L675" href="#L675">675</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass badpass -list -alias mykey"</span>);
<a class="jxr_linenumber" name="L676" href="#L676">676</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass badpass -list -alias mykey"</span>);  <em class="jxr_comment">// keypass ignore</em>
<a class="jxr_linenumber" name="L677" href="#L677">677</a>         testOK(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -list"</span>);
<a class="jxr_linenumber" name="L678" href="#L678">678</a>         assertTrue(err.indexOf(<span class="jxr_string">"WARNING"</span>) != -1, <span class="jxr_string">"no storepass"</span>);
<a class="jxr_linenumber" name="L679" href="#L679">679</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jks -list"</span>);
<a class="jxr_linenumber" name="L680" href="#L680">680</a>         assertTrue(err.indexOf(<span class="jxr_string">"WARNING"</span>) == -1, <span class="jxr_string">"has storepass"</span>);
<a class="jxr_linenumber" name="L681" href="#L681">681</a>         testFail(<span class="jxr_string">"badpass\n"</span>, <span class="jxr_string">"-keystore x.jks -list"</span>);
<a class="jxr_linenumber" name="L682" href="#L682">682</a>         <em class="jxr_comment">// misc</em>
<a class="jxr_linenumber" name="L683" href="#L683">683</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore aa&#92;&#92;bb//cc -storepass changeit -list"</span>);
<a class="jxr_linenumber" name="L684" href="#L684">684</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore nonexisting -storepass changeit -list"</span>);
<a class="jxr_linenumber" name="L685" href="#L685">685</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore badkeystore -storepass changeit -list"</span>);
<a class="jxr_linenumber" name="L686" href="#L686">686</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L687" href="#L687">687</a>     }
<a class="jxr_linenumber" name="L688" href="#L688">688</a>     <em class="jxr_comment">// selfcert: exist, non-exist err, cert err, sig..., dname, wrong keypass, misc</em>
<a class="jxr_linenumber" name="L689" href="#L689">689</a>     <strong class="jxr_keyword">void</strong> sqeSelfCertTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L690" href="#L690">690</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L691" href="#L691">691</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L692" href="#L692">692</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L693" href="#L693">693</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L694" href="#L694">694</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -selfcert -alias nonexisting"</span>); <em class="jxr_comment">// not exist</em>
<a class="jxr_linenumber" name="L695" href="#L695">695</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -selfcert -dname CN=NewName"</span>);
<a class="jxr_linenumber" name="L696" href="#L696">696</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -selfcert -sigalg MD5withRSA"</span>); <em class="jxr_comment">// sig not compatible</em>
<a class="jxr_linenumber" name="L697" href="#L697">697</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass wrong -keypass changeit -selfcert"</span>); <em class="jxr_comment">// bad pass</em>
<a class="jxr_linenumber" name="L698" href="#L698">698</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass wrong -selfcert"</span>); <em class="jxr_comment">// bad pass</em>
<a class="jxr_linenumber" name="L699" href="#L699">699</a>         <em class="jxr_comment">//misc</em>
<a class="jxr_linenumber" name="L700" href="#L700">700</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore nonexist -storepass changeit -keypass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L701" href="#L701">701</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore aa//dd&#92;&#92;gg -storepass changeit -keypass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L702" href="#L702">702</a>         <em class="jxr_comment">// diff pass</em>
<a class="jxr_linenumber" name="L703" href="#L703">703</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L704" href="#L704">704</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass keypass -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L705" href="#L705">705</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L706" href="#L706">706</a>         testOK(<span class="jxr_string">"keypass\n"</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -selfcert"</span>);
<a class="jxr_linenumber" name="L707" href="#L707">707</a> 
<a class="jxr_linenumber" name="L708" href="#L708">708</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L709" href="#L709">709</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L710" href="#L710">710</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert -noprompt"</span>);
<a class="jxr_linenumber" name="L711" href="#L711">711</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -selfcert"</span>);  <em class="jxr_comment">// certentry cannot do selfcert</em>
<a class="jxr_linenumber" name="L712" href="#L712">712</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L713" href="#L713">713</a>     }
<a class="jxr_linenumber" name="L714" href="#L714">714</a>     <em class="jxr_comment">// storepass: bad old, short new, misc</em>
<a class="jxr_linenumber" name="L715" href="#L715">715</a>     <strong class="jxr_keyword">void</strong> sqeStorepassTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L716" href="#L716">716</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L717" href="#L717">717</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L718" href="#L718">718</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass changeit -new newstore"</span>); <em class="jxr_comment">// all in arg</em>
<a class="jxr_linenumber" name="L719" href="#L719">719</a>         <em class="jxr_comment">/* Change back */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass newstore -new changeit"</span>);
<a class="jxr_linenumber" name="L720" href="#L720">720</a>         testOK(<span class="jxr_string">"changeit\nnewstore\nnewstore\n"</span>, <span class="jxr_string">"-storepasswd -keystore x.jks"</span>); <em class="jxr_comment">// all not in arg, new twice</em>
<a class="jxr_linenumber" name="L721" href="#L721">721</a>         <em class="jxr_comment">/* Change back */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass newstore -new changeit"</span>);
<a class="jxr_linenumber" name="L722" href="#L722">722</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -new newstore"</span>); <em class="jxr_comment">// new in arg</em>
<a class="jxr_linenumber" name="L723" href="#L723">723</a>         <em class="jxr_comment">/* Change back */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass newstore -new changeit"</span>);
<a class="jxr_linenumber" name="L724" href="#L724">724</a>         testOK(<span class="jxr_string">"newstore\nnewstore\n"</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass changeit"</span>); <em class="jxr_comment">// old in arg</em>
<a class="jxr_linenumber" name="L725" href="#L725">725</a>         <em class="jxr_comment">/* Change back */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass newstore -new changeit"</span>);
<a class="jxr_linenumber" name="L726" href="#L726">726</a>         testOK(<span class="jxr_string">"new\nnew\nnewstore\nnewstore\n"</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass changeit"</span>); <em class="jxr_comment">// old in arg</em>
<a class="jxr_linenumber" name="L727" href="#L727">727</a>         <em class="jxr_comment">/* Change back */</em> testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass newstore -new changeit"</span>);
<a class="jxr_linenumber" name="L728" href="#L728">728</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass badold -new newstore"</span>); <em class="jxr_comment">// bad old</em>
<a class="jxr_linenumber" name="L729" href="#L729">729</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore x.jks -storepass changeit -new new"</span>); <em class="jxr_comment">// short new</em>
<a class="jxr_linenumber" name="L730" href="#L730">730</a>         <em class="jxr_comment">// misc</em>
<a class="jxr_linenumber" name="L731" href="#L731">731</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore nonexist -storepass changeit -new newstore"</span>); <em class="jxr_comment">// non exist</em>
<a class="jxr_linenumber" name="L732" href="#L732">732</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore badkeystore -storepass changeit -new newstore"</span>); <em class="jxr_comment">// bad file</em>
<a class="jxr_linenumber" name="L733" href="#L733">733</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -keystore aa&#92;&#92;bb//cc//dd -storepass changeit -new newstore"</span>); // bad file
<a class="jxr_linenumber" name="L734" href="#L734">734</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L735" href="#L735">735</a>     }
<a class="jxr_linenumber" name="L736" href="#L736">736</a> 
<a class="jxr_linenumber" name="L737" href="#L737">737</a>     <strong class="jxr_keyword">void</strong> sqeGenkeyTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L738" href="#L738">738</a> 
<a class="jxr_linenumber" name="L739" href="#L739">739</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L740" href="#L740">740</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L741" href="#L741">741</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L742" href="#L742">742</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -alias newentry"</span>);
<a class="jxr_linenumber" name="L743" href="#L743">743</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -alias newentry"</span>);
<a class="jxr_linenumber" name="L744" href="#L744">744</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg DSA -alias n1"</span>);
<a class="jxr_linenumber" name="L745" href="#L745">745</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA -alias n2"</span>);
<a class="jxr_linenumber" name="L746" href="#L746">746</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg NoSuchAlg -alias n3"</span>);
<a class="jxr_linenumber" name="L747" href="#L747">747</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keysize 56 -alias n4"</span>);
<a class="jxr_linenumber" name="L748" href="#L748">748</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keysize 999 -alias n5"</span>);
<a class="jxr_linenumber" name="L749" href="#L749">749</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keysize 512 -alias n6"</span>);
<a class="jxr_linenumber" name="L750" href="#L750">750</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keysize 1024 -alias n7"</span>);
<a class="jxr_linenumber" name="L751" href="#L751">751</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -sigalg NoSuchAlg -alias n8"</span>);
<a class="jxr_linenumber" name="L752" href="#L752">752</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA -sigalg MD2withRSA -alias n9"</span>);
<a class="jxr_linenumber" name="L753" href="#L753">753</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA -sigalg MD5withRSA -alias n10"</span>);
<a class="jxr_linenumber" name="L754" href="#L754">754</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA -sigalg SHA1withRSA -alias n11"</span>);
<a class="jxr_linenumber" name="L755" href="#L755">755</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore aa&#92;&#92;bb//cc&#92;&#92;dd -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA -sigalg NoSuchAlg -alias n12"</span>);
<a class="jxr_linenumber" name="L756" href="#L756">756</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore badkeystore -storepass changeit -keypass changeit -genkeypair -dname CN=olala -alias n14"</span>);
<a class="jxr_linenumber" name="L757" href="#L757">757</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass badpass -keypass changeit -genkeypair -dname CN=olala -alias n16"</span>);
<a class="jxr_linenumber" name="L758" href="#L758">758</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CNN=olala -alias n17"</span>);
<a class="jxr_linenumber" name="L759" href="#L759">759</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L760" href="#L760">760</a>     }
<a class="jxr_linenumber" name="L761" href="#L761">761</a> 
<a class="jxr_linenumber" name="L762" href="#L762">762</a>     <strong class="jxr_keyword">void</strong> sqeExportTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L763" href="#L763">763</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L764" href="#L764">764</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -export -file mykey.cert -alias mykey"</span>); <em class="jxr_comment">// nonexist</em>
<a class="jxr_linenumber" name="L765" href="#L765">765</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L766" href="#L766">766</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -export -file mykey.cert -alias mykey"</span>);
<a class="jxr_linenumber" name="L767" href="#L767">767</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L768" href="#L768">768</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -import -file mykey.cert -noprompt -alias c1"</span>);
<a class="jxr_linenumber" name="L769" href="#L769">769</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -export -file mykey.cert2 -alias c1"</span>);
<a class="jxr_linenumber" name="L770" href="#L770">770</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore aa&#92;&#92;bb//cc&#92;&#92;dd -storepass changeit -export -file mykey.cert2 -alias c1"</span>);
<a class="jxr_linenumber" name="L771" href="#L771">771</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore nonexistkeystore -storepass changeit -export -file mykey.cert2 -alias c1"</span>);
<a class="jxr_linenumber" name="L772" href="#L772">772</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore badkeystore -storepass changeit -export -file mykey.cert2 -alias c1"</span>);
<a class="jxr_linenumber" name="L773" href="#L773">773</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass badpass -export -file mykey.cert2 -alias c1"</span>);
<a class="jxr_linenumber" name="L774" href="#L774">774</a>         remove(<span class="jxr_string">"mykey.cert"</span>);
<a class="jxr_linenumber" name="L775" href="#L775">775</a>         remove(<span class="jxr_string">"mykey.cert2"</span>);
<a class="jxr_linenumber" name="L776" href="#L776">776</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L777" href="#L777">777</a>     }
<a class="jxr_linenumber" name="L778" href="#L778">778</a> 
<a class="jxr_linenumber" name="L779" href="#L779">779</a>     <strong class="jxr_keyword">void</strong> sqeDeleteTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L780" href="#L780">780</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L781" href="#L781">781</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>); <em class="jxr_comment">// nonexist</em>
<a class="jxr_linenumber" name="L782" href="#L782">782</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L783" href="#L783">783</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L784" href="#L784">784</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L785" href="#L785">785</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore aa&#92;&#92;bb//cc&#92;&#92;dd -storepass changeit -delete -alias mykey"</span>); // keystore name illegal
<a class="jxr_linenumber" name="L786" href="#L786">786</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore nonexistkeystore -storepass changeit -delete -alias mykey"</span>); <em class="jxr_comment">// keystore not exist</em>
<a class="jxr_linenumber" name="L787" href="#L787">787</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore badkeystore -storepass changeit -delete -alias mykey"</span>); <em class="jxr_comment">// keystore invalid</em>
<a class="jxr_linenumber" name="L788" href="#L788">788</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass xxxxxxxx -delete -alias mykey"</span>); <em class="jxr_comment">// wrong pass</em>
<a class="jxr_linenumber" name="L789" href="#L789">789</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L790" href="#L790">790</a>     }
<a class="jxr_linenumber" name="L791" href="#L791">791</a> 
<a class="jxr_linenumber" name="L792" href="#L792">792</a>     <strong class="jxr_keyword">void</strong> sqeCsrTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L793" href="#L793">793</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L794" href="#L794">794</a>         remove(<span class="jxr_string">"x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L795" href="#L795">795</a>         remove(<span class="jxr_string">"csr1"</span>);
<a class="jxr_linenumber" name="L796" href="#L796">796</a>         <em class="jxr_comment">// PrivateKeyEntry can do certreq</em>
<a class="jxr_linenumber" name="L797" href="#L797">797</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L798" href="#L798">798</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -alias mykey"</span>);
<a class="jxr_linenumber" name="L799" href="#L799">799</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1"</span>);
<a class="jxr_linenumber" name="L800" href="#L800">800</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -sigalg SHA1withDSA"</span>);
<a class="jxr_linenumber" name="L801" href="#L801">801</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -sigalg MD5withRSA"</span>); <em class="jxr_comment">// unmatched sigalg</em>
<a class="jxr_linenumber" name="L802" href="#L802">802</a>         <em class="jxr_comment">// misc test</em>
<a class="jxr_linenumber" name="L803" href="#L803">803</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass badstorepass -certreq -file csr1"</span>); <em class="jxr_comment">// bad storepass</em>
<a class="jxr_linenumber" name="L804" href="#L804">804</a>         testOK(<span class="jxr_string">"changeit\n"</span>, <span class="jxr_string">"-keystore x.jks -certreq -file csr1"</span>); <em class="jxr_comment">// storepass from terminal</em>
<a class="jxr_linenumber" name="L805" href="#L805">805</a>         testFail(<span class="jxr_string">"\n"</span>, <span class="jxr_string">"-keystore x.jks -certreq -file csr1"</span>); <em class="jxr_comment">// must provide storepass</em>
<a class="jxr_linenumber" name="L806" href="#L806">806</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass badkeypass -certreq -file csr1"</span>); <em class="jxr_comment">// bad keypass</em>
<a class="jxr_linenumber" name="L807" href="#L807">807</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file aa&#92;&#92;bb//cc&#92;&#92;dd"</span>);  // bad filepath
<a class="jxr_linenumber" name="L808" href="#L808">808</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore noexistks -storepass changeit -certreq -file csr1"</span>); <em class="jxr_comment">// non-existing keystore</em>
<a class="jxr_linenumber" name="L809" href="#L809">809</a>         <em class="jxr_comment">// Try the RSA private key</em>
<a class="jxr_linenumber" name="L810" href="#L810">810</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L811" href="#L811">811</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala -keyalg RSA"</span>);
<a class="jxr_linenumber" name="L812" href="#L812">812</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -alias mykey"</span>);
<a class="jxr_linenumber" name="L813" href="#L813">813</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1"</span>);
<a class="jxr_linenumber" name="L814" href="#L814">814</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -sigalg SHA1withDSA"</span>); <em class="jxr_comment">// unmatched sigalg</em>
<a class="jxr_linenumber" name="L815" href="#L815">815</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -sigalg MD5withRSA"</span>);
<a class="jxr_linenumber" name="L816" href="#L816">816</a>         <em class="jxr_comment">// TrustedCertificateEntry cannot do certreq</em>
<a class="jxr_linenumber" name="L817" href="#L817">817</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -exportcert -file x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L818" href="#L818">818</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -delete -alias mykey"</span>);
<a class="jxr_linenumber" name="L819" href="#L819">819</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -importcert -file x.jks.p1.cert -noprompt"</span>);
<a class="jxr_linenumber" name="L820" href="#L820">820</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1 -alias mykey"</span>);
<a class="jxr_linenumber" name="L821" href="#L821">821</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -certreq -file csr1"</span>);
<a class="jxr_linenumber" name="L822" href="#L822">822</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L823" href="#L823">823</a>         remove(<span class="jxr_string">"x.jks.p1.cert"</span>);
<a class="jxr_linenumber" name="L824" href="#L824">824</a>         remove(<span class="jxr_string">"csr1"</span>);
<a class="jxr_linenumber" name="L825" href="#L825">825</a>     }
<a class="jxr_linenumber" name="L826" href="#L826">826</a> 
<a class="jxr_linenumber" name="L827" href="#L827">827</a>     <strong class="jxr_keyword">void</strong> sqePrintcertTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L828" href="#L828">828</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L829" href="#L829">829</a>         remove(<span class="jxr_string">"mykey.cert"</span>);
<a class="jxr_linenumber" name="L830" href="#L830">830</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -genkeypair -dname CN=olala"</span>);
<a class="jxr_linenumber" name="L831" href="#L831">831</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-keystore x.jks -storepass changeit -export -file mykey.cert -alias mykey"</span>);
<a class="jxr_linenumber" name="L832" href="#L832">832</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcert -file badkeystore"</span>);
<a class="jxr_linenumber" name="L833" href="#L833">833</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcert -file a/b/c/d"</span>);
<a class="jxr_linenumber" name="L834" href="#L834">834</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcert -file mykey.cert"</span>);
<a class="jxr_linenumber" name="L835" href="#L835">835</a>         FileInputStream fin = <strong class="jxr_keyword">new</strong> FileInputStream(<span class="jxr_string">"mykey.cert"</span>);
<a class="jxr_linenumber" name="L836" href="#L836">836</a>         testOK(fin, <span class="jxr_string">"-printcert"</span>);
<a class="jxr_linenumber" name="L837" href="#L837">837</a>         fin.close();
<a class="jxr_linenumber" name="L838" href="#L838">838</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L839" href="#L839">839</a>         remove(<span class="jxr_string">"mykey.cert"</span>);
<a class="jxr_linenumber" name="L840" href="#L840">840</a>     }
<a class="jxr_linenumber" name="L841" href="#L841">841</a> 
<a class="jxr_linenumber" name="L842" href="#L842">842</a>     <strong class="jxr_keyword">void</strong> v3extTest(String keyAlg) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L843" href="#L843">843</a>         KeyStore ks;
<a class="jxr_linenumber" name="L844" href="#L844">844</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L845" href="#L845">845</a>         String simple = <span class="jxr_string">"-keystore x.jks -storepass changeit -keypass changeit -noprompt -keyalg "</span> + keyAlg + <span class="jxr_string">" "</span>;
<a class="jxr_linenumber" name="L846" href="#L846">846</a>         String pre = simple + <span class="jxr_string">"-genkeypair -dname CN=Olala -alias "</span>;
<a class="jxr_linenumber" name="L847" href="#L847">847</a> 
<a class="jxr_linenumber" name="L848" href="#L848">848</a>         <em class="jxr_comment">// Version and SKID</em>
<a class="jxr_linenumber" name="L849" href="#L849">849</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"o1"</span>);
<a class="jxr_linenumber" name="L850" href="#L850">850</a> 
<a class="jxr_linenumber" name="L851" href="#L851">851</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L852" href="#L852">852</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"o1"</span>)).getVersion() == 3);
<a class="jxr_linenumber" name="L853" href="#L853">853</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"o1"</span>)).getSubjectKeyIdentifierExtension() != <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L854" href="#L854">854</a> 
<a class="jxr_linenumber" name="L855" href="#L855">855</a>         <em class="jxr_comment">// BC</em>
<a class="jxr_linenumber" name="L856" href="#L856">856</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b1 -ext BC:critical"</span>);
<a class="jxr_linenumber" name="L857" href="#L857">857</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b2 -ext BC"</span>);
<a class="jxr_linenumber" name="L858" href="#L858">858</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b3 -ext bc"</span>);
<a class="jxr_linenumber" name="L859" href="#L859">859</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b4 -ext BasicConstraints"</span>);
<a class="jxr_linenumber" name="L860" href="#L860">860</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b5 -ext basicconstraints"</span>);
<a class="jxr_linenumber" name="L861" href="#L861">861</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b6 -ext BC=ca:true,pathlen:12"</span>);
<a class="jxr_linenumber" name="L862" href="#L862">862</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b7 -ext BC=ca:false"</span>);
<a class="jxr_linenumber" name="L863" href="#L863">863</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b8 -ext BC:critical=ca:false"</span>);
<a class="jxr_linenumber" name="L864" href="#L864">864</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"b9 -ext BC=12"</span>);
<a class="jxr_linenumber" name="L865" href="#L865">865</a> 
<a class="jxr_linenumber" name="L866" href="#L866">866</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L867" href="#L867">867</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"b1"</span>)).getBasicConstraintsExtension().isCritical());
<a class="jxr_linenumber" name="L868" href="#L868">868</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"b2"</span>)).getBasicConstraintsExtension().isCritical());
<a class="jxr_linenumber" name="L869" href="#L869">869</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"b8"</span>)).getBasicConstraintsExtension().isCritical());
<a class="jxr_linenumber" name="L870" href="#L870">870</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b1"</span>)).getBasicConstraints() == Integer.MAX_VALUE);
<a class="jxr_linenumber" name="L871" href="#L871">871</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b2"</span>)).getBasicConstraints() == Integer.MAX_VALUE);
<a class="jxr_linenumber" name="L872" href="#L872">872</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b3"</span>)).getBasicConstraints() == Integer.MAX_VALUE);
<a class="jxr_linenumber" name="L873" href="#L873">873</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b4"</span>)).getBasicConstraints() == Integer.MAX_VALUE);
<a class="jxr_linenumber" name="L874" href="#L874">874</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b5"</span>)).getBasicConstraints() == Integer.MAX_VALUE);
<a class="jxr_linenumber" name="L875" href="#L875">875</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b6"</span>)).getBasicConstraints() == 12);
<a class="jxr_linenumber" name="L876" href="#L876">876</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b7"</span>)).getBasicConstraints() == -1);
<a class="jxr_linenumber" name="L877" href="#L877">877</a>         assertTrue(((X509Certificate)ks.getCertificate(<span class="jxr_string">"b9"</span>)).getBasicConstraints() == 12);
<a class="jxr_linenumber" name="L878" href="#L878">878</a> 
<a class="jxr_linenumber" name="L879" href="#L879">879</a>         <em class="jxr_comment">// KU</em>
<a class="jxr_linenumber" name="L880" href="#L880">880</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku1 -ext KeyUsage:critical=digitalsignature"</span>);
<a class="jxr_linenumber" name="L881" href="#L881">881</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku2 -ext KU=digitalSignature"</span>);
<a class="jxr_linenumber" name="L882" href="#L882">882</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku3 -ext KU=ds"</span>);
<a class="jxr_linenumber" name="L883" href="#L883">883</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku4 -ext KU=dig"</span>);
<a class="jxr_linenumber" name="L884" href="#L884">884</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku5 -ext KU=d"</span>);    <em class="jxr_comment">// ambigous value</em>
<a class="jxr_linenumber" name="L885" href="#L885">885</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku6 -ext KU=cs"</span>);   <em class="jxr_comment">// cRLSign cannot be cs</em>
<a class="jxr_linenumber" name="L886" href="#L886">886</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku11 -ext KU=nr"</span>);
<a class="jxr_linenumber" name="L887" href="#L887">887</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku12 -ext KU=ke"</span>);  <em class="jxr_comment">// ke also means keyAgreement</em>
<a class="jxr_linenumber" name="L888" href="#L888">888</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku12 -ext KU=keyE"</span>);
<a class="jxr_linenumber" name="L889" href="#L889">889</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku13 -ext KU=de"</span>);  <em class="jxr_comment">// de also means decipherOnly</em>
<a class="jxr_linenumber" name="L890" href="#L890">890</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku13 -ext KU=dataE"</span>);
<a class="jxr_linenumber" name="L891" href="#L891">891</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku14 -ext KU=ka"</span>);
<a class="jxr_linenumber" name="L892" href="#L892">892</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku15 -ext KU=kcs"</span>);
<a class="jxr_linenumber" name="L893" href="#L893">893</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku16 -ext KU=crls"</span>);
<a class="jxr_linenumber" name="L894" href="#L894">894</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku17 -ext KU=eo"</span>);
<a class="jxr_linenumber" name="L895" href="#L895">895</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku18 -ext KU=do"</span>);
<a class="jxr_linenumber" name="L896" href="#L896">896</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku19 -ext KU=cc"</span>);
<a class="jxr_linenumber" name="L897" href="#L897">897</a> 
<a class="jxr_linenumber" name="L898" href="#L898">898</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku017 -ext KU=ds,cc,eo"</span>);
<a class="jxr_linenumber" name="L899" href="#L899">899</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku135 -ext KU=nr,dataEncipherment,keyCertSign"</span>);
<a class="jxr_linenumber" name="L900" href="#L900">900</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku246 -ext KU=keyEnc,cRL,keyA"</span>);
<a class="jxr_linenumber" name="L901" href="#L901">901</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"ku1234 -ext KU=ka,da,keyE,nonR"</span>);
<a class="jxr_linenumber" name="L902" href="#L902">902</a> 
<a class="jxr_linenumber" name="L903" href="#L903">903</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L904" href="#L904">904</a>         <strong class="jxr_keyword">class</strong> CheckKU {
<a class="jxr_linenumber" name="L905" href="#L905">905</a>             <strong class="jxr_keyword">void</strong> check(KeyStore ks, String alias, <strong class="jxr_keyword">int</strong>... pos) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L906" href="#L906">906</a>                 System.err.print(<span class="jxr_string">"x"</span>);
<a class="jxr_linenumber" name="L907" href="#L907">907</a>                 <strong class="jxr_keyword">boolean</strong>[] bs = ((X509Certificate)ks.getCertificate(alias)).getKeyUsage();
<a class="jxr_linenumber" name="L908" href="#L908">908</a>                 bs = Arrays.copyOf(bs, 9);
<a class="jxr_linenumber" name="L909" href="#L909">909</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i=0; i&lt;bs.length; i++) {
<a class="jxr_linenumber" name="L910" href="#L910">910</a>                     <strong class="jxr_keyword">boolean</strong> found = false;
<a class="jxr_linenumber" name="L911" href="#L911">911</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> p: pos) {
<a class="jxr_linenumber" name="L912" href="#L912">912</a>                         <strong class="jxr_keyword">if</strong> (p == i) found = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L913" href="#L913">913</a>                     }
<a class="jxr_linenumber" name="L914" href="#L914">914</a>                     <strong class="jxr_keyword">if</strong> (!found ^ bs[i]) {
<a class="jxr_linenumber" name="L915" href="#L915">915</a>                         <em class="jxr_comment">// OK</em>
<a class="jxr_linenumber" name="L916" href="#L916">916</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L917" href="#L917">917</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"KU not match at "</span> + i +
<a class="jxr_linenumber" name="L918" href="#L918">918</a>                                 <span class="jxr_string">": "</span> + found + <span class="jxr_string">" vs "</span> + bs[i]);
<a class="jxr_linenumber" name="L919" href="#L919">919</a>                     }
<a class="jxr_linenumber" name="L920" href="#L920">920</a>                 }
<a class="jxr_linenumber" name="L921" href="#L921">921</a>             }
<a class="jxr_linenumber" name="L922" href="#L922">922</a>         }
<a class="jxr_linenumber" name="L923" href="#L923">923</a>         CheckKU c = <strong class="jxr_keyword">new</strong> CheckKU();
<a class="jxr_linenumber" name="L924" href="#L924">924</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"ku1"</span>)).getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
<a class="jxr_linenumber" name="L925" href="#L925">925</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"ku2"</span>)).getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
<a class="jxr_linenumber" name="L926" href="#L926">926</a>         c.check(ks, <span class="jxr_string">"ku1"</span>, 0);
<a class="jxr_linenumber" name="L927" href="#L927">927</a>         c.check(ks, <span class="jxr_string">"ku2"</span>, 0);
<a class="jxr_linenumber" name="L928" href="#L928">928</a>         c.check(ks, <span class="jxr_string">"ku3"</span>, 0);
<a class="jxr_linenumber" name="L929" href="#L929">929</a>         c.check(ks, <span class="jxr_string">"ku4"</span>, 0);
<a class="jxr_linenumber" name="L930" href="#L930">930</a>         c.check(ks, <span class="jxr_string">"ku11"</span>, 1);
<a class="jxr_linenumber" name="L931" href="#L931">931</a>         c.check(ks, <span class="jxr_string">"ku12"</span>, 2);
<a class="jxr_linenumber" name="L932" href="#L932">932</a>         c.check(ks, <span class="jxr_string">"ku13"</span>, 3);
<a class="jxr_linenumber" name="L933" href="#L933">933</a>         c.check(ks, <span class="jxr_string">"ku14"</span>, 4);
<a class="jxr_linenumber" name="L934" href="#L934">934</a>         c.check(ks, <span class="jxr_string">"ku15"</span>, 5);
<a class="jxr_linenumber" name="L935" href="#L935">935</a>         c.check(ks, <span class="jxr_string">"ku16"</span>, 6);
<a class="jxr_linenumber" name="L936" href="#L936">936</a>         c.check(ks, <span class="jxr_string">"ku17"</span>, 7);
<a class="jxr_linenumber" name="L937" href="#L937">937</a>         c.check(ks, <span class="jxr_string">"ku18"</span>, 8);
<a class="jxr_linenumber" name="L938" href="#L938">938</a>         c.check(ks, <span class="jxr_string">"ku19"</span>, 1);
<a class="jxr_linenumber" name="L939" href="#L939">939</a>         c.check(ks, <span class="jxr_string">"ku11"</span>, 1);
<a class="jxr_linenumber" name="L940" href="#L940">940</a>         c.check(ks, <span class="jxr_string">"ku11"</span>, 1);
<a class="jxr_linenumber" name="L941" href="#L941">941</a>         c.check(ks, <span class="jxr_string">"ku11"</span>, 1);
<a class="jxr_linenumber" name="L942" href="#L942">942</a>         c.check(ks, <span class="jxr_string">"ku017"</span>, 0, 1, 7);
<a class="jxr_linenumber" name="L943" href="#L943">943</a>         c.check(ks, <span class="jxr_string">"ku135"</span>, 1, 3, 5);
<a class="jxr_linenumber" name="L944" href="#L944">944</a>         c.check(ks, <span class="jxr_string">"ku246"</span>, 6, 2, 4);
<a class="jxr_linenumber" name="L945" href="#L945">945</a>         c.check(ks, <span class="jxr_string">"ku1234"</span>, 1, 2, 3, 4);
<a class="jxr_linenumber" name="L946" href="#L946">946</a> 
<a class="jxr_linenumber" name="L947" href="#L947">947</a>         <em class="jxr_comment">// EKU</em>
<a class="jxr_linenumber" name="L948" href="#L948">948</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku1 -ext EKU:critical=sa"</span>);
<a class="jxr_linenumber" name="L949" href="#L949">949</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku2 -ext ExtendedKeyUsage=ca"</span>);
<a class="jxr_linenumber" name="L950" href="#L950">950</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku3 -ext EKU=cs"</span>);
<a class="jxr_linenumber" name="L951" href="#L951">951</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku4 -ext EKU=ep"</span>);
<a class="jxr_linenumber" name="L952" href="#L952">952</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku8 -ext EKU=ts"</span>);
<a class="jxr_linenumber" name="L953" href="#L953">953</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku9 -ext EKU=os"</span>);
<a class="jxr_linenumber" name="L954" href="#L954">954</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku9 -ext EKU=ocsps"</span>);
<a class="jxr_linenumber" name="L955" href="#L955">955</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku10 -ext EKU=any"</span>);
<a class="jxr_linenumber" name="L956" href="#L956">956</a>         testOK(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku11 -ext EKU=1.2.3.4,1.3.5.7,ep"</span>);
<a class="jxr_linenumber" name="L957" href="#L957">957</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku12 -ext EKU=c"</span>);
<a class="jxr_linenumber" name="L958" href="#L958">958</a>         testFail(<span class="jxr_string">""</span>, pre + <span class="jxr_string">"eku12 -ext EKU=nothing"</span>);
<a class="jxr_linenumber" name="L959" href="#L959">959</a> 
<a class="jxr_linenumber" name="L960" href="#L960">960</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L961" href="#L961">961</a>         <strong class="jxr_keyword">class</strong> CheckEKU {
<a class="jxr_linenumber" name="L962" href="#L962">962</a>             <strong class="jxr_keyword">void</strong> check(KeyStore ks, String alias, String... pos) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L963" href="#L963">963</a>                 System.err.print(<span class="jxr_string">"x"</span>);
<a class="jxr_linenumber" name="L964" href="#L964">964</a>                 List&lt;String&gt; bs = ((X509Certificate)ks.getCertificate(alias)).getExtendedKeyUsage();
<a class="jxr_linenumber" name="L965" href="#L965">965</a>                 <strong class="jxr_keyword">int</strong> found = 0;
<a class="jxr_linenumber" name="L966" href="#L966">966</a>                 <strong class="jxr_keyword">for</strong> (String p: pos) {
<a class="jxr_linenumber" name="L967" href="#L967">967</a>                     <strong class="jxr_keyword">if</strong> (bs.contains(p)) {
<a class="jxr_linenumber" name="L968" href="#L968">968</a>                         found++;
<a class="jxr_linenumber" name="L969" href="#L969">969</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L970" href="#L970">970</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"EKU: not included "</span> + p);
<a class="jxr_linenumber" name="L971" href="#L971">971</a>                     }
<a class="jxr_linenumber" name="L972" href="#L972">972</a>                 }
<a class="jxr_linenumber" name="L973" href="#L973">973</a>                 <strong class="jxr_keyword">if</strong> (found != bs.size()) {
<a class="jxr_linenumber" name="L974" href="#L974">974</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"EKU: more items than expected"</span>);
<a class="jxr_linenumber" name="L975" href="#L975">975</a>                 }
<a class="jxr_linenumber" name="L976" href="#L976">976</a>             }
<a class="jxr_linenumber" name="L977" href="#L977">977</a>         }
<a class="jxr_linenumber" name="L978" href="#L978">978</a>         CheckEKU cx = <strong class="jxr_keyword">new</strong> CheckEKU();
<a class="jxr_linenumber" name="L979" href="#L979">979</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"eku1"</span>)).getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
<a class="jxr_linenumber" name="L980" href="#L980">980</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"eku2"</span>)).getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
<a class="jxr_linenumber" name="L981" href="#L981">981</a>         cx.check(ks, <span class="jxr_string">"eku1"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.1"</span>);
<a class="jxr_linenumber" name="L982" href="#L982">982</a>         cx.check(ks, <span class="jxr_string">"eku2"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.2"</span>);
<a class="jxr_linenumber" name="L983" href="#L983">983</a>         cx.check(ks, <span class="jxr_string">"eku3"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.3"</span>);
<a class="jxr_linenumber" name="L984" href="#L984">984</a>         cx.check(ks, <span class="jxr_string">"eku4"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.4"</span>);
<a class="jxr_linenumber" name="L985" href="#L985">985</a>         cx.check(ks, <span class="jxr_string">"eku8"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.8"</span>);
<a class="jxr_linenumber" name="L986" href="#L986">986</a>         cx.check(ks, <span class="jxr_string">"eku9"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.9"</span>);
<a class="jxr_linenumber" name="L987" href="#L987">987</a>         cx.check(ks, <span class="jxr_string">"eku10"</span>, <span class="jxr_string">"2.5.29.37.0"</span>);
<a class="jxr_linenumber" name="L988" href="#L988">988</a>         cx.check(ks, <span class="jxr_string">"eku11"</span>, <span class="jxr_string">"1.3.6.1.5.5.7.3.4"</span>, <span class="jxr_string">"1.2.3.4"</span>, <span class="jxr_string">"1.3.5.7"</span>);
<a class="jxr_linenumber" name="L989" href="#L989">989</a> 
<a class="jxr_linenumber" name="L990" href="#L990">990</a>         <em class="jxr_comment">// SAN</em>
<a class="jxr_linenumber" name="L991" href="#L991">991</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san1 -ext san:critical=email:me@me.org"</span>);
<a class="jxr_linenumber" name="L992" href="#L992">992</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san2 -ext san=uri:http://me.org"</span>);
<a class="jxr_linenumber" name="L993" href="#L993">993</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san3 -ext san=dns:me.org"</span>);
<a class="jxr_linenumber" name="L994" href="#L994">994</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san4 -ext san=ip:192.168.0.1"</span>);
<a class="jxr_linenumber" name="L995" href="#L995">995</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san5 -ext san=oid:1.2.3.4"</span>);
<a class="jxr_linenumber" name="L996" href="#L996">996</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"san235 -ext san=uri:http://me.org,dns:me.org,oid:1.2.3.4"</span>);
<a class="jxr_linenumber" name="L997" href="#L997">997</a> 
<a class="jxr_linenumber" name="L998" href="#L998">998</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L999" href="#L999">999</a>         <strong class="jxr_keyword">class</strong> CheckSAN {
<a class="jxr_linenumber" name="L1000" href="#L1000">1000</a>             <em class="jxr_comment">// Please sort items with name type</em>
<a class="jxr_linenumber" name="L1001" href="#L1001">1001</a>             <strong class="jxr_keyword">void</strong> check(KeyStore ks, String alias, <strong class="jxr_keyword">int</strong> type, Object... items) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1002" href="#L1002">1002</a>                 <strong class="jxr_keyword">int</strong> pos = 0;
<a class="jxr_linenumber" name="L1003" href="#L1003">1003</a>                 System.err.print(<span class="jxr_string">"x"</span>);
<a class="jxr_linenumber" name="L1004" href="#L1004">1004</a>                 Object[] names = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1005" href="#L1005">1005</a>                 <strong class="jxr_keyword">if</strong> (type == 0) names = ((X509Certificate)ks.getCertificate(alias)).getSubjectAlternativeNames().toArray();
<a class="jxr_linenumber" name="L1006" href="#L1006">1006</a>                 <strong class="jxr_keyword">else</strong> names = ((X509Certificate)ks.getCertificate(alias)).getIssuerAlternativeNames().toArray();
<a class="jxr_linenumber" name="L1007" href="#L1007">1007</a>                 Arrays.sort(names, <strong class="jxr_keyword">new</strong> Comparator() {
<a class="jxr_linenumber" name="L1008" href="#L1008">1008</a>                     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> compare(Object o1, Object o2) {
<a class="jxr_linenumber" name="L1009" href="#L1009">1009</a>                         <strong class="jxr_keyword">int</strong> i1 = (Integer)((List)o1).get(0);
<a class="jxr_linenumber" name="L1010" href="#L1010">1010</a>                         <strong class="jxr_keyword">int</strong> i2 = (Integer)((List)o2).get(0);
<a class="jxr_linenumber" name="L1011" href="#L1011">1011</a>                         <strong class="jxr_keyword">return</strong> i1 - i2;
<a class="jxr_linenumber" name="L1012" href="#L1012">1012</a>                     }
<a class="jxr_linenumber" name="L1013" href="#L1013">1013</a>                 });
<a class="jxr_linenumber" name="L1014" href="#L1014">1014</a>                 <strong class="jxr_keyword">for</strong> (Object o: names) {
<a class="jxr_linenumber" name="L1015" href="#L1015">1015</a>                     List l = (List)o;
<a class="jxr_linenumber" name="L1016" href="#L1016">1016</a>                     <strong class="jxr_keyword">for</strong> (Object o2: l) {
<a class="jxr_linenumber" name="L1017" href="#L1017">1017</a>                         <strong class="jxr_keyword">if</strong> (!items[pos++].equals(o2)) {
<a class="jxr_linenumber" name="L1018" href="#L1018">1018</a>                             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Not equals at "</span> + pos
<a class="jxr_linenumber" name="L1019" href="#L1019">1019</a>                                     + <span class="jxr_string">": "</span> + items[pos-1] + <span class="jxr_string">" vs "</span> + o2);
<a class="jxr_linenumber" name="L1020" href="#L1020">1020</a>                         }
<a class="jxr_linenumber" name="L1021" href="#L1021">1021</a>                     }
<a class="jxr_linenumber" name="L1022" href="#L1022">1022</a>                 }
<a class="jxr_linenumber" name="L1023" href="#L1023">1023</a>                 <strong class="jxr_keyword">if</strong> (pos != items.length) {
<a class="jxr_linenumber" name="L1024" href="#L1024">1024</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Extra items, pos is "</span> + pos);
<a class="jxr_linenumber" name="L1025" href="#L1025">1025</a>                 }
<a class="jxr_linenumber" name="L1026" href="#L1026">1026</a>             }
<a class="jxr_linenumber" name="L1027" href="#L1027">1027</a>         }
<a class="jxr_linenumber" name="L1028" href="#L1028">1028</a>         CheckSAN csan = <strong class="jxr_keyword">new</strong> CheckSAN();
<a class="jxr_linenumber" name="L1029" href="#L1029">1029</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"san1"</span>)).getSubjectAlternativeNameExtension().isCritical());
<a class="jxr_linenumber" name="L1030" href="#L1030">1030</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"san2"</span>)).getSubjectAlternativeNameExtension().isCritical());
<a class="jxr_linenumber" name="L1031" href="#L1031">1031</a>         csan.check(ks, <span class="jxr_string">"san1"</span>, 0, 1, <span class="jxr_string">"me@me.org"</span>);
<a class="jxr_linenumber" name="L1032" href="#L1032">1032</a>         csan.check(ks, <span class="jxr_string">"san2"</span>, 0, 6, <span class="jxr_string">"http://me.org"</span>);
<a class="jxr_linenumber" name="L1033" href="#L1033">1033</a>         csan.check(ks, <span class="jxr_string">"san3"</span>, 0, 2, <span class="jxr_string">"me.org"</span>);
<a class="jxr_linenumber" name="L1034" href="#L1034">1034</a>         csan.check(ks, <span class="jxr_string">"san4"</span>, 0, 7, <span class="jxr_string">"192.168.0.1"</span>);
<a class="jxr_linenumber" name="L1035" href="#L1035">1035</a>         csan.check(ks, <span class="jxr_string">"san5"</span>, 0, 8, <span class="jxr_string">"1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1036" href="#L1036">1036</a>         csan.check(ks, <span class="jxr_string">"san235"</span>, 0, 2, <span class="jxr_string">"me.org"</span>, 6, <span class="jxr_string">"http://me.org"</span>, 8, <span class="jxr_string">"1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1037" href="#L1037">1037</a> 
<a class="jxr_linenumber" name="L1038" href="#L1038">1038</a>         <em class="jxr_comment">// IAN</em>
<a class="jxr_linenumber" name="L1039" href="#L1039">1039</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian1 -ext ian:critical=email:me@me.org"</span>);
<a class="jxr_linenumber" name="L1040" href="#L1040">1040</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian2 -ext ian=uri:http://me.org"</span>);
<a class="jxr_linenumber" name="L1041" href="#L1041">1041</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian3 -ext ian=dns:me.org"</span>);
<a class="jxr_linenumber" name="L1042" href="#L1042">1042</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian4 -ext ian=ip:192.168.0.1"</span>);
<a class="jxr_linenumber" name="L1043" href="#L1043">1043</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian5 -ext ian=oid:1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1044" href="#L1044">1044</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ian235 -ext ian=uri:http://me.org,dns:me.org,oid:1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1045" href="#L1045">1045</a> 
<a class="jxr_linenumber" name="L1046" href="#L1046">1046</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L1047" href="#L1047">1047</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"ian1"</span>)).getIssuerAlternativeNameExtension().isCritical());
<a class="jxr_linenumber" name="L1048" href="#L1048">1048</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"ian2"</span>)).getIssuerAlternativeNameExtension().isCritical());
<a class="jxr_linenumber" name="L1049" href="#L1049">1049</a>         csan.check(ks, <span class="jxr_string">"ian1"</span>, 1, 1, <span class="jxr_string">"me@me.org"</span>);
<a class="jxr_linenumber" name="L1050" href="#L1050">1050</a>         csan.check(ks, <span class="jxr_string">"ian2"</span>, 1, 6, <span class="jxr_string">"http://me.org"</span>);
<a class="jxr_linenumber" name="L1051" href="#L1051">1051</a>         csan.check(ks, <span class="jxr_string">"ian3"</span>, 1, 2, <span class="jxr_string">"me.org"</span>);
<a class="jxr_linenumber" name="L1052" href="#L1052">1052</a>         csan.check(ks, <span class="jxr_string">"ian4"</span>, 1, 7, <span class="jxr_string">"192.168.0.1"</span>);
<a class="jxr_linenumber" name="L1053" href="#L1053">1053</a>         csan.check(ks, <span class="jxr_string">"ian5"</span>, 1, 8, <span class="jxr_string">"1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1054" href="#L1054">1054</a>         csan.check(ks, <span class="jxr_string">"ian235"</span>, 1, 2, <span class="jxr_string">"me.org"</span>, 6, <span class="jxr_string">"http://me.org"</span>, 8, <span class="jxr_string">"1.2.3.4"</span>);
<a class="jxr_linenumber" name="L1055" href="#L1055">1055</a> 
<a class="jxr_linenumber" name="L1056" href="#L1056">1056</a>         <em class="jxr_comment">// SIA</em>
<a class="jxr_linenumber" name="L1057" href="#L1057">1057</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"sia1 -ext sia=care:uri:ldap://ca.com/cn=CA"</span>);
<a class="jxr_linenumber" name="L1058" href="#L1058">1058</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"sia2 -ext sia=ts:email:ts@ca.com"</span>);
<a class="jxr_linenumber" name="L1059" href="#L1059">1059</a>         testFail(<span class="jxr_string">"SIA never critical"</span>, pre+<span class="jxr_string">"sia3 -ext sia:critical=ts:email:ts@ca.com"</span>);
<a class="jxr_linenumber" name="L1060" href="#L1060">1060</a> 
<a class="jxr_linenumber" name="L1061" href="#L1061">1061</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L1062" href="#L1062">1062</a>         <strong class="jxr_keyword">class</strong> CheckSia {
<a class="jxr_linenumber" name="L1063" href="#L1063">1063</a>             <strong class="jxr_keyword">void</strong> check(KeyStore ks, String alias, <strong class="jxr_keyword">int</strong> type, Object... items) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1064" href="#L1064">1064</a>                 <strong class="jxr_keyword">int</strong> pos = 0;
<a class="jxr_linenumber" name="L1065" href="#L1065">1065</a>                 System.err.print(<span class="jxr_string">"x"</span>);
<a class="jxr_linenumber" name="L1066" href="#L1066">1066</a>                 AccessDescription[] ads = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1067" href="#L1067">1067</a>                 <strong class="jxr_keyword">if</strong> (type == 0) {
<a class="jxr_linenumber" name="L1068" href="#L1068">1068</a>                     SubjectInfoAccessExtension siae = (SubjectInfoAccessExtension)((X509CertImpl)ks.getCertificate(alias)).getExtension(PKIXExtensions.SubjectInfoAccess_Id);
<a class="jxr_linenumber" name="L1069" href="#L1069">1069</a>                     ads = siae.getAccessDescriptions().toArray(<strong class="jxr_keyword">new</strong> AccessDescription[0]);
<a class="jxr_linenumber" name="L1070" href="#L1070">1070</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1071" href="#L1071">1071</a>                     AuthorityInfoAccessExtension aiae = (AuthorityInfoAccessExtension)((X509CertImpl)ks.getCertificate(alias)).getExtension(PKIXExtensions.AuthInfoAccess_Id);
<a class="jxr_linenumber" name="L1072" href="#L1072">1072</a>                     ads = aiae.getAccessDescriptions().toArray(<strong class="jxr_keyword">new</strong> AccessDescription[0]);
<a class="jxr_linenumber" name="L1073" href="#L1073">1073</a>                 }
<a class="jxr_linenumber" name="L1074" href="#L1074">1074</a>                 Arrays.sort(ads, <strong class="jxr_keyword">new</strong> Comparator&lt;AccessDescription&gt;() {
<a class="jxr_linenumber" name="L1075" href="#L1075">1075</a>                     @Override
<a class="jxr_linenumber" name="L1076" href="#L1076">1076</a>                     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> compare(AccessDescription o1, AccessDescription o2) {
<a class="jxr_linenumber" name="L1077" href="#L1077">1077</a>                         <strong class="jxr_keyword">return</strong> o1.getAccessMethod().toString().compareTo(o2.getAccessMethod().toString());
<a class="jxr_linenumber" name="L1078" href="#L1078">1078</a>                     }
<a class="jxr_linenumber" name="L1079" href="#L1079">1079</a>                 });
<a class="jxr_linenumber" name="L1080" href="#L1080">1080</a>                 <strong class="jxr_keyword">for</strong> (AccessDescription ad: ads) {
<a class="jxr_linenumber" name="L1081" href="#L1081">1081</a>                     <strong class="jxr_keyword">if</strong> (!ad.getAccessMethod().equals(items[pos++]) ||
<a class="jxr_linenumber" name="L1082" href="#L1082">1082</a>                             !<strong class="jxr_keyword">new</strong> Integer(ad.getAccessLocation().getType()).equals(items[pos++])) {
<a class="jxr_linenumber" name="L1083" href="#L1083">1083</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Not same type at "</span> + pos);
<a class="jxr_linenumber" name="L1084" href="#L1084">1084</a>                     }
<a class="jxr_linenumber" name="L1085" href="#L1085">1085</a>                     String name = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1086" href="#L1086">1086</a>                     <strong class="jxr_keyword">switch</strong> (ad.getAccessLocation().getType()) {
<a class="jxr_linenumber" name="L1087" href="#L1087">1087</a>                         <strong class="jxr_keyword">case</strong> 1:
<a class="jxr_linenumber" name="L1088" href="#L1088">1088</a>                             name = ((RFC822Name)ad.getAccessLocation().getName()).getName();
<a class="jxr_linenumber" name="L1089" href="#L1089">1089</a>                             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1090" href="#L1090">1090</a>                         <strong class="jxr_keyword">case</strong> 6:
<a class="jxr_linenumber" name="L1091" href="#L1091">1091</a>                             name = ((URIName)ad.getAccessLocation().getName()).getURI().toString();
<a class="jxr_linenumber" name="L1092" href="#L1092">1092</a>                             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1093" href="#L1093">1093</a>                         <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L1094" href="#L1094">1094</a>                             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Not implemented: "</span> + ad);
<a class="jxr_linenumber" name="L1095" href="#L1095">1095</a>                     }
<a class="jxr_linenumber" name="L1096" href="#L1096">1096</a>                     <strong class="jxr_keyword">if</strong> (!name.equals(items[pos++])) {
<a class="jxr_linenumber" name="L1097" href="#L1097">1097</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> Exception(<span class="jxr_string">"Name not same for "</span> + ad + <span class="jxr_string">" at pos "</span> + pos);
<a class="jxr_linenumber" name="L1098" href="#L1098">1098</a>                     }
<a class="jxr_linenumber" name="L1099" href="#L1099">1099</a>                 }
<a class="jxr_linenumber" name="L1100" href="#L1100">1100</a>             }
<a class="jxr_linenumber" name="L1101" href="#L1101">1101</a>         }
<a class="jxr_linenumber" name="L1102" href="#L1102">1102</a>         CheckSia csia = <strong class="jxr_keyword">new</strong> CheckSia();
<a class="jxr_linenumber" name="L1103" href="#L1103">1103</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"sia1"</span>)).getExtension(PKIXExtensions.SubjectInfoAccess_Id).isCritical());
<a class="jxr_linenumber" name="L1104" href="#L1104">1104</a>         csia.check(ks, <span class="jxr_string">"sia1"</span>, 0, AccessDescription.Ad_CAREPOSITORY_Id, 6, <span class="jxr_string">"ldap://ca.com/cn=CA"</span>);
<a class="jxr_linenumber" name="L1105" href="#L1105">1105</a>         csia.check(ks, <span class="jxr_string">"sia2"</span>, 0, AccessDescription.Ad_TIMESTAMPING_Id, 1, <span class="jxr_string">"ts@ca.com"</span>);
<a class="jxr_linenumber" name="L1106" href="#L1106">1106</a> 
<a class="jxr_linenumber" name="L1107" href="#L1107">1107</a>         <em class="jxr_comment">// AIA</em>
<a class="jxr_linenumber" name="L1108" href="#L1108">1108</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"aia1 -ext aia=cai:uri:ldap://ca.com/cn=CA"</span>);
<a class="jxr_linenumber" name="L1109" href="#L1109">1109</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"aia2 -ext aia=ocsp:email:ocsp@ca.com"</span>);
<a class="jxr_linenumber" name="L1110" href="#L1110">1110</a>         testFail(<span class="jxr_string">"AIA never critical"</span>, pre+<span class="jxr_string">"aia3 -ext aia:critical=ts:email:ts@ca.com"</span>);
<a class="jxr_linenumber" name="L1111" href="#L1111">1111</a> 
<a class="jxr_linenumber" name="L1112" href="#L1112">1112</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L1113" href="#L1113">1113</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"aia1"</span>)).getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
<a class="jxr_linenumber" name="L1114" href="#L1114">1114</a>         csia.check(ks, <span class="jxr_string">"aia1"</span>, 1, AccessDescription.Ad_CAISSUERS_Id, 6, <span class="jxr_string">"ldap://ca.com/cn=CA"</span>);
<a class="jxr_linenumber" name="L1115" href="#L1115">1115</a>         csia.check(ks, <span class="jxr_string">"aia2"</span>, 1, AccessDescription.Ad_OCSP_Id, 1, <span class="jxr_string">"ocsp@ca.com"</span>);
<a class="jxr_linenumber" name="L1116" href="#L1116">1116</a> 
<a class="jxr_linenumber" name="L1117" href="#L1117">1117</a>         <em class="jxr_comment">// OID</em>
<a class="jxr_linenumber" name="L1118" href="#L1118">1118</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"oid1 -ext 1.2.3:critical=0102"</span>);
<a class="jxr_linenumber" name="L1119" href="#L1119">1119</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"oid2 -ext 1.2.3"</span>);
<a class="jxr_linenumber" name="L1120" href="#L1120">1120</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"oid12 -ext 1.2.3 -ext 1.2.4=01:02:03"</span>);
<a class="jxr_linenumber" name="L1121" href="#L1121">1121</a> 
<a class="jxr_linenumber" name="L1122" href="#L1122">1122</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L1123" href="#L1123">1123</a>         <strong class="jxr_keyword">class</strong> CheckOid {
<a class="jxr_linenumber" name="L1124" href="#L1124">1124</a>             <strong class="jxr_keyword">void</strong> check(KeyStore ks, String alias, String oid, byte[] value) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1125" href="#L1125">1125</a>                 <strong class="jxr_keyword">int</strong> pos = 0;
<a class="jxr_linenumber" name="L1126" href="#L1126">1126</a>                 System.err.print(<span class="jxr_string">"x"</span>);
<a class="jxr_linenumber" name="L1127" href="#L1127">1127</a>                 Extension ex = ((X509CertImpl)ks.getCertificate(alias)).getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(oid));
<a class="jxr_linenumber" name="L1128" href="#L1128">1128</a>                 <strong class="jxr_keyword">if</strong> (!Arrays.equals(value, ex.getValue())) {
<a class="jxr_linenumber" name="L1129" href="#L1129">1129</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Not same content in "</span> + alias + <span class="jxr_string">" for "</span> + oid);
<a class="jxr_linenumber" name="L1130" href="#L1130">1130</a>                 }
<a class="jxr_linenumber" name="L1131" href="#L1131">1131</a>             }
<a class="jxr_linenumber" name="L1132" href="#L1132">1132</a>         }
<a class="jxr_linenumber" name="L1133" href="#L1133">1133</a>         CheckOid coid = <strong class="jxr_keyword">new</strong> CheckOid();
<a class="jxr_linenumber" name="L1134" href="#L1134">1134</a>         assertTrue(((X509CertImpl)ks.getCertificate(<span class="jxr_string">"oid1"</span>)).getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"1.2.3"</span>)).isCritical());
<a class="jxr_linenumber" name="L1135" href="#L1135">1135</a>         assertTrue(!((X509CertImpl)ks.getCertificate(<span class="jxr_string">"oid2"</span>)).getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"1.2.3"</span>)).isCritical());
<a class="jxr_linenumber" name="L1136" href="#L1136">1136</a>         coid.check(ks, <span class="jxr_string">"oid1"</span>, <span class="jxr_string">"1.2.3"</span>, <strong class="jxr_keyword">new</strong> byte[]{1,2});
<a class="jxr_linenumber" name="L1137" href="#L1137">1137</a>         coid.check(ks, <span class="jxr_string">"oid2"</span>, <span class="jxr_string">"1.2.3"</span>, <strong class="jxr_keyword">new</strong> byte[]{});
<a class="jxr_linenumber" name="L1138" href="#L1138">1138</a>         coid.check(ks, <span class="jxr_string">"oid12"</span>, <span class="jxr_string">"1.2.3"</span>, <strong class="jxr_keyword">new</strong> byte[]{});
<a class="jxr_linenumber" name="L1139" href="#L1139">1139</a>         coid.check(ks, <span class="jxr_string">"oid12"</span>, <span class="jxr_string">"1.2.4"</span>, <strong class="jxr_keyword">new</strong> byte[]{1,2,3});
<a class="jxr_linenumber" name="L1140" href="#L1140">1140</a> 
<a class="jxr_linenumber" name="L1141" href="#L1141">1141</a>         <em class="jxr_comment">// honored</em>
<a class="jxr_linenumber" name="L1142" href="#L1142">1142</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"ca"</span>);
<a class="jxr_linenumber" name="L1143" href="#L1143">1143</a>         testOK(<span class="jxr_string">""</span>, pre+<span class="jxr_string">"a"</span>);
<a class="jxr_linenumber" name="L1144" href="#L1144">1144</a>         <em class="jxr_comment">// request: BC,KU,1.2.3,1.2.4,1.2.5</em>
<a class="jxr_linenumber" name="L1145" href="#L1145">1145</a>         testOK(<span class="jxr_string">""</span>, simple+<span class="jxr_string">"-alias a -certreq "</span> +
<a class="jxr_linenumber" name="L1146" href="#L1146">1146</a>                 <span class="jxr_string">"-ext BC=1 -ext KU=crl "</span> +
<a class="jxr_linenumber" name="L1147" href="#L1147">1147</a>                 <span class="jxr_string">"-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 "</span> +
<a class="jxr_linenumber" name="L1148" href="#L1148">1148</a>                 <span class="jxr_string">"-rfc -file test.req"</span>);
<a class="jxr_linenumber" name="L1149" href="#L1149">1149</a>         <em class="jxr_comment">// printcertreq</em>
<a class="jxr_linenumber" name="L1150" href="#L1150">1150</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcertreq -file test.req"</span>);
<a class="jxr_linenumber" name="L1151" href="#L1151">1151</a>         <em class="jxr_comment">// issue: deny KU, change criticality of 1.2.3 and 1.2.4, change content of BC, add 2.3.4</em>
<a class="jxr_linenumber" name="L1152" href="#L1152">1152</a>         testOK(<span class="jxr_string">""</span>, simple+<span class="jxr_string">"-gencert -alias ca -infile test.req -ext "</span> +
<a class="jxr_linenumber" name="L1153" href="#L1153">1153</a>                 <span class="jxr_string">"honored=all,-KU,1.2.3:critical,1.2.4:non-critical "</span> +
<a class="jxr_linenumber" name="L1154" href="#L1154">1154</a>                 <span class="jxr_string">"-ext BC=2 -ext 2.3.4=01020304 "</span> +
<a class="jxr_linenumber" name="L1155" href="#L1155">1155</a>                 <span class="jxr_string">"-debug -rfc -outfile test.cert"</span>);
<a class="jxr_linenumber" name="L1156" href="#L1156">1156</a>         testOK(<span class="jxr_string">""</span>, simple+<span class="jxr_string">"-importcert -file test.cert -alias a"</span>);
<a class="jxr_linenumber" name="L1157" href="#L1157">1157</a>         ks = loadStore(<span class="jxr_string">"x.jks"</span>, <span class="jxr_string">"changeit"</span>, <span class="jxr_string">"JKS"</span>);
<a class="jxr_linenumber" name="L1158" href="#L1158">1158</a>         X509CertImpl a = (X509CertImpl)ks.getCertificate(<span class="jxr_string">"a"</span>);
<a class="jxr_linenumber" name="L1159" href="#L1159">1159</a>         assertTrue(a.getAuthorityKeyIdentifierExtension() != <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1160" href="#L1160">1160</a>         assertTrue(a.getSubjectKeyIdentifierExtension() != <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1161" href="#L1161">1161</a>         assertTrue(a.getKeyUsage() == <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1162" href="#L1162">1162</a>         assertTrue(a.getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"1.2.3"</span>)).isCritical());
<a class="jxr_linenumber" name="L1163" href="#L1163">1163</a>         assertTrue(!a.getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"1.2.4"</span>)).isCritical());
<a class="jxr_linenumber" name="L1164" href="#L1164">1164</a>         assertTrue(!a.getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"1.2.5"</span>)).isCritical());
<a class="jxr_linenumber" name="L1165" href="#L1165">1165</a>         assertTrue(a.getExtensionValue(<span class="jxr_string">"1.2.3"</span>).length == 3);
<a class="jxr_linenumber" name="L1166" href="#L1166">1166</a>         assertTrue(a.getExtensionValue(<span class="jxr_string">"1.2.4"</span>).length == 4);
<a class="jxr_linenumber" name="L1167" href="#L1167">1167</a>         assertTrue(a.getExtensionValue(<span class="jxr_string">"1.2.5"</span>).length == 5);
<a class="jxr_linenumber" name="L1168" href="#L1168">1168</a>         assertTrue(a.getBasicConstraints() == 2);
<a class="jxr_linenumber" name="L1169" href="#L1169">1169</a>         assertTrue(!a.getExtension(<strong class="jxr_keyword">new</strong> ObjectIdentifier(<span class="jxr_string">"2.3.4"</span>)).isCritical());
<a class="jxr_linenumber" name="L1170" href="#L1170">1170</a>         assertTrue(a.getExtensionValue(<span class="jxr_string">"2.3.4"</span>).length == 6);
<a class="jxr_linenumber" name="L1171" href="#L1171">1171</a> 
<a class="jxr_linenumber" name="L1172" href="#L1172">1172</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L1173" href="#L1173">1173</a>         remove(<span class="jxr_string">"test.req"</span>);
<a class="jxr_linenumber" name="L1174" href="#L1174">1174</a>         remove(<span class="jxr_string">"test.cert"</span>);
<a class="jxr_linenumber" name="L1175" href="#L1175">1175</a>     }
<a class="jxr_linenumber" name="L1176" href="#L1176">1176</a> 
<a class="jxr_linenumber" name="L1177" href="#L1177">1177</a>     <strong class="jxr_keyword">void</strong> i18nTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1178" href="#L1178">1178</a>         <em class="jxr_comment">//   1.  keytool -help</em>
<a class="jxr_linenumber" name="L1179" href="#L1179">1179</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L1180" href="#L1180">1180</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-help"</span>);
<a class="jxr_linenumber" name="L1181" href="#L1181">1181</a> 
<a class="jxr_linenumber" name="L1182" href="#L1182">1182</a>         <em class="jxr_comment">//   2. keytool -genkey -v -keysize 512 Enter "a" for the keystore password. Check error (password too short). Enter "password" for the keystore password. Hit 'return' for "first and last name", "organizational unit", "City", "State", and "Country Code". Type "yes" when they ask you if everything is correct. Type 'return' for new key password.</em>
<a class="jxr_linenumber" name="L1183" href="#L1183">1183</a>         testOK(<span class="jxr_string">"a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n"</span>, <span class="jxr_string">"-genkey -v -keysize 512 -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1184" href="#L1184">1184</a>         <em class="jxr_comment">//   3. keytool -list -v -storepass password</em>
<a class="jxr_linenumber" name="L1185" href="#L1185">1185</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-list -v -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1186" href="#L1186">1186</a>         <em class="jxr_comment">//   4. keytool -list -v Type "a" for the keystore password. Check error (wrong keystore password).</em>
<a class="jxr_linenumber" name="L1187" href="#L1187">1187</a>         testFail(<span class="jxr_string">"a\n"</span>, <span class="jxr_string">"-list -v -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1188" href="#L1188">1188</a>         assertTrue(ex.indexOf(<span class="jxr_string">"password was incorrect"</span>) != -1);
<a class="jxr_linenumber" name="L1189" href="#L1189">1189</a>         <em class="jxr_comment">//   5. keytool -genkey -v -keysize 512 Enter "password" as the password. Check error (alias 'mykey' already exists).</em>
<a class="jxr_linenumber" name="L1190" href="#L1190">1190</a>         testFail(<span class="jxr_string">"password\n"</span>, <span class="jxr_string">"-genkey -v -keysize 512 -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1191" href="#L1191">1191</a>         assertTrue(ex.indexOf(<span class="jxr_string">"alias &lt;mykey&gt; already exists"</span>) != -1);
<a class="jxr_linenumber" name="L1192" href="#L1192">1192</a>         <em class="jxr_comment">//   6. keytool -genkey -v -keysize 512 -alias mykey2 -storepass password Hit 'return' for "first and last name", "organizational unit", "City", "State", and "Country Code". Type "yes" when they ask you if everything is correct. Type 'return' for new key password.</em>
<a class="jxr_linenumber" name="L1193" href="#L1193">1193</a>         testOK(<span class="jxr_string">"\n\n\n\n\n\nyes\n\n"</span>, <span class="jxr_string">"-genkey -v -keysize 512 -alias mykey2 -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1194" href="#L1194">1194</a>         <em class="jxr_comment">//   7. keytool -list -v Type 'password' for the store password.</em>
<a class="jxr_linenumber" name="L1195" href="#L1195">1195</a>         testOK(<span class="jxr_string">"password\n"</span>, <span class="jxr_string">"-list -v -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1196" href="#L1196">1196</a>         <em class="jxr_comment">//   8. keytool -keypasswd -v -alias mykey2 -storepass password Type "a" for the new key password. Type "aaaaaa" for the new key password. Type "bbbbbb" when re-entering the new key password. Type "a" for the new key password. Check Error (too many failures).</em>
<a class="jxr_linenumber" name="L1197" href="#L1197">1197</a>         testFail(<span class="jxr_string">"a\naaaaaa\nbbbbbb\na\n"</span>, <span class="jxr_string">"-keypasswd -v -alias mykey2 -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1198" href="#L1198">1198</a>         assertTrue(ex.indexOf(<span class="jxr_string">"Too many failures - try later"</span>) != -1);
<a class="jxr_linenumber" name="L1199" href="#L1199">1199</a>         <em class="jxr_comment">//   9. keytool -keypasswd -v -alias mykey2 -storepass password Type "aaaaaa" for the new key password. Type "aaaaaa" when re-entering the new key password.</em>
<a class="jxr_linenumber" name="L1200" href="#L1200">1200</a>         testOK(<span class="jxr_string">"aaaaaa\naaaaaa\n"</span>, <span class="jxr_string">"-keypasswd -v -alias mykey2 -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1201" href="#L1201">1201</a>         <em class="jxr_comment">//  10. keytool -selfcert -v -alias mykey -storepass password</em>
<a class="jxr_linenumber" name="L1202" href="#L1202">1202</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-selfcert -v -alias mykey -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1203" href="#L1203">1203</a>         <em class="jxr_comment">//  11. keytool -list -v -storepass password</em>
<a class="jxr_linenumber" name="L1204" href="#L1204">1204</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-list -v -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1205" href="#L1205">1205</a>         <em class="jxr_comment">//  12. keytool -export -v -alias mykey -file cert -storepass password</em>
<a class="jxr_linenumber" name="L1206" href="#L1206">1206</a>         remove(<span class="jxr_string">"cert"</span>);
<a class="jxr_linenumber" name="L1207" href="#L1207">1207</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-export -v -alias mykey -file cert -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1208" href="#L1208">1208</a>         <em class="jxr_comment">//  13. keytool -import -v -file cert -storepass password Check error (Certificate reply and cert are the same)</em>
<a class="jxr_linenumber" name="L1209" href="#L1209">1209</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-import -v -file cert -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1210" href="#L1210">1210</a>         assertTrue(ex.indexOf(<span class="jxr_string">"Certificate reply and certificate in keystore are identical"</span>) != -1);
<a class="jxr_linenumber" name="L1211" href="#L1211">1211</a>         <em class="jxr_comment">//  14. keytool -printcert -file cert</em>
<a class="jxr_linenumber" name="L1212" href="#L1212">1212</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcert -file cert -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1213" href="#L1213">1213</a>         remove(<span class="jxr_string">"cert"</span>);
<a class="jxr_linenumber" name="L1214" href="#L1214">1214</a>         <em class="jxr_comment">//  15. keytool -list -storepass password -provider sun.security.provider.Sun</em>
<a class="jxr_linenumber" name="L1215" href="#L1215">1215</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-list -storepass password -provider sun.security.provider.Sun -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1216" href="#L1216">1216</a> 
<a class="jxr_linenumber" name="L1217" href="#L1217">1217</a>         <em class="jxr_comment">//Error tests</em>
<a class="jxr_linenumber" name="L1218" href="#L1218">1218</a> 
<a class="jxr_linenumber" name="L1219" href="#L1219">1219</a>         <em class="jxr_comment">//   1. keytool -storepasswd -storepass password -new abc Check error (password too short)</em>
<a class="jxr_linenumber" name="L1220" href="#L1220">1220</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -storepass password -new abc"</span>);
<a class="jxr_linenumber" name="L1221" href="#L1221">1221</a>         assertTrue(ex.indexOf(<span class="jxr_string">"New password must be at least 6 characters"</span>) != -1);
<a class="jxr_linenumber" name="L1222" href="#L1222">1222</a>         <em class="jxr_comment">// Changed, no NONE needed now</em>
<a class="jxr_linenumber" name="L1223" href="#L1223">1223</a>         <em class="jxr_comment">//   2. keytool -list -storetype PKCS11 Check error (-keystore must be NONE)</em>
<a class="jxr_linenumber" name="L1224" href="#L1224">1224</a>         <em class="jxr_comment">//testFail("", "-list -storetype PKCS11");</em>
<a class="jxr_linenumber" name="L1225" href="#L1225">1225</a>         <em class="jxr_comment">//assertTrue(err.indexOf("keystore must be NONE") != -1);</em>
<a class="jxr_linenumber" name="L1226" href="#L1226">1226</a>         <em class="jxr_comment">//   3. keytool -storepasswd -storetype PKCS11 -keystore NONE Check error (unsupported operation)</em>
<a class="jxr_linenumber" name="L1227" href="#L1227">1227</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-storepasswd -storetype PKCS11 -keystore NONE"</span>);
<a class="jxr_linenumber" name="L1228" href="#L1228">1228</a>         assertTrue(ex.indexOf(<span class="jxr_string">"UnsupportedOperationException"</span>) != -1);
<a class="jxr_linenumber" name="L1229" href="#L1229">1229</a>         <em class="jxr_comment">//   4. keytool -keypasswd -storetype PKCS11 -keystore NONE Check error (unsupported operation)</em>
<a class="jxr_linenumber" name="L1230" href="#L1230">1230</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keypasswd -storetype PKCS11 -keystore NONE"</span>);
<a class="jxr_linenumber" name="L1231" href="#L1231">1231</a>         assertTrue(ex.indexOf(<span class="jxr_string">"UnsupportedOperationException"</span>) != -1);
<a class="jxr_linenumber" name="L1232" href="#L1232">1232</a>         <em class="jxr_comment">//   5. keytool -list -protected -storepass password Check error (password can not be specified with -protected)</em>
<a class="jxr_linenumber" name="L1233" href="#L1233">1233</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-list -protected -storepass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1234" href="#L1234">1234</a>         assertTrue(ex.indexOf(<span class="jxr_string">"if -protected is specified, then"</span>) != -1);
<a class="jxr_linenumber" name="L1235" href="#L1235">1235</a>         <em class="jxr_comment">//   6. keytool -keypasswd -protected -keypass password Check error (password can not be specified with -protected)</em>
<a class="jxr_linenumber" name="L1236" href="#L1236">1236</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keypasswd -protected -keypass password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1237" href="#L1237">1237</a>         assertTrue(ex.indexOf(<span class="jxr_string">"if -protected is specified, then"</span>) != -1);
<a class="jxr_linenumber" name="L1238" href="#L1238">1238</a>         <em class="jxr_comment">//   7. keytool -keypasswd -protected -new password Check error (password can not be specified with -protected)</em>
<a class="jxr_linenumber" name="L1239" href="#L1239">1239</a>         testFail(<span class="jxr_string">""</span>, <span class="jxr_string">"-keypasswd -protected -new password -keystore x.jks"</span>);
<a class="jxr_linenumber" name="L1240" href="#L1240">1240</a>         assertTrue(ex.indexOf(<span class="jxr_string">"if -protected is specified, then"</span>) != -1);
<a class="jxr_linenumber" name="L1241" href="#L1241">1241</a>         remove(<span class="jxr_string">"x.jks"</span>);
<a class="jxr_linenumber" name="L1242" href="#L1242">1242</a>     }
<a class="jxr_linenumber" name="L1243" href="#L1243">1243</a> 
<a class="jxr_linenumber" name="L1244" href="#L1244">1244</a>     <strong class="jxr_keyword">void</strong> i18nPKCS11Test() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1245" href="#L1245">1245</a>         <em class="jxr_comment">//PKCS#11 tests</em>
<a class="jxr_linenumber" name="L1246" href="#L1246">1246</a> 
<a class="jxr_linenumber" name="L1247" href="#L1247">1247</a>         <em class="jxr_comment">//   1. sccs edit cert8.db key3.db</em>
<a class="jxr_linenumber" name="L1248" href="#L1248">1248</a>         <em class="jxr_comment">//Runtime.getRuntime().exec("/usr/ccs/bin/sccs edit cert8.db key3.db");</em>
<a class="jxr_linenumber" name="L1249" href="#L1249">1249</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -genkey -alias genkey -dname cn=genkey -keysize 512 -keyalg rsa"</span>);
<a class="jxr_linenumber" name="L1250" href="#L1250">1250</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L1251" href="#L1251">1251</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias genkey"</span>);
<a class="jxr_linenumber" name="L1252" href="#L1252">1252</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -certreq -alias genkey -file genkey.certreq"</span>);
<a class="jxr_linenumber" name="L1253" href="#L1253">1253</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -export -alias genkey -file genkey.cert"</span>);
<a class="jxr_linenumber" name="L1254" href="#L1254">1254</a>         testOK(<span class="jxr_string">""</span>, <span class="jxr_string">"-printcert -file genkey.cert"</span>);
<a class="jxr_linenumber" name="L1255" href="#L1255">1255</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -selfcert -alias genkey -dname cn=selfCert"</span>);
<a class="jxr_linenumber" name="L1256" href="#L1256">1256</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list -alias genkey -v"</span>);
<a class="jxr_linenumber" name="L1257" href="#L1257">1257</a>         assertTrue(out.indexOf(<span class="jxr_string">"Owner: CN=selfCert"</span>) != -1);
<a class="jxr_linenumber" name="L1258" href="#L1258">1258</a>         <em class="jxr_comment">//(check that cert subject DN is [cn=selfCert])</em>
<a class="jxr_linenumber" name="L1259" href="#L1259">1259</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -delete -alias genkey"</span>);
<a class="jxr_linenumber" name="L1260" href="#L1260">1260</a>         testOK(<span class="jxr_string">""</span>, p11Arg + <span class="jxr_string">"-storepass test12 -list"</span>);
<a class="jxr_linenumber" name="L1261" href="#L1261">1261</a>         assertTrue(out.indexOf(<span class="jxr_string">"Your keystore contains 0 entries"</span>) != -1);
<a class="jxr_linenumber" name="L1262" href="#L1262">1262</a>         <em class="jxr_comment">//(check for empty database listing)</em>
<a class="jxr_linenumber" name="L1263" href="#L1263">1263</a>         <em class="jxr_comment">//Runtime.getRuntime().exec("/usr/ccs/bin/sccs unedit cert8.db key3.db");</em>
<a class="jxr_linenumber" name="L1264" href="#L1264">1264</a>         remove(<span class="jxr_string">"genkey.cert"</span>);
<a class="jxr_linenumber" name="L1265" href="#L1265">1265</a>         remove(<span class="jxr_string">"genkey.certreq"</span>);
<a class="jxr_linenumber" name="L1266" href="#L1266">1266</a>         <em class="jxr_comment">//  12. sccs unedit cert8.db key3.db</em>
<a class="jxr_linenumber" name="L1267" href="#L1267">1267</a>     }
<a class="jxr_linenumber" name="L1268" href="#L1268">1268</a> 
<a class="jxr_linenumber" name="L1269" href="#L1269">1269</a>     <em class="jxr_comment">// tesing new option -srcProviderName</em>
<a class="jxr_linenumber" name="L1270" href="#L1270">1270</a>     <strong class="jxr_keyword">void</strong> sszzTest() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1271" href="#L1271">1271</a>         testAnyway(<span class="jxr_string">""</span>, NSS_P11_ARG+<span class="jxr_string">"-delete -alias nss -storepass test12"</span>);
<a class="jxr_linenumber" name="L1272" href="#L1272">1272</a>         testAnyway(<span class="jxr_string">""</span>, NZZ_P11_ARG+<span class="jxr_string">"-delete -alias nss -storepass test12"</span>);
<a class="jxr_linenumber" name="L1273" href="#L1273">1273</a>         testOK(<span class="jxr_string">""</span>, NSS_P11_ARG+<span class="jxr_string">"-genkeypair -dname CN=NSS -alias nss -storepass test12"</span>);
<a class="jxr_linenumber" name="L1274" href="#L1274">1274</a>         testOK(<span class="jxr_string">""</span>, NSS_SRC_P11_ARG + NZZ_P11_ARG +
<a class="jxr_linenumber" name="L1275" href="#L1275">1275</a>                 <span class="jxr_string">"-importkeystore -srcstorepass test12 -deststorepass test12"</span>);
<a class="jxr_linenumber" name="L1276" href="#L1276">1276</a>         testAnyway(<span class="jxr_string">""</span>, NSS_P11_ARG+<span class="jxr_string">"-delete -alias nss -storepass test12"</span>);
<a class="jxr_linenumber" name="L1277" href="#L1277">1277</a>         testAnyway(<span class="jxr_string">""</span>, NZZ_P11_ARG+<span class="jxr_string">"-delete -alias nss -storepass test12"</span>);
<a class="jxr_linenumber" name="L1278" href="#L1278">1278</a>     }
<a class="jxr_linenumber" name="L1279" href="#L1279">1279</a> 
<a class="jxr_linenumber" name="L1280" href="#L1280">1280</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> main(String[] args) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1281" href="#L1281">1281</a>         <em class="jxr_comment">// first test if HumanInputStream really acts like a human being</em>
<a class="jxr_linenumber" name="L1282" href="#L1282">1282</a>         HumanInputStream.test();
<a class="jxr_linenumber" name="L1283" href="#L1283">1283</a>         KeyToolTest t = <strong class="jxr_keyword">new</strong> KeyToolTest();
<a class="jxr_linenumber" name="L1284" href="#L1284">1284</a> 
<a class="jxr_linenumber" name="L1285" href="#L1285">1285</a>         <strong class="jxr_keyword">if</strong> (System.getProperty(<span class="jxr_string">"file"</span>) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1286" href="#L1286">1286</a>             t.sqeTest();
<a class="jxr_linenumber" name="L1287" href="#L1287">1287</a>             t.testAll();
<a class="jxr_linenumber" name="L1288" href="#L1288">1288</a>             t.i18nTest();
<a class="jxr_linenumber" name="L1289" href="#L1289">1289</a>             t.v3extTest(<span class="jxr_string">"RSA"</span>);
<a class="jxr_linenumber" name="L1290" href="#L1290">1290</a>             t.v3extTest(<span class="jxr_string">"DSA"</span>);
<a class="jxr_linenumber" name="L1291" href="#L1291">1291</a>             <strong class="jxr_keyword">boolean</strong> testEC = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1292" href="#L1292">1292</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1293" href="#L1293">1293</a>                 KeyPairGenerator.getInstance(<span class="jxr_string">"EC"</span>);
<a class="jxr_linenumber" name="L1294" href="#L1294">1294</a>             } <strong class="jxr_keyword">catch</strong> (NoSuchAlgorithmException nae) {
<a class="jxr_linenumber" name="L1295" href="#L1295">1295</a>                 testEC = false;
<a class="jxr_linenumber" name="L1296" href="#L1296">1296</a>             }
<a class="jxr_linenumber" name="L1297" href="#L1297">1297</a>             <strong class="jxr_keyword">if</strong> (testEC) t.v3extTest(<span class="jxr_string">"EC"</span>);
<a class="jxr_linenumber" name="L1298" href="#L1298">1298</a>         }
<a class="jxr_linenumber" name="L1299" href="#L1299">1299</a> 
<a class="jxr_linenumber" name="L1300" href="#L1300">1300</a>         <strong class="jxr_keyword">if</strong> (System.getProperty(<span class="jxr_string">"nss"</span>) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1301" href="#L1301">1301</a>             t.srcP11Arg = NSS_SRC_P11_ARG;
<a class="jxr_linenumber" name="L1302" href="#L1302">1302</a>             t.p11Arg = NSS_P11_ARG;
<a class="jxr_linenumber" name="L1303" href="#L1303">1303</a> 
<a class="jxr_linenumber" name="L1304" href="#L1304">1304</a>             t.testPKCS11();
<a class="jxr_linenumber" name="L1305" href="#L1305">1305</a> 
<a class="jxr_linenumber" name="L1306" href="#L1306">1306</a>             <em class="jxr_comment">// FAIL:</em>
<a class="jxr_linenumber" name="L1307" href="#L1307">1307</a>             <em class="jxr_comment">// 1. we still don't have srcprovidername yet</em>
<a class="jxr_linenumber" name="L1308" href="#L1308">1308</a>             <em class="jxr_comment">// 2. cannot store privatekey into NSS keystore</em>
<a class="jxr_linenumber" name="L1309" href="#L1309">1309</a>             <em class="jxr_comment">//    java.security.KeyStoreException: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_TEMPLATE_INCOMPLETE.</em>
<a class="jxr_linenumber" name="L1310" href="#L1310">1310</a>             <em class="jxr_comment">//t.testPKCS11ImportKeyStore();</em>
<a class="jxr_linenumber" name="L1311" href="#L1311">1311</a> 
<a class="jxr_linenumber" name="L1312" href="#L1312">1312</a>             t.i18nPKCS11Test();
<a class="jxr_linenumber" name="L1313" href="#L1313">1313</a>             <em class="jxr_comment">//FAIL: currently PKCS11-NSS does not support 2 NSS KeyStores to be loaded at the same time</em>
<a class="jxr_linenumber" name="L1314" href="#L1314">1314</a>             <em class="jxr_comment">//t.sszzTest();</em>
<a class="jxr_linenumber" name="L1315" href="#L1315">1315</a>         }
<a class="jxr_linenumber" name="L1316" href="#L1316">1316</a> 
<a class="jxr_linenumber" name="L1317" href="#L1317">1317</a>         <strong class="jxr_keyword">if</strong> (System.getProperty(<span class="jxr_string">"solaris"</span>) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1318" href="#L1318">1318</a>             <em class="jxr_comment">// For Solaris Cryptography Framework</em>
<a class="jxr_linenumber" name="L1319" href="#L1319">1319</a>             t.srcP11Arg = SUN_SRC_P11_ARG;
<a class="jxr_linenumber" name="L1320" href="#L1320">1320</a>             t.p11Arg = SUN_P11_ARG;
<a class="jxr_linenumber" name="L1321" href="#L1321">1321</a>             t.testPKCS11();
<a class="jxr_linenumber" name="L1322" href="#L1322">1322</a>             t.testPKCS11ImportKeyStore();
<a class="jxr_linenumber" name="L1323" href="#L1323">1323</a>             t.i18nPKCS11Test();
<a class="jxr_linenumber" name="L1324" href="#L1324">1324</a>         }
<a class="jxr_linenumber" name="L1325" href="#L1325">1325</a> 
<a class="jxr_linenumber" name="L1326" href="#L1326">1326</a>         System.out.println(<span class="jxr_string">"Test pass!!!"</span>);
<a class="jxr_linenumber" name="L1327" href="#L1327">1327</a>     }
<a class="jxr_linenumber" name="L1328" href="#L1328">1328</a> }
<a class="jxr_linenumber" name="L1329" href="#L1329">1329</a> 
<a class="jxr_linenumber" name="L1330" href="#L1330">1330</a> <strong class="jxr_keyword">class</strong> TestException <strong class="jxr_keyword">extends</strong> Exception {
<a class="jxr_linenumber" name="L1331" href="#L1331">1331</a>     <strong class="jxr_keyword">public</strong> TestException(String e) {
<a class="jxr_linenumber" name="L1332" href="#L1332">1332</a>         <strong class="jxr_keyword">super</strong>(e);
<a class="jxr_linenumber" name="L1333" href="#L1333">1333</a>     }
<a class="jxr_linenumber" name="L1334" href="#L1334">1334</a> }
<a class="jxr_linenumber" name="L1335" href="#L1335">1335</a> 
<a class="jxr_linenumber" name="L1336" href="#L1336">1336</a> <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1337" href="#L1337">1337</a> <em class="jxr_javadoccomment"> * HumanInputStream tries to act like a human sitting in front of a computer</em>
<a class="jxr_linenumber" name="L1338" href="#L1338">1338</a> <em class="jxr_javadoccomment"> * terminal typing on the keyboard while the keytool program is running.</em>
<a class="jxr_linenumber" name="L1339" href="#L1339">1339</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L1340" href="#L1340">1340</a> <em class="jxr_javadoccomment"> * keytool has called InputStream.read() and BufferedReader.readLine() in</em>
<a class="jxr_linenumber" name="L1341" href="#L1341">1341</a> <em class="jxr_javadoccomment"> * various places. a call to B.readLine() will try to buffer as much input as</em>
<a class="jxr_linenumber" name="L1342" href="#L1342">1342</a> <em class="jxr_javadoccomment"> * possible. Thus, a trivial InputStream will find it impossible to feed</em>
<a class="jxr_linenumber" name="L1343" href="#L1343">1343</a> <em class="jxr_javadoccomment"> * anything to I.read() after a B.readLine() call.</em>
<a class="jxr_linenumber" name="L1344" href="#L1344">1344</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L1345" href="#L1345">1345</a> <em class="jxr_javadoccomment"> * This is why i create HumanInputStream, which will only send a single line</em>
<a class="jxr_linenumber" name="L1346" href="#L1346">1346</a> <em class="jxr_javadoccomment"> * to B.readLine(), no more, no less, and the next I.read() can have a chance</em>
<a class="jxr_linenumber" name="L1347" href="#L1347">1347</a> <em class="jxr_javadoccomment"> * to read the exact character right after "\n".</em>
<a class="jxr_linenumber" name="L1348" href="#L1348">1348</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L1349" href="#L1349">1349</a> <em class="jxr_javadoccomment"> * I don't know why HumanInputStream works.</em>
<a class="jxr_linenumber" name="L1350" href="#L1350">1350</a> <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L1351" href="#L1351">1351</a> <strong class="jxr_keyword">class</strong> HumanInputStream <strong class="jxr_keyword">extends</strong> InputStream {
<a class="jxr_linenumber" name="L1352" href="#L1352">1352</a>     byte[] src;
<a class="jxr_linenumber" name="L1353" href="#L1353">1353</a>     <strong class="jxr_keyword">int</strong> pos;
<a class="jxr_linenumber" name="L1354" href="#L1354">1354</a>     <strong class="jxr_keyword">int</strong> length;
<a class="jxr_linenumber" name="L1355" href="#L1355">1355</a>     <strong class="jxr_keyword">boolean</strong> inLine;
<a class="jxr_linenumber" name="L1356" href="#L1356">1356</a>     <strong class="jxr_keyword">int</strong> stopIt;
<a class="jxr_linenumber" name="L1357" href="#L1357">1357</a> 
<a class="jxr_linenumber" name="L1358" href="#L1358">1358</a>     <strong class="jxr_keyword">public</strong> HumanInputStream(String input) {
<a class="jxr_linenumber" name="L1359" href="#L1359">1359</a>         src = input.getBytes();
<a class="jxr_linenumber" name="L1360" href="#L1360">1360</a>         pos = 0;
<a class="jxr_linenumber" name="L1361" href="#L1361">1361</a>         length = src.length;
<a class="jxr_linenumber" name="L1362" href="#L1362">1362</a>         stopIt = 0;
<a class="jxr_linenumber" name="L1363" href="#L1363">1363</a>         inLine = false;
<a class="jxr_linenumber" name="L1364" href="#L1364">1364</a>     }
<a class="jxr_linenumber" name="L1365" href="#L1365">1365</a> 
<a class="jxr_linenumber" name="L1366" href="#L1366">1366</a>     <em class="jxr_comment">// the trick: when called through read(byte[], int, int),</em>
<a class="jxr_linenumber" name="L1367" href="#L1367">1367</a>     <em class="jxr_comment">// return -1 twice after "\n"</em>
<a class="jxr_linenumber" name="L1368" href="#L1368">1368</a> 
<a class="jxr_linenumber" name="L1369" href="#L1369">1369</a>     @Override <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> read() <strong class="jxr_keyword">throws</strong> IOException {
<a class="jxr_linenumber" name="L1370" href="#L1370">1370</a>         <strong class="jxr_keyword">int</strong> re;
<a class="jxr_linenumber" name="L1371" href="#L1371">1371</a>         <strong class="jxr_keyword">if</strong>(pos &lt; length) {
<a class="jxr_linenumber" name="L1372" href="#L1372">1372</a>             re = src[pos];
<a class="jxr_linenumber" name="L1373" href="#L1373">1373</a>             <strong class="jxr_keyword">if</strong>(inLine) {
<a class="jxr_linenumber" name="L1374" href="#L1374">1374</a>                 <strong class="jxr_keyword">if</strong>(stopIt &gt; 0) {
<a class="jxr_linenumber" name="L1375" href="#L1375">1375</a>                     stopIt--;
<a class="jxr_linenumber" name="L1376" href="#L1376">1376</a>                     re = -1;
<a class="jxr_linenumber" name="L1377" href="#L1377">1377</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1378" href="#L1378">1378</a>                     <strong class="jxr_keyword">if</strong>(re == '\n') {
<a class="jxr_linenumber" name="L1379" href="#L1379">1379</a>                         stopIt = 2;
<a class="jxr_linenumber" name="L1380" href="#L1380">1380</a>                     }
<a class="jxr_linenumber" name="L1381" href="#L1381">1381</a>                     pos++;
<a class="jxr_linenumber" name="L1382" href="#L1382">1382</a>                 }
<a class="jxr_linenumber" name="L1383" href="#L1383">1383</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1384" href="#L1384">1384</a>                 pos++;
<a class="jxr_linenumber" name="L1385" href="#L1385">1385</a>             }
<a class="jxr_linenumber" name="L1386" href="#L1386">1386</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1387" href="#L1387">1387</a>             re = -1;<em class="jxr_comment">//throw new IOException("NO MORE TO READ");</em>
<a class="jxr_linenumber" name="L1388" href="#L1388">1388</a>         }
<a class="jxr_linenumber" name="L1389" href="#L1389">1389</a>         <em class="jxr_comment">//if (re &lt; 32) System.err.printf("[%02d]", re);</em>
<a class="jxr_linenumber" name="L1390" href="#L1390">1390</a>         <em class="jxr_comment">//else System.err.printf("[%c]", (char)re);</em>
<a class="jxr_linenumber" name="L1391" href="#L1391">1391</a>         <strong class="jxr_keyword">return</strong> re;
<a class="jxr_linenumber" name="L1392" href="#L1392">1392</a>     }
<a class="jxr_linenumber" name="L1393" href="#L1393">1393</a>     @Override <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> read(byte[] buffer, <strong class="jxr_keyword">int</strong> offset, <strong class="jxr_keyword">int</strong> len) {
<a class="jxr_linenumber" name="L1394" href="#L1394">1394</a>         inLine = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1395" href="#L1395">1395</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1396" href="#L1396">1396</a>             <strong class="jxr_keyword">int</strong> re = <strong class="jxr_keyword">super</strong>.read(buffer, offset, len);
<a class="jxr_linenumber" name="L1397" href="#L1397">1397</a>             <strong class="jxr_keyword">return</strong> re;
<a class="jxr_linenumber" name="L1398" href="#L1398">1398</a>         } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L1399" href="#L1399">1399</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"HumanInputStream error"</span>);
<a class="jxr_linenumber" name="L1400" href="#L1400">1400</a>         } <strong class="jxr_keyword">finally</strong> {
<a class="jxr_linenumber" name="L1401" href="#L1401">1401</a>             inLine = false;
<a class="jxr_linenumber" name="L1402" href="#L1402">1402</a>         }
<a class="jxr_linenumber" name="L1403" href="#L1403">1403</a>     }
<a class="jxr_linenumber" name="L1404" href="#L1404">1404</a>     @Override <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> available() {
<a class="jxr_linenumber" name="L1405" href="#L1405">1405</a>         <strong class="jxr_keyword">if</strong>(pos &lt; length) <strong class="jxr_keyword">return</strong> 1;
<a class="jxr_linenumber" name="L1406" href="#L1406">1406</a>         <strong class="jxr_keyword">return</strong> 0;
<a class="jxr_linenumber" name="L1407" href="#L1407">1407</a>     }
<a class="jxr_linenumber" name="L1408" href="#L1408">1408</a> 
<a class="jxr_linenumber" name="L1409" href="#L1409">1409</a>     <em class="jxr_comment">// test part</em>
<a class="jxr_linenumber" name="L1410" href="#L1410">1410</a>     <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> assertTrue(<strong class="jxr_keyword">boolean</strong> bool) {
<a class="jxr_linenumber" name="L1411" href="#L1411">1411</a>         <strong class="jxr_keyword">if</strong>(!bool)
<a class="jxr_linenumber" name="L1412" href="#L1412">1412</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException();
<a class="jxr_linenumber" name="L1413" href="#L1413">1413</a>     }
<a class="jxr_linenumber" name="L1414" href="#L1414">1414</a> 
<a class="jxr_linenumber" name="L1415" href="#L1415">1415</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> test() <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1416" href="#L1416">1416</a> 
<a class="jxr_linenumber" name="L1417" href="#L1417">1417</a>         <strong class="jxr_keyword">class</strong> Tester {
<a class="jxr_linenumber" name="L1418" href="#L1418">1418</a>             HumanInputStream is;
<a class="jxr_linenumber" name="L1419" href="#L1419">1419</a>             BufferedReader reader;
<a class="jxr_linenumber" name="L1420" href="#L1420">1420</a>             Tester(String s) {
<a class="jxr_linenumber" name="L1421" href="#L1421">1421</a>                 is = <strong class="jxr_keyword">new</strong> HumanInputStream(s);
<a class="jxr_linenumber" name="L1422" href="#L1422">1422</a>                 reader = <strong class="jxr_keyword">new</strong> BufferedReader(<strong class="jxr_keyword">new</strong> InputStreamReader(is));
<a class="jxr_linenumber" name="L1423" href="#L1423">1423</a>             }
<a class="jxr_linenumber" name="L1424" href="#L1424">1424</a> 
<a class="jxr_linenumber" name="L1425" href="#L1425">1425</a>             <em class="jxr_comment">// three kinds of test method</em>
<a class="jxr_linenumber" name="L1426" href="#L1426">1426</a>             <em class="jxr_comment">// 1. read byte by byte from InputStream</em>
<a class="jxr_linenumber" name="L1427" href="#L1427">1427</a>             <strong class="jxr_keyword">void</strong> testStreamReadOnce(<strong class="jxr_keyword">int</strong> expection) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1428" href="#L1428">1428</a>                 assertTrue(is.read() == expection);
<a class="jxr_linenumber" name="L1429" href="#L1429">1429</a>             }
<a class="jxr_linenumber" name="L1430" href="#L1430">1430</a>             <strong class="jxr_keyword">void</strong> testStreamReadMany(String expection) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1431" href="#L1431">1431</a>                 <strong class="jxr_keyword">char</strong>[] keys = expection.toCharArray();
<a class="jxr_linenumber" name="L1432" href="#L1432">1432</a>                 <strong class="jxr_keyword">for</strong>(<strong class="jxr_keyword">int</strong> i=0; i&lt;keys.length; i++) {
<a class="jxr_linenumber" name="L1433" href="#L1433">1433</a>                     assertTrue(is.read() == keys[i]);
<a class="jxr_linenumber" name="L1434" href="#L1434">1434</a>                 }
<a class="jxr_linenumber" name="L1435" href="#L1435">1435</a>             }
<a class="jxr_linenumber" name="L1436" href="#L1436">1436</a>             <em class="jxr_comment">// 2. read a line with a newly created Reader</em>
<a class="jxr_linenumber" name="L1437" href="#L1437">1437</a>             <strong class="jxr_keyword">void</strong> testReaderReadline(String expection) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1438" href="#L1438">1438</a>                 String s = <strong class="jxr_keyword">new</strong> BufferedReader(<strong class="jxr_keyword">new</strong> InputStreamReader(is)).readLine();
<a class="jxr_linenumber" name="L1439" href="#L1439">1439</a>                 <strong class="jxr_keyword">if</strong>(s == <strong class="jxr_keyword">null</strong>) assertTrue(expection == <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1440" href="#L1440">1440</a>                 <strong class="jxr_keyword">else</strong> assertTrue(s.equals(expection));
<a class="jxr_linenumber" name="L1441" href="#L1441">1441</a>             }
<a class="jxr_linenumber" name="L1442" href="#L1442">1442</a>             <em class="jxr_comment">// 3. read a line with the old Reader</em>
<a class="jxr_linenumber" name="L1443" href="#L1443">1443</a>             <strong class="jxr_keyword">void</strong> testReaderReadline2(String expection) <strong class="jxr_keyword">throws</strong> Exception  {
<a class="jxr_linenumber" name="L1444" href="#L1444">1444</a>                 String s = reader.readLine();
<a class="jxr_linenumber" name="L1445" href="#L1445">1445</a>                 <strong class="jxr_keyword">if</strong>(s == <strong class="jxr_keyword">null</strong>) assertTrue(expection == <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1446" href="#L1446">1446</a>                 <strong class="jxr_keyword">else</strong> assertTrue(s.equals(expection));
<a class="jxr_linenumber" name="L1447" href="#L1447">1447</a>             }
<a class="jxr_linenumber" name="L1448" href="#L1448">1448</a>         }
<a class="jxr_linenumber" name="L1449" href="#L1449">1449</a> 
<a class="jxr_linenumber" name="L1450" href="#L1450">1450</a>         Tester test;
<a class="jxr_linenumber" name="L1451" href="#L1451">1451</a> 
<a class="jxr_linenumber" name="L1452" href="#L1452">1452</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"111\n222\n\n444\n\n"</span>);
<a class="jxr_linenumber" name="L1453" href="#L1453">1453</a>         test.testReaderReadline(<span class="jxr_string">"111"</span>);
<a class="jxr_linenumber" name="L1454" href="#L1454">1454</a>         test.testReaderReadline(<span class="jxr_string">"222"</span>);
<a class="jxr_linenumber" name="L1455" href="#L1455">1455</a>         test.testReaderReadline(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1456" href="#L1456">1456</a>         test.testReaderReadline(<span class="jxr_string">"444"</span>);
<a class="jxr_linenumber" name="L1457" href="#L1457">1457</a>         test.testReaderReadline(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1458" href="#L1458">1458</a>         test.testReaderReadline(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1459" href="#L1459">1459</a> 
<a class="jxr_linenumber" name="L1460" href="#L1460">1460</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"111\n222\n\n444\n\n"</span>);
<a class="jxr_linenumber" name="L1461" href="#L1461">1461</a>         test.testReaderReadline2(<span class="jxr_string">"111"</span>);
<a class="jxr_linenumber" name="L1462" href="#L1462">1462</a>         test.testReaderReadline2(<span class="jxr_string">"222"</span>);
<a class="jxr_linenumber" name="L1463" href="#L1463">1463</a>         test.testReaderReadline2(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1464" href="#L1464">1464</a>         test.testReaderReadline2(<span class="jxr_string">"444"</span>);
<a class="jxr_linenumber" name="L1465" href="#L1465">1465</a>         test.testReaderReadline2(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1466" href="#L1466">1466</a>         test.testReaderReadline2(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1467" href="#L1467">1467</a> 
<a class="jxr_linenumber" name="L1468" href="#L1468">1468</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"111\n222\n\n444\n\n"</span>);
<a class="jxr_linenumber" name="L1469" href="#L1469">1469</a>         test.testReaderReadline2(<span class="jxr_string">"111"</span>);
<a class="jxr_linenumber" name="L1470" href="#L1470">1470</a>         test.testReaderReadline(<span class="jxr_string">"222"</span>);
<a class="jxr_linenumber" name="L1471" href="#L1471">1471</a>         test.testReaderReadline2(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1472" href="#L1472">1472</a>         test.testReaderReadline2(<span class="jxr_string">"444"</span>);
<a class="jxr_linenumber" name="L1473" href="#L1473">1473</a>         test.testReaderReadline(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L1474" href="#L1474">1474</a>         test.testReaderReadline2(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1475" href="#L1475">1475</a> 
<a class="jxr_linenumber" name="L1476" href="#L1476">1476</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"1\n2"</span>);
<a class="jxr_linenumber" name="L1477" href="#L1477">1477</a>         test.testStreamReadMany(<span class="jxr_string">"1\n2"</span>);
<a class="jxr_linenumber" name="L1478" href="#L1478">1478</a>         test.testStreamReadOnce(-1);
<a class="jxr_linenumber" name="L1479" href="#L1479">1479</a> 
<a class="jxr_linenumber" name="L1480" href="#L1480">1480</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"12\n234"</span>);
<a class="jxr_linenumber" name="L1481" href="#L1481">1481</a>         test.testStreamReadOnce('1');
<a class="jxr_linenumber" name="L1482" href="#L1482">1482</a>         test.testReaderReadline(<span class="jxr_string">"2"</span>);
<a class="jxr_linenumber" name="L1483" href="#L1483">1483</a>         test.testStreamReadOnce('2');
<a class="jxr_linenumber" name="L1484" href="#L1484">1484</a>         test.testReaderReadline2(<span class="jxr_string">"34"</span>);
<a class="jxr_linenumber" name="L1485" href="#L1485">1485</a>         test.testReaderReadline2(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1486" href="#L1486">1486</a> 
<a class="jxr_linenumber" name="L1487" href="#L1487">1487</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"changeit\n"</span>);
<a class="jxr_linenumber" name="L1488" href="#L1488">1488</a>         test.testStreamReadMany(<span class="jxr_string">"changeit\n"</span>);
<a class="jxr_linenumber" name="L1489" href="#L1489">1489</a>         test.testReaderReadline(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1490" href="#L1490">1490</a> 
<a class="jxr_linenumber" name="L1491" href="#L1491">1491</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"changeit\nName\nCountry\nYes\n"</span>);
<a class="jxr_linenumber" name="L1492" href="#L1492">1492</a>         test.testStreamReadMany(<span class="jxr_string">"changeit\n"</span>);
<a class="jxr_linenumber" name="L1493" href="#L1493">1493</a>         test.testReaderReadline(<span class="jxr_string">"Name"</span>);
<a class="jxr_linenumber" name="L1494" href="#L1494">1494</a>         test.testReaderReadline(<span class="jxr_string">"Country"</span>);
<a class="jxr_linenumber" name="L1495" href="#L1495">1495</a>         test.testReaderReadline(<span class="jxr_string">"Yes"</span>);
<a class="jxr_linenumber" name="L1496" href="#L1496">1496</a>         test.testReaderReadline(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1497" href="#L1497">1497</a> 
<a class="jxr_linenumber" name="L1498" href="#L1498">1498</a>         test = <strong class="jxr_keyword">new</strong> Tester(<span class="jxr_string">"Me\nHere\n"</span>);
<a class="jxr_linenumber" name="L1499" href="#L1499">1499</a>         test.testReaderReadline2(<span class="jxr_string">"Me"</span>);
<a class="jxr_linenumber" name="L1500" href="#L1500">1500</a>         test.testReaderReadline2(<span class="jxr_string">"Here"</span>);
<a class="jxr_linenumber" name="L1501" href="#L1501">1501</a>     }
<a class="jxr_linenumber" name="L1502" href="#L1502">1502</a> }
</pre>
<hr/>
<div id="footer"></div>
</body>
</html>

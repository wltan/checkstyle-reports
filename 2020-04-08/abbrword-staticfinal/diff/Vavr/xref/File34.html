<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>BitMappedTrie xref</title>
<link type="text/css" rel="stylesheet" href="../../../stylesheet.css" />
</head>
<body>
<pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_comment">/*                        __    __  __  __    __  ___</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_comment"> *                       \  \  /  /    \  \  /  /  __/</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_comment"> *                        \  \/  /  /\  \  \/  /  /</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_comment"> *                         \____/__/  \__\____/__/.ɪᴏ</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_comment"> * ᶜᵒᵖʸʳᶦᵍʰᵗ ᵇʸ ᵛᵃᵛʳ ⁻ ˡᶦᶜᵉⁿˢᵉᵈ ᵘⁿᵈᵉʳ ᵗʰᵉ ᵃᵖᵃᶜʰᵉ ˡᶦᶜᵉⁿˢᵉ ᵛᵉʳˢᶦᵒⁿ ᵗʷᵒ ᵈᵒᵗ ᶻᵉʳᵒ</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <strong class="jxr_keyword">package</strong> io.vavr.collection;
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <strong class="jxr_keyword">import</strong> java.io.Serializable;
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <strong class="jxr_keyword">import</strong> java.util.NoSuchElementException;
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <strong class="jxr_keyword">import</strong> java.util.function.Function;
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <strong class="jxr_keyword">import</strong> java.util.function.Predicate;
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> java.util.function.Function.identity;
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> io.vavr.collection.ArrayType.obj;
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> io.vavr.collection.Collections.withSize;
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> io.vavr.collection.NodeModifier.COPY_NODE;
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> io.vavr.collection.NodeModifier.IDENTITY;
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  <em class="jxr_javadoccomment"> * A `bit-mapped trie` is a very wide and shallow tree (for integer indices the depth will be `≤6`).</em>
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <em class="jxr_javadoccomment"> * Each node has a maximum of `32` children (configurable).</em>
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  <em class="jxr_javadoccomment"> * Access to a given position is done by converting the index to a base 32 number and using each digit to descend down the tree.</em>
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <em class="jxr_javadoccomment"> * Modifying the tree is done similarly, but along the way the path is copied, returning a new root every time.</em>
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <em class="jxr_javadoccomment"> * `Append` inserts in the last leaf, or if the tree is full from the right, it adds another layer on top of it (the old root will be the first of the new one).</em>
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <em class="jxr_javadoccomment"> * `Prepend` is done similarly, but an offset is needed, because adding a new top node (where the current root would be the last node of the new root)</em>
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <em class="jxr_javadoccomment"> * shifts the indices by half of the current tree's full size. The `offset` shifts them back to the correct index.</em>
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <em class="jxr_javadoccomment"> * `Slice` is done by trimming the path from the root and discarding any `leading`/`trailing` values in effectively constant time (without memory leak, as in `Java`/`Clojure`).</em>
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <em class="jxr_javadoccomment"> * @author Pap Lőrinc</em>
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">class</strong> BitMappedTrie&lt;T&gt; <strong class="jxr_keyword">implements</strong> Serializable {
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  
<a class="jxr_linenumber" name="L34" href="#L34">34</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> BRANCHING_BASE = 5;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> BRANCHING_FACTOR = 1 &lt;&lt; BRANCHING_BASE;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> BRANCHING_MASK = -1 &gt;&gt;&gt; -BRANCHING_BASE;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  
<a class="jxr_linenumber" name="L38" href="#L38">38</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">int</strong> firstDigit(<strong class="jxr_keyword">int</strong> num, <strong class="jxr_keyword">int</strong> depthShift) { <strong class="jxr_keyword">return</strong> num &gt;&gt; depthShift; }
<a class="jxr_linenumber" name="L39" href="#L39">39</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">int</strong> digit(<strong class="jxr_keyword">int</strong> num, <strong class="jxr_keyword">int</strong> depthShift) { <strong class="jxr_keyword">return</strong> lastDigit(firstDigit(num, depthShift)); }
<a class="jxr_linenumber" name="L40" href="#L40">40</a>      <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">int</strong> lastDigit(<strong class="jxr_keyword">int</strong> num) { <strong class="jxr_keyword">return</strong> num &amp; BRANCHING_MASK; }
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  
<a class="jxr_linenumber" name="L42" href="#L42">42</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> serialVersionUID = 1L;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  
<a class="jxr_linenumber" name="L44" href="#L44">44</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> BitMappedTrie&lt;?&gt; EMPTY = <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(obj(), obj().empty(), 0, 0, 0);
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  
<a class="jxr_linenumber" name="L46" href="#L46">46</a>      @SuppressWarnings(<span class="jxr_string">"unchecked"</span>)
<a class="jxr_linenumber" name="L47" href="#L47">47</a>      <strong class="jxr_keyword">static</strong> &lt;T&gt; BitMappedTrie&lt;T&gt; empty() { <strong class="jxr_keyword">return</strong> (BitMappedTrie&lt;T&gt;) EMPTY; }
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  
<a class="jxr_linenumber" name="L49" href="#L49">49</a>      <strong class="jxr_keyword">final</strong> ArrayType&lt;T&gt; type;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> Object array;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> offset, length;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> depthShift;
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  
<a class="jxr_linenumber" name="L54" href="#L54">54</a>      <strong class="jxr_keyword">private</strong> BitMappedTrie(ArrayType&lt;T&gt; type, Object array, <strong class="jxr_keyword">int</strong> offset, <strong class="jxr_keyword">int</strong> length, <strong class="jxr_keyword">int</strong> depthShift) {
<a class="jxr_linenumber" name="L55" href="#L55">55</a>          <strong class="jxr_keyword">this</strong>.type = type;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>          <strong class="jxr_keyword">this</strong>.array = array;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>          <strong class="jxr_keyword">this</strong>.offset = offset;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>          <strong class="jxr_keyword">this</strong>.length = length;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>          <strong class="jxr_keyword">this</strong>.depthShift = depthShift;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>      }
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  
<a class="jxr_linenumber" name="L62" href="#L62">62</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">int</strong> treeSize(<strong class="jxr_keyword">int</strong> branchCount, <strong class="jxr_keyword">int</strong> depthShift) {
<a class="jxr_linenumber" name="L63" href="#L63">63</a>          <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> fullBranchSize = 1 &lt;&lt; depthShift;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>          <strong class="jxr_keyword">return</strong> branchCount * fullBranchSize;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>      }
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  
<a class="jxr_linenumber" name="L67" href="#L67">67</a>      <strong class="jxr_keyword">static</strong> &lt;T&gt; BitMappedTrie&lt;T&gt; ofAll(Object array) {
<a class="jxr_linenumber" name="L68" href="#L68">68</a>          <strong class="jxr_keyword">final</strong> ArrayType&lt;T&gt; type = ArrayType.of(array);
<a class="jxr_linenumber" name="L69" href="#L69">69</a>          <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> size = type.lengthOf(array);
<a class="jxr_linenumber" name="L70" href="#L70">70</a>          <strong class="jxr_keyword">return</strong> (size == 0) ? empty() : ofAll(array, type, size);
<a class="jxr_linenumber" name="L71" href="#L71">71</a>      }
<a class="jxr_linenumber" name="L72" href="#L72">72</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> &lt;T&gt; BitMappedTrie&lt;T&gt; ofAll(Object array, ArrayType&lt;T&gt; type, <strong class="jxr_keyword">int</strong> size) {
<a class="jxr_linenumber" name="L73" href="#L73">73</a>          <strong class="jxr_keyword">int</strong> shift = 0;
<a class="jxr_linenumber" name="L74" href="#L74">74</a>          <strong class="jxr_keyword">for</strong> (ArrayType&lt;T&gt; t = type; t.lengthOf(array) &gt; BRANCHING_FACTOR; shift += BRANCHING_BASE) {
<a class="jxr_linenumber" name="L75" href="#L75">75</a>              array = t.grouped(array, BRANCHING_FACTOR);
<a class="jxr_linenumber" name="L76" href="#L76">76</a>              t = obj();
<a class="jxr_linenumber" name="L77" href="#L77">77</a>          }
<a class="jxr_linenumber" name="L78" href="#L78">78</a>          <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(type, array, 0, size, shift);
<a class="jxr_linenumber" name="L79" href="#L79">79</a>      }
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  
<a class="jxr_linenumber" name="L81" href="#L81">81</a>      <strong class="jxr_keyword">private</strong> BitMappedTrie&lt;T&gt; boxed() { <strong class="jxr_keyword">return</strong> map(identity()); }
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  
<a class="jxr_linenumber" name="L83" href="#L83">83</a>      BitMappedTrie&lt;T&gt; prependAll(Iterable&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterable) {
<a class="jxr_linenumber" name="L84" href="#L84">84</a>          <strong class="jxr_keyword">final</strong> Collections.IterableWithSize&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iter = withSize(iterable);
<a class="jxr_linenumber" name="L85" href="#L85">85</a>          <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L86" href="#L86">86</a>              <strong class="jxr_keyword">return</strong> prepend(iter.reverseIterator(), iter.size());
<a class="jxr_linenumber" name="L87" href="#L87">87</a>          } <strong class="jxr_keyword">catch</strong> (ClassCastException ignored) {
<a class="jxr_linenumber" name="L88" href="#L88">88</a>              <strong class="jxr_keyword">return</strong> boxed().prepend(iter.reverseIterator(), iter.size());
<a class="jxr_linenumber" name="L89" href="#L89">89</a>          }
<a class="jxr_linenumber" name="L90" href="#L90">90</a>      }
<a class="jxr_linenumber" name="L91" href="#L91">91</a>      <strong class="jxr_keyword">private</strong> BitMappedTrie&lt;T&gt; prepend(java.util.Iterator&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterator, <strong class="jxr_keyword">int</strong> size) {
<a class="jxr_linenumber" name="L92" href="#L92">92</a>          BitMappedTrie&lt;T&gt; result = <strong class="jxr_keyword">this</strong>;
<a class="jxr_linenumber" name="L93" href="#L93">93</a>          <strong class="jxr_keyword">while</strong> (size &gt; 0) {
<a class="jxr_linenumber" name="L94" href="#L94">94</a>              Object array = result.array;
<a class="jxr_linenumber" name="L95" href="#L95">95</a>              <strong class="jxr_keyword">int</strong> shift = result.depthShift, offset = result.offset;
<a class="jxr_linenumber" name="L96" href="#L96">96</a>              <strong class="jxr_keyword">if</strong> (result.isFullLeft()) {
<a class="jxr_linenumber" name="L97" href="#L97">97</a>                  array = obj().copyUpdate(obj().empty(), BRANCHING_FACTOR - 1, array);
<a class="jxr_linenumber" name="L98" href="#L98">98</a>                  shift += BRANCHING_BASE;
<a class="jxr_linenumber" name="L99" href="#L99">99</a>                  offset = treeSize(BRANCHING_FACTOR - 1, shift);
<a class="jxr_linenumber" name="L100" href="#L100">100</a>             }
<a class="jxr_linenumber" name="L101" href="#L101">101</a> 
<a class="jxr_linenumber" name="L102" href="#L102">102</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> index = offset - 1;
<a class="jxr_linenumber" name="L103" href="#L103">103</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> delta = Math.min(size, lastDigit(index) + 1);
<a class="jxr_linenumber" name="L104" href="#L104">104</a>             size -= delta;
<a class="jxr_linenumber" name="L105" href="#L105">105</a> 
<a class="jxr_linenumber" name="L106" href="#L106">106</a>             array = result.modify(array, shift, index, COPY_NODE, prependToLeaf(iterator));
<a class="jxr_linenumber" name="L107" href="#L107">107</a>             result = <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(type, array, offset - delta, result.length + delta, shift);
<a class="jxr_linenumber" name="L108" href="#L108">108</a>         }
<a class="jxr_linenumber" name="L109" href="#L109">109</a>         <strong class="jxr_keyword">return</strong> result;
<a class="jxr_linenumber" name="L110" href="#L110">110</a>     }
<a class="jxr_linenumber" name="L111" href="#L111">111</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isFullLeft() { <strong class="jxr_keyword">return</strong> offset == 0; }
<a class="jxr_linenumber" name="L112" href="#L112">112</a>     <strong class="jxr_keyword">private</strong> NodeModifier prependToLeaf(java.util.Iterator&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterator) {
<a class="jxr_linenumber" name="L113" href="#L113">113</a>         <strong class="jxr_keyword">return</strong> (array, index) -&gt; {
<a class="jxr_linenumber" name="L114" href="#L114">114</a>             <strong class="jxr_keyword">final</strong> Object copy = type.copy(array, BRANCHING_FACTOR);
<a class="jxr_linenumber" name="L115" href="#L115">115</a>             <strong class="jxr_keyword">while</strong> (iterator.hasNext() &amp;&amp; index &gt;= 0) {
<a class="jxr_linenumber" name="L116" href="#L116">116</a>                 type.setAt(copy, index--, iterator.next());
<a class="jxr_linenumber" name="L117" href="#L117">117</a>             }
<a class="jxr_linenumber" name="L118" href="#L118">118</a>             <strong class="jxr_keyword">return</strong> copy;
<a class="jxr_linenumber" name="L119" href="#L119">119</a>         };
<a class="jxr_linenumber" name="L120" href="#L120">120</a>     }
<a class="jxr_linenumber" name="L121" href="#L121">121</a> 
<a class="jxr_linenumber" name="L122" href="#L122">122</a>     BitMappedTrie&lt;T&gt; appendAll(Iterable&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterable) {
<a class="jxr_linenumber" name="L123" href="#L123">123</a>         <strong class="jxr_keyword">final</strong> Collections.IterableWithSize&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iter = withSize(iterable);
<a class="jxr_linenumber" name="L124" href="#L124">124</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L125" href="#L125">125</a>             <strong class="jxr_keyword">return</strong> append(iter.iterator(), iter.size());
<a class="jxr_linenumber" name="L126" href="#L126">126</a>         } <strong class="jxr_keyword">catch</strong> (ClassCastException ignored) {
<a class="jxr_linenumber" name="L127" href="#L127">127</a>             <strong class="jxr_keyword">return</strong> boxed().append(iter.iterator(), iter.size());
<a class="jxr_linenumber" name="L128" href="#L128">128</a>         }
<a class="jxr_linenumber" name="L129" href="#L129">129</a>     }
<a class="jxr_linenumber" name="L130" href="#L130">130</a>     <strong class="jxr_keyword">private</strong> BitMappedTrie&lt;T&gt; append(java.util.Iterator&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterator, <strong class="jxr_keyword">int</strong> size) {
<a class="jxr_linenumber" name="L131" href="#L131">131</a>         BitMappedTrie&lt;T&gt; result = <strong class="jxr_keyword">this</strong>;
<a class="jxr_linenumber" name="L132" href="#L132">132</a>         <strong class="jxr_keyword">while</strong> (size &gt; 0) {
<a class="jxr_linenumber" name="L133" href="#L133">133</a>             Object array = result.array;
<a class="jxr_linenumber" name="L134" href="#L134">134</a>             <strong class="jxr_keyword">int</strong> shift = result.depthShift;
<a class="jxr_linenumber" name="L135" href="#L135">135</a>             <strong class="jxr_keyword">if</strong> (result.isFullRight()) {
<a class="jxr_linenumber" name="L136" href="#L136">136</a>                 array = obj().asArray(array);
<a class="jxr_linenumber" name="L137" href="#L137">137</a>                 shift += BRANCHING_BASE;
<a class="jxr_linenumber" name="L138" href="#L138">138</a>             }
<a class="jxr_linenumber" name="L139" href="#L139">139</a> 
<a class="jxr_linenumber" name="L140" href="#L140">140</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> index = offset + result.length;
<a class="jxr_linenumber" name="L141" href="#L141">141</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> leafSpace = lastDigit(index);
<a class="jxr_linenumber" name="L142" href="#L142">142</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> delta = Math.min(size, BRANCHING_FACTOR - leafSpace);
<a class="jxr_linenumber" name="L143" href="#L143">143</a>             size -= delta;
<a class="jxr_linenumber" name="L144" href="#L144">144</a> 
<a class="jxr_linenumber" name="L145" href="#L145">145</a>             array = result.modify(array, shift, index, COPY_NODE, appendToLeaf(iterator, leafSpace + delta));
<a class="jxr_linenumber" name="L146" href="#L146">146</a>             result = <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(type, array, offset, result.length + delta, shift);
<a class="jxr_linenumber" name="L147" href="#L147">147</a>         }
<a class="jxr_linenumber" name="L148" href="#L148">148</a>         <strong class="jxr_keyword">return</strong> result;
<a class="jxr_linenumber" name="L149" href="#L149">149</a> 
<a class="jxr_linenumber" name="L150" href="#L150">150</a>     }
<a class="jxr_linenumber" name="L151" href="#L151">151</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isFullRight() { <strong class="jxr_keyword">return</strong> (offset + length + 1) &gt; treeSize(BRANCHING_FACTOR, depthShift); }
<a class="jxr_linenumber" name="L152" href="#L152">152</a>     <strong class="jxr_keyword">private</strong> NodeModifier appendToLeaf(java.util.Iterator&lt;? <strong class="jxr_keyword">extends</strong> T&gt; iterator, <strong class="jxr_keyword">int</strong> leafSize) {
<a class="jxr_linenumber" name="L153" href="#L153">153</a>         <strong class="jxr_keyword">return</strong> (array, index) -&gt; {
<a class="jxr_linenumber" name="L154" href="#L154">154</a>             <strong class="jxr_keyword">final</strong> Object copy = type.copy(array, leafSize);
<a class="jxr_linenumber" name="L155" href="#L155">155</a>             <strong class="jxr_keyword">while</strong> (iterator.hasNext() &amp;&amp; index &lt; leafSize) {
<a class="jxr_linenumber" name="L156" href="#L156">156</a>                 type.setAt(copy, index++, iterator.next());
<a class="jxr_linenumber" name="L157" href="#L157">157</a>             }
<a class="jxr_linenumber" name="L158" href="#L158">158</a>             <strong class="jxr_keyword">return</strong> copy;
<a class="jxr_linenumber" name="L159" href="#L159">159</a>         };
<a class="jxr_linenumber" name="L160" href="#L160">160</a>     }
<a class="jxr_linenumber" name="L161" href="#L161">161</a> 
<a class="jxr_linenumber" name="L162" href="#L162">162</a>     BitMappedTrie&lt;T&gt; update(<strong class="jxr_keyword">int</strong> index, T element) {
<a class="jxr_linenumber" name="L163" href="#L163">163</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L164" href="#L164">164</a>             <strong class="jxr_keyword">final</strong> Object root = modify(array, depthShift, offset + index, COPY_NODE, updateLeafWith(type, element));
<a class="jxr_linenumber" name="L165" href="#L165">165</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(type, root, offset, length, depthShift);
<a class="jxr_linenumber" name="L166" href="#L166">166</a>         } <strong class="jxr_keyword">catch</strong> (ClassCastException ignored) {
<a class="jxr_linenumber" name="L167" href="#L167">167</a>             <strong class="jxr_keyword">return</strong> boxed().update(index, element);
<a class="jxr_linenumber" name="L168" href="#L168">168</a>         }
<a class="jxr_linenumber" name="L169" href="#L169">169</a>     }
<a class="jxr_linenumber" name="L170" href="#L170">170</a>     <strong class="jxr_keyword">private</strong> NodeModifier updateLeafWith(ArrayType&lt;T&gt; type, T element) { <strong class="jxr_keyword">return</strong> (a, i) -&gt; type.copyUpdate(a, i, element); }
<a class="jxr_linenumber" name="L171" href="#L171">171</a> 
<a class="jxr_linenumber" name="L172" href="#L172">172</a>     BitMappedTrie&lt;T&gt; drop(<strong class="jxr_keyword">int</strong> n) {
<a class="jxr_linenumber" name="L173" href="#L173">173</a>         <strong class="jxr_keyword">if</strong> (n &lt;= 0) {
<a class="jxr_linenumber" name="L174" href="#L174">174</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">this</strong>;
<a class="jxr_linenumber" name="L175" href="#L175">175</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (n &gt;= length) {
<a class="jxr_linenumber" name="L176" href="#L176">176</a>             <strong class="jxr_keyword">return</strong> empty();
<a class="jxr_linenumber" name="L177" href="#L177">177</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L178" href="#L178">178</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> index = offset + n;
<a class="jxr_linenumber" name="L179" href="#L179">179</a>             <strong class="jxr_keyword">final</strong> Object root = arePointingToSameLeaf(0, n)
<a class="jxr_linenumber" name="L180" href="#L180">180</a>                                 ? array
<a class="jxr_linenumber" name="L181" href="#L181">181</a>                                 : modify(array, depthShift, index, obj()::copyDrop, IDENTITY);
<a class="jxr_linenumber" name="L182" href="#L182">182</a>             <strong class="jxr_keyword">return</strong> collapsed(type, root, index, length - n, depthShift);
<a class="jxr_linenumber" name="L183" href="#L183">183</a>         }
<a class="jxr_linenumber" name="L184" href="#L184">184</a>     }
<a class="jxr_linenumber" name="L185" href="#L185">185</a> 
<a class="jxr_linenumber" name="L186" href="#L186">186</a>     BitMappedTrie&lt;T&gt; take(<strong class="jxr_keyword">int</strong> n) {
<a class="jxr_linenumber" name="L187" href="#L187">187</a>         <strong class="jxr_keyword">if</strong> (n &gt;= length) {
<a class="jxr_linenumber" name="L188" href="#L188">188</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">this</strong>;
<a class="jxr_linenumber" name="L189" href="#L189">189</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (n &lt;= 0) {
<a class="jxr_linenumber" name="L190" href="#L190">190</a>             <strong class="jxr_keyword">return</strong> empty();
<a class="jxr_linenumber" name="L191" href="#L191">191</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L192" href="#L192">192</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> index = n - 1;
<a class="jxr_linenumber" name="L193" href="#L193">193</a>             <strong class="jxr_keyword">final</strong> Object root = arePointingToSameLeaf(index, length - 1)
<a class="jxr_linenumber" name="L194" href="#L194">194</a>                                 ? array
<a class="jxr_linenumber" name="L195" href="#L195">195</a>                                 : modify(array, depthShift, offset + index, obj()::copyTake, IDENTITY);
<a class="jxr_linenumber" name="L196" href="#L196">196</a>             <strong class="jxr_keyword">return</strong> collapsed(type, root, offset, n, depthShift);
<a class="jxr_linenumber" name="L197" href="#L197">197</a>         }
<a class="jxr_linenumber" name="L198" href="#L198">198</a>     }
<a class="jxr_linenumber" name="L199" href="#L199">199</a> 
<a class="jxr_linenumber" name="L200" href="#L200">200</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> arePointingToSameLeaf(<strong class="jxr_keyword">int</strong> i, <strong class="jxr_keyword">int</strong> j) {
<a class="jxr_linenumber" name="L201" href="#L201">201</a>         <strong class="jxr_keyword">return</strong> firstDigit(offset + i, BRANCHING_BASE) == firstDigit(offset + j, BRANCHING_BASE);
<a class="jxr_linenumber" name="L202" href="#L202">202</a>     }
<a class="jxr_linenumber" name="L203" href="#L203">203</a> 
<a class="jxr_linenumber" name="L204" href="#L204">204</a>     <em class="jxr_comment">/* drop root node while it has a single element */</em>
<a class="jxr_linenumber" name="L205" href="#L205">205</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> &lt;T&gt; BitMappedTrie&lt;T&gt; collapsed(ArrayType&lt;T&gt; type, Object array, <strong class="jxr_keyword">int</strong> offset, <strong class="jxr_keyword">int</strong> length, <strong class="jxr_keyword">int</strong> shift) {
<a class="jxr_linenumber" name="L206" href="#L206">206</a>         <strong class="jxr_keyword">for</strong> (; shift &gt; 0; shift -= BRANCHING_BASE) {
<a class="jxr_linenumber" name="L207" href="#L207">207</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> skippedElements = obj().lengthOf(array) - 1;
<a class="jxr_linenumber" name="L208" href="#L208">208</a>             <strong class="jxr_keyword">if</strong> (skippedElements != digit(offset, shift)) {
<a class="jxr_linenumber" name="L209" href="#L209">209</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L210" href="#L210">210</a>             }
<a class="jxr_linenumber" name="L211" href="#L211">211</a>             array = obj().getAt(array, skippedElements);
<a class="jxr_linenumber" name="L212" href="#L212">212</a>             offset -= treeSize(skippedElements, shift);
<a class="jxr_linenumber" name="L213" href="#L213">213</a>         }
<a class="jxr_linenumber" name="L214" href="#L214">214</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">new</strong> BitMappedTrie&lt;&gt;(type, array, offset, length, shift);
<a class="jxr_linenumber" name="L215" href="#L215">215</a>     }
<a class="jxr_linenumber" name="L216" href="#L216">216</a> 
<a class="jxr_linenumber" name="L217" href="#L217">217</a>     <em class="jxr_comment">/* descend the tree from root to leaf, applying the given modifications along the way, returning the new root */</em>
<a class="jxr_linenumber" name="L218" href="#L218">218</a>     <strong class="jxr_keyword">private</strong> Object modify(Object root, <strong class="jxr_keyword">int</strong> depthShift, <strong class="jxr_keyword">int</strong> index, NodeModifier node, NodeModifier leaf) {
<a class="jxr_linenumber" name="L219" href="#L219">219</a>         <strong class="jxr_keyword">return</strong> (depthShift == 0)
<a class="jxr_linenumber" name="L220" href="#L220">220</a>                ? leaf.apply(root, index)
<a class="jxr_linenumber" name="L221" href="#L221">221</a>                : modifyNonLeaf(root, depthShift, index, node, leaf);
<a class="jxr_linenumber" name="L222" href="#L222">222</a>     }
<a class="jxr_linenumber" name="L223" href="#L223">223</a>     <strong class="jxr_keyword">private</strong> Object modifyNonLeaf(Object root, <strong class="jxr_keyword">int</strong> depthShift, <strong class="jxr_keyword">int</strong> index, NodeModifier node, NodeModifier leaf) {
<a class="jxr_linenumber" name="L224" href="#L224">224</a>         <strong class="jxr_keyword">int</strong> previousIndex = firstDigit(index, depthShift);
<a class="jxr_linenumber" name="L225" href="#L225">225</a>         root = node.apply(root, previousIndex);
<a class="jxr_linenumber" name="L226" href="#L226">226</a> 
<a class="jxr_linenumber" name="L227" href="#L227">227</a>         Object array = root;
<a class="jxr_linenumber" name="L228" href="#L228">228</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> shift = depthShift - BRANCHING_BASE; shift &gt;= BRANCHING_BASE; shift -= BRANCHING_BASE) {
<a class="jxr_linenumber" name="L229" href="#L229">229</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> prev = previousIndex;
<a class="jxr_linenumber" name="L230" href="#L230">230</a>             previousIndex = digit(index, shift);
<a class="jxr_linenumber" name="L231" href="#L231">231</a>             array = setNewNode(node, prev, array, previousIndex);
<a class="jxr_linenumber" name="L232" href="#L232">232</a>         }
<a class="jxr_linenumber" name="L233" href="#L233">233</a> 
<a class="jxr_linenumber" name="L234" href="#L234">234</a>         <strong class="jxr_keyword">final</strong> Object newLeaf = leaf.apply(obj().getAt(array, previousIndex), lastDigit(index));
<a class="jxr_linenumber" name="L235" href="#L235">235</a>         obj().setAt(array, previousIndex, newLeaf);
<a class="jxr_linenumber" name="L236" href="#L236">236</a>         <strong class="jxr_keyword">return</strong> root;
<a class="jxr_linenumber" name="L237" href="#L237">237</a>     }
<a class="jxr_linenumber" name="L238" href="#L238">238</a>     <strong class="jxr_keyword">private</strong> Object setNewNode(NodeModifier node, <strong class="jxr_keyword">int</strong> previousIndex, Object array, <strong class="jxr_keyword">int</strong> offset) {
<a class="jxr_linenumber" name="L239" href="#L239">239</a>         <strong class="jxr_keyword">final</strong> Object previous = obj().getAt(array, previousIndex);
<a class="jxr_linenumber" name="L240" href="#L240">240</a>         <strong class="jxr_keyword">final</strong> Object newNode = node.apply(previous, offset);
<a class="jxr_linenumber" name="L241" href="#L241">241</a>         obj().setAt(array, previousIndex, newNode);
<a class="jxr_linenumber" name="L242" href="#L242">242</a>         <strong class="jxr_keyword">return</strong> newNode;
<a class="jxr_linenumber" name="L243" href="#L243">243</a>     }
<a class="jxr_linenumber" name="L244" href="#L244">244</a> 
<a class="jxr_linenumber" name="L245" href="#L245">245</a>     T get(<strong class="jxr_keyword">int</strong> index) {
<a class="jxr_linenumber" name="L246" href="#L246">246</a>         <strong class="jxr_keyword">final</strong> Object leaf = getLeaf(index);
<a class="jxr_linenumber" name="L247" href="#L247">247</a>         <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> leafIndex = lastDigit(offset + index);
<a class="jxr_linenumber" name="L248" href="#L248">248</a>         <strong class="jxr_keyword">return</strong> type.getAt(leaf, leafIndex);
<a class="jxr_linenumber" name="L249" href="#L249">249</a>     }
<a class="jxr_linenumber" name="L250" href="#L250">250</a> 
<a class="jxr_linenumber" name="L251" href="#L251">251</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L252" href="#L252">252</a> <em class="jxr_javadoccomment">     * fetch the leaf, corresponding to the given index.</em>
<a class="jxr_linenumber" name="L253" href="#L253">253</a> <em class="jxr_javadoccomment">     * Node: the offset and length should be taken into consideration as there may be leading and trailing garbage.</em>
<a class="jxr_linenumber" name="L254" href="#L254">254</a> <em class="jxr_javadoccomment">     * Also, the returned array is mutable, but should not be mutated!</em>
<a class="jxr_linenumber" name="L255" href="#L255">255</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L256" href="#L256">256</a>     @SuppressWarnings(<span class="jxr_string">"WeakerAccess"</span>)
<a class="jxr_linenumber" name="L257" href="#L257">257</a>     Object getLeaf(<strong class="jxr_keyword">int</strong> index) {
<a class="jxr_linenumber" name="L258" href="#L258">258</a>         <strong class="jxr_keyword">if</strong> (depthShift == 0) {
<a class="jxr_linenumber" name="L259" href="#L259">259</a>             <strong class="jxr_keyword">return</strong> array;
<a class="jxr_linenumber" name="L260" href="#L260">260</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L261" href="#L261">261</a>             <strong class="jxr_keyword">return</strong> getLeafGeneral(index);
<a class="jxr_linenumber" name="L262" href="#L262">262</a>         }
<a class="jxr_linenumber" name="L263" href="#L263">263</a>     }
<a class="jxr_linenumber" name="L264" href="#L264">264</a>     <strong class="jxr_keyword">private</strong> Object getLeafGeneral(<strong class="jxr_keyword">int</strong> index) {
<a class="jxr_linenumber" name="L265" href="#L265">265</a>         index += offset;
<a class="jxr_linenumber" name="L266" href="#L266">266</a>         Object leaf = obj().getAt(array, firstDigit(index, depthShift));
<a class="jxr_linenumber" name="L267" href="#L267">267</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> shift = depthShift - BRANCHING_BASE; shift &gt; 0; shift -= BRANCHING_BASE) {
<a class="jxr_linenumber" name="L268" href="#L268">268</a>             leaf = obj().getAt(leaf, digit(index, shift));
<a class="jxr_linenumber" name="L269" href="#L269">269</a>         }
<a class="jxr_linenumber" name="L270" href="#L270">270</a>         <strong class="jxr_keyword">return</strong> leaf;
<a class="jxr_linenumber" name="L271" href="#L271">271</a>     }
<a class="jxr_linenumber" name="L272" href="#L272">272</a> 
<a class="jxr_linenumber" name="L273" href="#L273">273</a>     Iterator&lt;T&gt; iterator() {
<a class="jxr_linenumber" name="L274" href="#L274">274</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">new</strong> Iterator&lt;T&gt;() {
<a class="jxr_linenumber" name="L275" href="#L275">275</a>             <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> globalLength = BitMappedTrie.<strong class="jxr_keyword">this</strong>.length;
<a class="jxr_linenumber" name="L276" href="#L276">276</a>             <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> globalIndex = 0;
<a class="jxr_linenumber" name="L277" href="#L277">277</a> 
<a class="jxr_linenumber" name="L278" href="#L278">278</a>             <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> index = lastDigit(offset);
<a class="jxr_linenumber" name="L279" href="#L279">279</a>             <strong class="jxr_keyword">private</strong> Object leaf = getLeaf(globalIndex);
<a class="jxr_linenumber" name="L280" href="#L280">280</a>             <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> length = type.lengthOf(leaf);
<a class="jxr_linenumber" name="L281" href="#L281">281</a> 
<a class="jxr_linenumber" name="L282" href="#L282">282</a>             @Override
<a class="jxr_linenumber" name="L283" href="#L283">283</a>             <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> hasNext() { <strong class="jxr_keyword">return</strong> globalIndex &lt; globalLength; }
<a class="jxr_linenumber" name="L284" href="#L284">284</a> 
<a class="jxr_linenumber" name="L285" href="#L285">285</a>             @Override
<a class="jxr_linenumber" name="L286" href="#L286">286</a>             <strong class="jxr_keyword">public</strong> T next() {
<a class="jxr_linenumber" name="L287" href="#L287">287</a>                 <strong class="jxr_keyword">if</strong> (!hasNext()) {
<a class="jxr_linenumber" name="L288" href="#L288">288</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> NoSuchElementException(<span class="jxr_string">"next() on empty iterator"</span>);
<a class="jxr_linenumber" name="L289" href="#L289">289</a>                 }
<a class="jxr_linenumber" name="L290" href="#L290">290</a>                 
<a class="jxr_linenumber" name="L291" href="#L291">291</a>                 <strong class="jxr_keyword">if</strong> (index == length) { setCurrentArray(); }
<a class="jxr_linenumber" name="L292" href="#L292">292</a>                 <strong class="jxr_keyword">final</strong> T next = type.getAt(leaf, index);
<a class="jxr_linenumber" name="L293" href="#L293">293</a> 
<a class="jxr_linenumber" name="L294" href="#L294">294</a>                 index++;
<a class="jxr_linenumber" name="L295" href="#L295">295</a>                 globalIndex++;
<a class="jxr_linenumber" name="L296" href="#L296">296</a> 
<a class="jxr_linenumber" name="L297" href="#L297">297</a>                 <strong class="jxr_keyword">return</strong> next;
<a class="jxr_linenumber" name="L298" href="#L298">298</a>             }
<a class="jxr_linenumber" name="L299" href="#L299">299</a> 
<a class="jxr_linenumber" name="L300" href="#L300">300</a>             <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> setCurrentArray() {
<a class="jxr_linenumber" name="L301" href="#L301">301</a>                 index = 0;
<a class="jxr_linenumber" name="L302" href="#L302">302</a>                 leaf = getLeaf(globalIndex);
<a class="jxr_linenumber" name="L303" href="#L303">303</a>                 length = type.lengthOf(leaf);
<a class="jxr_linenumber" name="L304" href="#L304">304</a>             }
<a class="jxr_linenumber" name="L305" href="#L305">305</a>         };
<a class="jxr_linenumber" name="L306" href="#L306">306</a>     }
<a class="jxr_linenumber" name="L307" href="#L307">307</a> 
<a class="jxr_linenumber" name="L308" href="#L308">308</a>     @SuppressWarnings(<span class="jxr_string">"unchecked"</span>)
<a class="jxr_linenumber" name="L309" href="#L309">309</a>     &lt;T2&gt; <strong class="jxr_keyword">int</strong> visit(LeafVisitor&lt;T2&gt; visitor) {
<a class="jxr_linenumber" name="L310" href="#L310">310</a>         <strong class="jxr_keyword">int</strong> globalIndex = 0, start = lastDigit(offset);
<a class="jxr_linenumber" name="L311" href="#L311">311</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> index = 0; index &lt; length; ) {
<a class="jxr_linenumber" name="L312" href="#L312">312</a>             <strong class="jxr_keyword">final</strong> T2 leaf = (T2) getLeaf(index);
<a class="jxr_linenumber" name="L313" href="#L313">313</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> end = getMin(start, index, leaf);
<a class="jxr_linenumber" name="L314" href="#L314">314</a> 
<a class="jxr_linenumber" name="L315" href="#L315">315</a>             globalIndex = visitor.visit(globalIndex, leaf, start, end);
<a class="jxr_linenumber" name="L316" href="#L316">316</a> 
<a class="jxr_linenumber" name="L317" href="#L317">317</a>             index += end - start;
<a class="jxr_linenumber" name="L318" href="#L318">318</a>             start = 0;
<a class="jxr_linenumber" name="L319" href="#L319">319</a>         }
<a class="jxr_linenumber" name="L320" href="#L320">320</a>         <strong class="jxr_keyword">return</strong> globalIndex;
<a class="jxr_linenumber" name="L321" href="#L321">321</a>     }
<a class="jxr_linenumber" name="L322" href="#L322">322</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> getMin(<strong class="jxr_keyword">int</strong> start, <strong class="jxr_keyword">int</strong> index, Object leaf) { <strong class="jxr_keyword">return</strong> Math.min(type.lengthOf(leaf), start + length - index); }
<a class="jxr_linenumber" name="L323" href="#L323">323</a> 
<a class="jxr_linenumber" name="L324" href="#L324">324</a>     BitMappedTrie&lt;T&gt; filter(Predicate&lt;? <strong class="jxr_keyword">super</strong> T&gt; predicate) {
<a class="jxr_linenumber" name="L325" href="#L325">325</a>         <strong class="jxr_keyword">final</strong> Object results = type.newInstance(length());
<a class="jxr_linenumber" name="L326" href="#L326">326</a>         <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> length = <strong class="jxr_keyword">this</strong>.&lt;T&gt; visit((index, leaf, start, end) -&gt; filter(predicate, results, index, leaf, start, end));
<a class="jxr_linenumber" name="L327" href="#L327">327</a>         <strong class="jxr_keyword">return</strong> (<strong class="jxr_keyword">this</strong>.length == length)
<a class="jxr_linenumber" name="L328" href="#L328">328</a>                ? <strong class="jxr_keyword">this</strong>
<a class="jxr_linenumber" name="L329" href="#L329">329</a>                : BitMappedTrie.ofAll(type.copyRange(results, 0, length));
<a class="jxr_linenumber" name="L330" href="#L330">330</a>     }
<a class="jxr_linenumber" name="L331" href="#L331">331</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> filter(Predicate&lt;? <strong class="jxr_keyword">super</strong> T&gt; predicate, Object results, <strong class="jxr_keyword">int</strong> index, T leaf, <strong class="jxr_keyword">int</strong> start, <strong class="jxr_keyword">int</strong> end) {
<a class="jxr_linenumber" name="L332" href="#L332">332</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i = start; i &lt; end; i++) {
<a class="jxr_linenumber" name="L333" href="#L333">333</a>             <strong class="jxr_keyword">final</strong> T value = type.getAt(leaf, i);
<a class="jxr_linenumber" name="L334" href="#L334">334</a>             <strong class="jxr_keyword">if</strong> (predicate.test(value)) {
<a class="jxr_linenumber" name="L335" href="#L335">335</a>                 type.setAt(results, index++, value);
<a class="jxr_linenumber" name="L336" href="#L336">336</a>             }
<a class="jxr_linenumber" name="L337" href="#L337">337</a>         }
<a class="jxr_linenumber" name="L338" href="#L338">338</a>         <strong class="jxr_keyword">return</strong> index;
<a class="jxr_linenumber" name="L339" href="#L339">339</a>     }
<a class="jxr_linenumber" name="L340" href="#L340">340</a> 
<a class="jxr_linenumber" name="L341" href="#L341">341</a>     &lt;U&gt; BitMappedTrie&lt;U&gt; map(Function&lt;? <strong class="jxr_keyword">super</strong> T, ? <strong class="jxr_keyword">extends</strong> U&gt; mapper) {
<a class="jxr_linenumber" name="L342" href="#L342">342</a>         <strong class="jxr_keyword">final</strong> Object results = obj().newInstance(length);
<a class="jxr_linenumber" name="L343" href="#L343">343</a>         <strong class="jxr_keyword">this</strong>.&lt;T&gt; visit((index, leaf, start, end) -&gt; map(mapper, results, index, leaf, start, end));
<a class="jxr_linenumber" name="L344" href="#L344">344</a>         <strong class="jxr_keyword">return</strong> BitMappedTrie.ofAll(results);
<a class="jxr_linenumber" name="L345" href="#L345">345</a>     }
<a class="jxr_linenumber" name="L346" href="#L346">346</a>     <strong class="jxr_keyword">private</strong> &lt;U&gt; <strong class="jxr_keyword">int</strong> map(Function&lt;? <strong class="jxr_keyword">super</strong> T, ? <strong class="jxr_keyword">extends</strong> U&gt; mapper, Object results, <strong class="jxr_keyword">int</strong> index, T leaf, <strong class="jxr_keyword">int</strong> start, <strong class="jxr_keyword">int</strong> end) {
<a class="jxr_linenumber" name="L347" href="#L347">347</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i = start; i &lt; end; i++) {
<a class="jxr_linenumber" name="L348" href="#L348">348</a>             obj().setAt(results, index++, mapper.apply(type.getAt(leaf, i)));
<a class="jxr_linenumber" name="L349" href="#L349">349</a>         }
<a class="jxr_linenumber" name="L350" href="#L350">350</a>         <strong class="jxr_keyword">return</strong> index;
<a class="jxr_linenumber" name="L351" href="#L351">351</a>     }
<a class="jxr_linenumber" name="L352" href="#L352">352</a> 
<a class="jxr_linenumber" name="L353" href="#L353">353</a>     <strong class="jxr_keyword">int</strong> length() { <strong class="jxr_keyword">return</strong> length; }
<a class="jxr_linenumber" name="L354" href="#L354">354</a> }
<a class="jxr_linenumber" name="L355" href="#L355">355</a> 
<a class="jxr_linenumber" name="L356" href="#L356">356</a> @FunctionalInterface
<a class="jxr_linenumber" name="L357" href="#L357">357</a> <strong class="jxr_keyword">interface</strong> NodeModifier {
<a class="jxr_linenumber" name="L358" href="#L358">358</a>     Object apply(Object array, <strong class="jxr_keyword">int</strong> index);
<a class="jxr_linenumber" name="L359" href="#L359">359</a> 
<a class="jxr_linenumber" name="L360" href="#L360">360</a>     NodeModifier COPY_NODE = (o, i) -&gt; obj().copy(o, i + 1);
<a class="jxr_linenumber" name="L361" href="#L361">361</a>     NodeModifier IDENTITY = (o, i) -&gt; o;
<a class="jxr_linenumber" name="L362" href="#L362">362</a> }
<a class="jxr_linenumber" name="L363" href="#L363">363</a> 
<a class="jxr_linenumber" name="L364" href="#L364">364</a> @FunctionalInterface
<a class="jxr_linenumber" name="L365" href="#L365">365</a> <strong class="jxr_keyword">interface</strong> LeafVisitor&lt;T&gt; {
<a class="jxr_linenumber" name="L366" href="#L366">366</a>     <strong class="jxr_keyword">int</strong> visit(<strong class="jxr_keyword">int</strong> index, T leaf, <strong class="jxr_keyword">int</strong> start, <strong class="jxr_keyword">int</strong> end);
<a class="jxr_linenumber" name="L367" href="#L367">367</a> }
</pre>
<hr/>
<div id="footer"></div>
</body>
</html>
